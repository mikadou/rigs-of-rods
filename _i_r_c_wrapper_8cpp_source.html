<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Rigs of Rods: source/main/network/IRCWrapper.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="rorlogo.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Rigs of Rods
   
   </div>
   <div id="projectbrief">Soft-body Physics Simulation</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">source/main/network/IRCWrapper.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_i_r_c_wrapper_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">This source file is part of Rigs of Rods</span>
<a name="l00003"></a>00003 <span class="comment">Copyright 2005-2012 Pierre-Michel Ricordel</span>
<a name="l00004"></a>00004 <span class="comment">Copyright 2007-2012 Thomas Fischer</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">For more information, see http://www.rigsofrods.com/</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">Rigs of Rods is free software: you can redistribute it and/or modify</span>
<a name="l00009"></a>00009 <span class="comment">it under the terms of the GNU General Public License version 3, as</span>
<a name="l00010"></a>00010 <span class="comment">published by the Free Software Foundation.</span>
<a name="l00011"></a>00011 <span class="comment"></span>
<a name="l00012"></a>00012 <span class="comment">Rigs of Rods is distributed in the hope that it will be useful,</span>
<a name="l00013"></a>00013 <span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00014"></a>00014 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00015"></a>00015 <span class="comment">GNU General Public License for more details.</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">You should have received a copy of the GNU General Public License</span>
<a name="l00018"></a>00018 <span class="comment">along with Rigs of Rods.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00019"></a>00019 <span class="comment">*/</span>
<a name="l00020"></a>00020 <span class="comment">// created by Thomas Fischer thomas{AT}thomasfischer{DOT}biz, 7th of August 2009</span>
<a name="l00021"></a>00021 <span class="preprocessor">#ifdef USE_SOCKETW</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="_i_r_c_wrapper_8h.html">IRCWrapper.h</a>&quot;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="_error_utils_8h.html">ErrorUtils.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="_improved_config_file_8h.html">ImprovedConfigFile.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="rornet_8h.html">rornet.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="_ro_r_version_8h.html">RoRVersion.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="_settings_8h.html">Settings.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="_utils_8h.html">Utils.h</a>&quot;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#ifdef USE_CURL</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#define CURL_STATICLIB</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;curl/curl.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;curl/easy.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#endif //USE_CURL</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span>
<a name="l00039"></a>00039 <span class="comment">// some function forward declarations</span>
<a name="l00040"></a>00040 <span class="keywordtype">void</span> *s_ircthreadstart(<span class="keywordtype">void</span>* arg);
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="keyword">using namespace </span>Ogre;
<a name="l00043"></a>00043 <span class="comment">// some utils</span>
<a name="l00044"></a>00044 <span class="comment">// helps to fill our struct</span>
<a name="l00045"></a>00045 message_t constructMessage(<span class="keywordtype">int</span> type, <span class="keyword">const</span> <span class="keywordtype">char</span> *channel, <span class="keyword">const</span> <span class="keywordtype">char</span> *nick, <span class="keyword">const</span> <span class="keywordtype">char</span> *message, <span class="keyword">const</span> <span class="keywordtype">char</span> *arg = 0)
<a name="l00046"></a>00046 {
<a name="l00047"></a>00047     message_t t;
<a name="l00048"></a>00048     t.type    = type;
<a name="l00049"></a>00049     t.channel = String();
<a name="l00050"></a>00050     t.nick    = String();
<a name="l00051"></a>00051     t.message = String();
<a name="l00052"></a>00052     t.arg     = String();
<a name="l00053"></a>00053 
<a name="l00054"></a>00054     <span class="keywordflow">if</span> (channel) t.channel = String(channel);
<a name="l00055"></a>00055     <span class="keywordflow">if</span> (nick)    t.nick    = String(nick);
<a name="l00056"></a>00056     <span class="keywordflow">if</span> (message) t.message = String(message);
<a name="l00057"></a>00057     <span class="keywordflow">if</span> (arg)     t.arg     = String(arg);
<a name="l00058"></a>00058     <span class="keywordflow">return</span> t;
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="comment">// and the class implementation</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 IRCWrapper::IRCWrapper() : irc_session(0)
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065     <span class="comment">// set default values</span>
<a name="l00066"></a>00066     serverName     = <span class="stringliteral">&quot;irc.rigsofrods.org&quot;</span>;
<a name="l00067"></a>00067     serverPassword = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00068"></a>00068     nick           = <span class="stringliteral">&quot;foouser&quot;</span>;
<a name="l00069"></a>00069     userName       = nick;
<a name="l00070"></a>00070     realName       = nick;
<a name="l00071"></a>00071     channel        = <span class="stringliteral">&quot;#RigsOfRods&quot;</span>;
<a name="l00072"></a>00072     channelKey     = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00073"></a>00073     serverPort     = 6667; <span class="comment">// 6667 = default IRC port</span>
<a name="l00074"></a>00074     reJoin         = <span class="keyword">true</span>; <span class="comment">// rejoin if we got kicked</span>
<a name="l00075"></a>00075     reConnect      = <span class="keyword">true</span>; <span class="comment">// reconnect if we got disconnected</span>
<a name="l00076"></a>00076     retryCounter   = 0;    <span class="comment">// Counter that counts up connection retries</span>
<a name="l00077"></a>00077     wasConnected   = <span class="keyword">false</span>; <span class="comment">// already connected once</span>
<a name="l00078"></a>00078 }
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 IRCWrapper::~IRCWrapper()
<a name="l00081"></a>00081 {
<a name="l00082"></a>00082     <span class="keywordflow">if</span> (irc_session &amp;&amp; <a class="code" href="libircclient_8h.html#a90f826583118cb2e34135cb0e9b26cf8" title="Checks whether the session is connecting/connected to the IRC server.">irc_is_connected</a>(irc_session))
<a name="l00083"></a>00083     {
<a name="l00084"></a>00084         <a class="code" href="libircclient_8h.html#aa5f6dd73d3f0bdecb53f53362e253aab" title="Disconnects a connection to IRC server.">irc_disconnect</a>(irc_session);
<a name="l00085"></a>00085     }
<a name="l00086"></a>00086 }
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 <span class="keywordtype">void</span> IRCWrapper::initIRC()
<a name="l00089"></a>00089 {
<a name="l00090"></a>00090     <span class="comment">// authenticate before doing anything else</span>
<a name="l00091"></a>00091     pthread_create(&amp;ircthread, NULL, s_ircthreadstart, (<span class="keywordtype">void</span> *)<span class="keyword">this</span>);
<a name="l00092"></a>00092 }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="keywordtype">void</span> IRCWrapper::process()
<a name="l00095"></a>00095 {
<a name="l00096"></a>00096     <span class="keywordflow">if</span> (reConnect &amp;&amp; wasConnected)
<a name="l00097"></a>00097     {
<a name="l00098"></a>00098         <span class="comment">// check if we are still connected</span>
<a name="l00099"></a>00099         <span class="keywordflow">if</span> (irc_session &amp;&amp; !<a class="code" href="libircclient_8h.html#a90f826583118cb2e34135cb0e9b26cf8" title="Checks whether the session is connecting/connected to the IRC server.">irc_is_connected</a>(irc_session))
<a name="l00100"></a>00100         {
<a name="l00101"></a>00101             push(constructMessage(MT_StatusUpdate, 0, 0, <span class="stringliteral">&quot;Disconnected, reconnecting ...&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>));
<a name="l00102"></a>00102             <span class="comment">// disconnected, reconnect now</span>
<a name="l00103"></a>00103             <a class="code" href="libircclient_8h.html#aa5f6dd73d3f0bdecb53f53362e253aab" title="Disconnects a connection to IRC server.">irc_disconnect</a>(irc_session); <span class="comment">// be sure to let the old thread end ...</span>
<a name="l00104"></a>00104 
<a name="l00105"></a>00105             initIRC();
<a name="l00106"></a>00106         }
<a name="l00107"></a>00107     }
<a name="l00108"></a>00108     std::vector&lt;message_t&gt; messages;
<a name="l00109"></a>00109     <span class="keywordtype">int</span> num = pull(messages);
<a name="l00110"></a>00110     <span class="keywordflow">if</span> (num == 0)
<a name="l00111"></a>00111         <span class="keywordflow">return</span>;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <span class="comment">// there is something, lets investigate</span>
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     std::vector&lt;message_t&gt;::iterator it;
<a name="l00116"></a>00116     <span class="keywordflow">for</span> (it = messages.begin(); it != messages.end(); it++)
<a name="l00117"></a>00117     {
<a name="l00118"></a>00118         processIRCEvent(*it);
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="keywordtype">int</span> IRCWrapper::sendMessage(String msg, String channelOrNick)
<a name="l00123"></a>00123 {
<a name="l00124"></a>00124     <span class="keywordflow">if</span> (!irc_session) <span class="keywordflow">return</span> 1;
<a name="l00125"></a>00125     <span class="keywordflow">if</span> (channelOrNick.empty())
<a name="l00126"></a>00126         channelOrNick = channel;
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     <span class="keywordflow">return</span> <a class="code" href="libircclient_8h.html#a8c2ec03f1a9ce7c739e11b64fd088ae5" title="Sends the message to the nick or to the channel.">irc_cmd_msg</a>(irc_session, channelOrNick.c_str(), msg.c_str());
<a name="l00129"></a>00129 }
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 <span class="keywordtype">int</span> IRCWrapper::sendMeMessage(String msg, String channelOrNick)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133     <span class="keywordflow">if</span> (!irc_session) <span class="keywordflow">return</span> 1;
<a name="l00134"></a>00134     <span class="keywordflow">if</span> (channelOrNick.empty())
<a name="l00135"></a>00135         channelOrNick = channel;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     <span class="keywordflow">return</span> <a class="code" href="libircclient_8h.html#a09c7e471bf4062b57df10d31ee275fc5" title="Sends the /me (CTCP ACTION) message to the nick or to the channel.">irc_cmd_me</a>(irc_session, channelOrNick.c_str(), msg.c_str());
<a name="l00138"></a>00138 }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 <span class="keywordtype">int</span> IRCWrapper::changeNick(String newNick)
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142     <span class="keywordflow">if</span> (!irc_session) <span class="keywordflow">return</span> 1;
<a name="l00143"></a>00143     <span class="keywordflow">return</span> <a class="code" href="libircclient_8h.html#a19ae1ad61caf031e5c2dc950e24b7370" title="Changes your nick.">irc_cmd_nick</a>(irc_session, newNick.c_str());
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="keywordtype">int</span> IRCWrapper::joinChannel(String channel, String channelKeyStr)
<a name="l00147"></a>00147 {
<a name="l00148"></a>00148     <span class="keywordflow">if</span> (!irc_session) <span class="keywordflow">return</span> 1;
<a name="l00149"></a>00149     <span class="keyword">const</span> <span class="keywordtype">char</span> *channelKey = channelKeyStr.c_str();
<a name="l00150"></a>00150     <span class="keywordflow">if</span> (channelKeyStr.empty()) channelKey = 0;
<a name="l00151"></a>00151     <span class="keywordflow">return</span> <a class="code" href="libircclient_8h.html#a4960c546c2a077e8fb01fc7aa5ae7add" title="Joins the new IRC channel.">irc_cmd_join</a> (irc_session, channel.c_str(), channelKey);
<a name="l00152"></a>00152 }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 <span class="keywordtype">int</span> IRCWrapper::leaveChannel(String channel)
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156     <span class="keywordflow">if</span> (!irc_session) <span class="keywordflow">return</span> 1;
<a name="l00157"></a>00157     <span class="keywordflow">return</span> <a class="code" href="libircclient_8h.html#adb50b9a3a78693266fb0a257b997831b" title="Leaves the IRC channel.">irc_cmd_part</a> (irc_session, channel.c_str());
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="keywordtype">int</span> IRCWrapper::quit(String reason)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162     <span class="keywordflow">if</span> (!irc_session) <span class="keywordflow">return</span> 1;
<a name="l00163"></a>00163     <span class="keywordflow">return</span> <a class="code" href="libircclient_8h.html#aa89bd6efb6dacf53f25ca5518a5aa4ee" title="Sends QUIT command to the IRC server.">irc_cmd_quit</a> (irc_session, reason.c_str());
<a name="l00164"></a>00164 }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 String IRCWrapper::getLastErrorMessage()
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168     <span class="keywordflow">if</span> (!irc_session) <span class="keywordflow">return</span> <span class="stringliteral">&quot;not connected&quot;</span>;
<a name="l00169"></a>00169     <span class="keywordflow">return</span> String(<a class="code" href="errors_8c_09_09.html#afdc70ca04626818d2fd9a55da0b90e5f" title="Returns the text error message associated with this error code.">irc_strerror</a>(<a class="code" href="errors_8c_09_09.html#a3a18336093ee74751244d996bc32247d" title="Returns the last error code.">irc_errno</a>(irc_session)));
<a name="l00170"></a>00170 }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 <span class="preprocessor">#ifdef USE_CURL</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span><span class="keyword">struct </span><a class="code" href="structcurl_memory_struct.html">curlMemoryStruct</a> {
<a name="l00175"></a>00175     <span class="keywordtype">char</span> *<a class="code" href="structcurl_memory_struct.html#a087fa3e538f0241ab14b505bf6589fdb">memory</a>;
<a name="l00176"></a>00176     <span class="keywordtype">size_t</span> <a class="code" href="structcurl_memory_struct.html#aa008dca9064cc1ee751228002a6622b9">size</a>;
<a name="l00177"></a>00177 };
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 <span class="comment">//hacky hack to fill memory with data for curl</span>
<a name="l00180"></a>00180 <span class="comment">// from: http://curl.haxx.se/libcurl/c/getinmemory.html</span>
<a name="l00181"></a>00181 <span class="keyword">static</span> <span class="keywordtype">size_t</span> curlWriteMemoryCallback2(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> nmemb, <span class="keywordtype">void</span> *data)
<a name="l00182"></a>00182 {
<a name="l00183"></a>00183     <span class="keywordtype">size_t</span> realsize = size * nmemb;
<a name="l00184"></a>00184     <span class="keyword">struct </span><a class="code" href="structcurl_memory_struct.html">curlMemoryStruct</a> *mem = (<span class="keyword">struct </span><a class="code" href="structcurl_memory_struct.html">curlMemoryStruct</a> *)data;
<a name="l00185"></a>00185     <span class="keywordtype">char</span>* new_mem;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187     new_mem = (<span class="keywordtype">char</span> *)realloc(mem-&gt;<a class="code" href="structcurl_memory_struct.html#a087fa3e538f0241ab14b505bf6589fdb">memory</a>, mem-&gt;<a class="code" href="structcurl_memory_struct.html#aa008dca9064cc1ee751228002a6622b9">size</a> + realsize + 1);
<a name="l00188"></a>00188     <span class="keywordflow">if</span> (new_mem == NULL) {
<a name="l00189"></a>00189         free(mem-&gt;<a class="code" href="structcurl_memory_struct.html#a087fa3e538f0241ab14b505bf6589fdb">memory</a>);
<a name="l00190"></a>00190         printf(<span class="stringliteral">&quot;Error (re)allocating memory\n&quot;</span>);
<a name="l00191"></a>00191         <a class="code" href="namespace_profiler.html#af79bb59414ef3ba134213bb6f2f2d292">exit</a>(EXIT_FAILURE);
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193     mem-&gt;<a class="code" href="structcurl_memory_struct.html#a087fa3e538f0241ab14b505bf6589fdb">memory</a> = new_mem;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     memcpy(&amp;(mem-&gt;<a class="code" href="structcurl_memory_struct.html#a087fa3e538f0241ab14b505bf6589fdb">memory</a>[mem-&gt;<a class="code" href="structcurl_memory_struct.html#aa008dca9064cc1ee751228002a6622b9">size</a>]), ptr, realsize);
<a name="l00196"></a>00196     mem-&gt;<a class="code" href="structcurl_memory_struct.html#aa008dca9064cc1ee751228002a6622b9">size</a> += realsize;
<a name="l00197"></a>00197     mem-&gt;<a class="code" href="structcurl_memory_struct.html#a087fa3e538f0241ab14b505bf6589fdb">memory</a>[mem-&gt;<a class="code" href="structcurl_memory_struct.html#aa008dca9064cc1ee751228002a6622b9">size</a>] = 0;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     <span class="keywordflow">return</span> realsize;
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 <span class="preprocessor">#endif //USE_CURL</span>
<a name="l00202"></a>00202 <span class="preprocessor"></span>
<a name="l00203"></a>00203 <span class="keywordtype">int</span> IRCWrapper::authenticate()
<a name="l00204"></a>00204 {
<a name="l00205"></a>00205 <span class="preprocessor">#ifdef USE_CURL</span>
<a name="l00206"></a>00206 <span class="preprocessor"></span>    <span class="keyword">struct </span><a class="code" href="structcurl_memory_struct.html">curlMemoryStruct</a> chunk;
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     chunk.<a class="code" href="structcurl_memory_struct.html#a087fa3e538f0241ab14b505bf6589fdb">memory</a> = (<span class="keywordtype">char</span> *)malloc(1);  <span class="comment">/* will be grown as needed by the realloc above */</span>
<a name="l00209"></a>00209     chunk.size = 0;    <span class="comment">/* no data at this point */</span>
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="comment">// construct post fields</span>
<a name="l00212"></a>00212     <span class="keyword">struct </span>curl_httppost *formpost=NULL;
<a name="l00213"></a>00213     <span class="keyword">struct </span>curl_httppost *lastptr=NULL;
<a name="l00214"></a>00214     curl_global_init(CURL_GLOBAL_ALL);
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="comment">// add some hard coded values</span>
<a name="l00217"></a>00217     curl_formadd(&amp;formpost, &amp;lastptr, CURLFORM_COPYNAME, <span class="stringliteral">&quot;User_NickName&quot;</span>, CURLFORM_COPYCONTENTS, <a class="code" href="_settings_8h.html#a59d79e9512ab19f4eb8a322f1e32dc11">SSETTING</a>(<span class="stringliteral">&quot;Nickname&quot;</span>, <span class="stringliteral">&quot;Anonymous&quot;</span>).c_str(), CURLFORM_END);
<a name="l00218"></a>00218     curl_formadd(&amp;formpost, &amp;lastptr, CURLFORM_COPYNAME, <span class="stringliteral">&quot;User_Language&quot;</span>, CURLFORM_COPYCONTENTS, <a class="code" href="_settings_8h.html#a59d79e9512ab19f4eb8a322f1e32dc11">SSETTING</a>(<span class="stringliteral">&quot;Language&quot;</span>, <span class="stringliteral">&quot;English&quot;</span>).c_str(), CURLFORM_END);
<a name="l00219"></a>00219     curl_formadd(&amp;formpost, &amp;lastptr, CURLFORM_COPYNAME, <span class="stringliteral">&quot;User_Token&quot;</span>, CURLFORM_COPYCONTENTS, <a class="code" href="_settings_8h.html#a59d79e9512ab19f4eb8a322f1e32dc11">SSETTING</a>(<span class="stringliteral">&quot;User Token Hash&quot;</span>, <span class="stringliteral">&quot;-&quot;</span>).c_str(), CURLFORM_END);
<a name="l00220"></a>00220     curl_formadd(&amp;formpost, &amp;lastptr, CURLFORM_COPYNAME, <span class="stringliteral">&quot;RoR_VersionString&quot;</span>, CURLFORM_COPYCONTENTS, <a class="code" href="_ro_r_version_8h.html#a69a4d74161655a3024e47ad8c70ac848">ROR_VERSION_STRING</a>, CURLFORM_END);
<a name="l00221"></a>00221     curl_formadd(&amp;formpost, &amp;lastptr, CURLFORM_COPYNAME, <span class="stringliteral">&quot;RoR_ProtocolVersion&quot;</span>, CURLFORM_COPYCONTENTS, <a class="code" href="rornet_8h.html#abee9681e15dfd9c0e955dcc2a24c93dc" title="the protocol version information">RORNET_VERSION</a>, CURLFORM_END);
<a name="l00222"></a>00222     curl_formadd(&amp;formpost, &amp;lastptr, CURLFORM_COPYNAME, <span class="stringliteral">&quot;RoR_BinaryHash&quot;</span>, CURLFORM_COPYCONTENTS, <a class="code" href="_settings_8h.html#a59d79e9512ab19f4eb8a322f1e32dc11">SSETTING</a>(<span class="stringliteral">&quot;BinaryHash&quot;</span>, <span class="stringliteral">&quot;-&quot;</span>).c_str(), CURLFORM_END);
<a name="l00223"></a>00223     curl_formadd(&amp;formpost, &amp;lastptr, CURLFORM_COPYNAME, <span class="stringliteral">&quot;RoR_GUID&quot;</span>, CURLFORM_COPYCONTENTS, <a class="code" href="_settings_8h.html#a59d79e9512ab19f4eb8a322f1e32dc11">SSETTING</a>(<span class="stringliteral">&quot;GUID&quot;</span>, <span class="stringliteral">&quot;-&quot;</span>).c_str(), CURLFORM_END);
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     CURLcode res;
<a name="l00227"></a>00227     CURL *curl = curl_easy_init();
<a name="l00228"></a>00228     <span class="keywordflow">if</span> (!curl)
<a name="l00229"></a>00229     {
<a name="l00230"></a>00230         push(constructMessage(MT_ErrorAuth, 0, 0, <span class="stringliteral">&quot;Error: failed to init CURL&quot;</span>));
<a name="l00231"></a>00231         <span class="keywordflow">return</span> 1;
<a name="l00232"></a>00232     }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     <span class="keywordtype">char</span> *curl_err_str[CURL_ERROR_SIZE];
<a name="l00235"></a>00235     memset(curl_err_str, 0, CURL_ERROR_SIZE);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     String url = <span class="stringliteral">&quot;http://&quot;</span> + String(<a class="code" href="rornet_8h.html#a25f6f42fe5abd553c6aa818bbe952633" title="the web API URL">REPO_SERVER</a>) + <span class="stringliteral">&quot;/auth_lobby/&quot;</span>;
<a name="l00238"></a>00238     curl_easy_setopt(curl, CURLOPT_URL,              url.c_str());
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     <span class="comment">/* send all data to this function  */</span>
<a name="l00241"></a>00241     curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, curlWriteMemoryCallback2);
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <span class="comment">/* we pass our &#39;chunk&#39; struct to the callback function */</span>
<a name="l00244"></a>00244     curl_easy_setopt(curl, CURLOPT_WRITEDATA, (<span class="keywordtype">void</span> *)&amp;chunk);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <span class="comment">// set post options</span>
<a name="l00247"></a>00247     curl_easy_setopt(curl, CURLOPT_HTTPPOST, formpost);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <span class="comment">// logging stuff</span>
<a name="l00250"></a>00250     <span class="comment">//curl_easy_setopt(curl, CURLOPT_STDERR,           LogManager::getsin InstallerLog::getSingleton()-&gt;getLogFilePtr());</span>
<a name="l00251"></a>00251     curl_easy_setopt(curl, CURLOPT_ERRORBUFFER,      curl_err_str[0]);
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="comment">// http related settings</span>
<a name="l00254"></a>00254     curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION,   1); <span class="comment">// follow redirects</span>
<a name="l00255"></a>00255     curl_easy_setopt(curl, CURLOPT_AUTOREFERER,      1); <span class="comment">// set the Referrer: field in requests where it follows a Location: redirect.</span>
<a name="l00256"></a>00256     curl_easy_setopt(curl, CURLOPT_MAXREDIRS,        20);
<a name="l00257"></a>00257     curl_easy_setopt(curl, CURLOPT_USERAGENT,        <span class="stringliteral">&quot;RoR&quot;</span>);
<a name="l00258"></a>00258     curl_easy_setopt(curl, CURLOPT_FILETIME,         1);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     <span class="comment">// TO BE DONE: ADD SSL</span>
<a name="l00261"></a>00261     <span class="comment">// see: http://curl.haxx.se/libcurl/c/simplessl.html</span>
<a name="l00262"></a>00262     <span class="comment">// curl_easy_setopt(curl,CURLOPT_SSL_VERIFYPEER,1L);</span>
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     res = curl_easy_perform(curl);
<a name="l00265"></a>00265     curl_easy_cleanup(curl);
<a name="l00266"></a>00266 
<a name="l00267"></a>00267     <span class="comment">//printf(&quot;%lu bytes retrieved\n&quot;, (long)chunk.size);</span>
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     String result;
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     curl_formfree(formpost);
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     <span class="keywordflow">if</span> (chunk.memory)
<a name="l00274"></a>00274     {
<a name="l00275"></a>00275         <span class="comment">// convert memory into String now</span>
<a name="l00276"></a>00276         result = String(chunk.memory);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="comment">// then free</span>
<a name="l00279"></a>00279         free(chunk.memory);
<a name="l00280"></a>00280     }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="comment">/* we&#39;re done with libcurl, so clean it up */</span>
<a name="l00283"></a>00283     curl_global_cleanup();
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     <span class="keywordflow">if</span> (res != CURLE_OK)
<a name="l00286"></a>00286     {
<a name="l00287"></a>00287         <span class="keyword">const</span> <span class="keywordtype">char</span> *errstr = curl_easy_strerror(res);
<a name="l00288"></a>00288         push(constructMessage(MT_ErrorAuth, 0, 0, errstr));
<a name="l00289"></a>00289         <span class="keywordflow">return</span> 1;
<a name="l00290"></a>00290     }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     <span class="keywordflow">return</span> processAuthenticationResults(result);
<a name="l00293"></a>00293 <span class="preprocessor">#else</span>
<a name="l00294"></a>00294 <span class="preprocessor"></span>    push(constructMessage(MT_ErrorAuth, 0, 0, <span class="stringliteral">&quot;you have not compiled RoR with CURL support, thus authentication and the lobby are not available to you.&quot;</span>));
<a name="l00295"></a>00295     <span class="keywordflow">return</span> 1;
<a name="l00296"></a>00296 <span class="preprocessor">#endif //USE_CURL</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span>}
<a name="l00298"></a>00298 
<a name="l00299"></a>00299 <span class="keywordtype">int</span> IRCWrapper::processAuthenticationResults(String &amp;results)
<a name="l00300"></a>00300 {
<a name="l00301"></a>00301     <a class="code" href="class_ogre_1_1_improved_config_file.html">ImprovedConfigFile</a> cfg;
<a name="l00302"></a>00302     cfg.<a class="code" href="class_ogre_1_1_improved_config_file.html#a57e74b2661b9a10057c66830dd9652ad">loadFromString</a>(results, <span class="stringliteral">&quot;=&quot;</span>, <span class="keyword">true</span>);
<a name="l00303"></a>00303 
<a name="l00304"></a>00304     <span class="comment">// TODO: improve the checks if the config is valid or not ...</span>
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="comment">// fatal error?</span>
<a name="l00307"></a>00307     <span class="keywordflow">if</span> (cfg.<a class="code" href="class_ogre_1_1_improved_config_file.html#ae1f7f7fbf18b6f3f69442c2dfb510e8a">hasSetting</a>(<span class="stringliteral">&quot;fatalError&quot;</span>))
<a name="l00308"></a>00308     {
<a name="l00309"></a>00309         <a class="code" href="struct_error_utils.html#a5877046712b57723ec40772afd980378">ErrorUtils::ShowOgreWebError</a>(cfg.getSetting(<span class="stringliteral">&quot;fatalErrorTitle&quot;</span>), cfg.getSetting(<span class="stringliteral">&quot;fatalError&quot;</span>), cfg.getSetting(<span class="stringliteral">&quot;fatalErrorURL&quot;</span>));
<a name="l00310"></a>00310         <span class="keywordflow">return</span> 1;
<a name="l00311"></a>00311     }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="comment">// non-fatal error?</span>
<a name="l00314"></a>00314     <span class="keywordflow">if</span> (cfg.<a class="code" href="class_ogre_1_1_improved_config_file.html#ae1f7f7fbf18b6f3f69442c2dfb510e8a">hasSetting</a>(<span class="stringliteral">&quot;error&quot;</span>))
<a name="l00315"></a>00315     {
<a name="l00316"></a>00316         push(constructMessage(MT_ErrorAuth, 0, 0, cfg.getSetting(<span class="stringliteral">&quot;error&quot;</span>).c_str()));
<a name="l00317"></a>00317         <span class="keywordflow">return</span> 1;
<a name="l00318"></a>00318     }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320     <span class="keywordflow">if</span> (!cfg.<a class="code" href="class_ogre_1_1_improved_config_file.html#ae1f7f7fbf18b6f3f69442c2dfb510e8a">hasSetting</a>(<span class="stringliteral">&quot;serverName&quot;</span>) || !cfg.<a class="code" href="class_ogre_1_1_improved_config_file.html#ae1f7f7fbf18b6f3f69442c2dfb510e8a">hasSetting</a>(<span class="stringliteral">&quot;serverPort&quot;</span>))
<a name="l00321"></a>00321         <span class="keywordflow">return</span> 1;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323     serverName     = cfg.getSetting(<span class="stringliteral">&quot;serverName&quot;</span>);
<a name="l00324"></a>00324     serverPort     = cfg.<a class="code" href="class_ogre_1_1_improved_config_file.html#a7f110ad9b4ccb57322ceed5c8dc1d956">getSettingInt</a>(<span class="stringliteral">&quot;serverPort&quot;</span>);
<a name="l00325"></a>00325     serverPassword = cfg.getSetting(<span class="stringliteral">&quot;serverPassword&quot;</span>);
<a name="l00326"></a>00326     nick           = cfg.getSetting(<span class="stringliteral">&quot;nick&quot;</span>);
<a name="l00327"></a>00327     userName       = cfg.getSetting(<span class="stringliteral">&quot;userName&quot;</span>);
<a name="l00328"></a>00328     realName       = cfg.getSetting(<span class="stringliteral">&quot;realName&quot;</span>);
<a name="l00329"></a>00329     channel        = cfg.getSetting(<span class="stringliteral">&quot;channel&quot;</span>);
<a name="l00330"></a>00330     reJoin         = cfg.<a class="code" href="class_ogre_1_1_improved_config_file.html#a363a3f31b43d883a6096ded72c7a3656">getSettingBool</a>(<span class="stringliteral">&quot;reJoin&quot;</span>);
<a name="l00331"></a>00331     reConnect      = cfg.<a class="code" href="class_ogre_1_1_improved_config_file.html#a363a3f31b43d883a6096ded72c7a3656">getSettingBool</a>(<span class="stringliteral">&quot;reConnect&quot;</span>);
<a name="l00332"></a>00332     
<a name="l00333"></a>00333     <span class="comment">// TODO:</span>
<a name="l00334"></a>00334     <span class="comment">//userAuth = cfg.getSetting(&quot;userAuth&quot;);</span>
<a name="l00335"></a>00335     <span class="comment">//userGroups = cfg.getSetting(&quot;userGroups&quot;);</span>
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <span class="keywordflow">return</span> 0;
<a name="l00338"></a>00338 }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 <span class="comment">// C from libIRCClient BELOW</span>
<a name="l00341"></a>00341 
<a name="l00342"></a>00342 <span class="comment">// detects if we are meant</span>
<a name="l00343"></a>00343 <span class="keywordtype">bool</span> isSelf(IRCWrapper * ctx, <span class="keyword">const</span> <span class="keywordtype">char</span> *origin)
<a name="l00344"></a>00344 {
<a name="l00345"></a>00345     <span class="keywordflow">if</span> (!origin) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347     <span class="comment">// we store the nickname without the host information, so cut off the host to find out if its us</span>
<a name="l00348"></a>00348     String org = String(origin);
<a name="l00349"></a>00349     <span class="keywordtype">size_t</span> s = org.find(<span class="stringliteral">&quot;!&quot;</span>);
<a name="l00350"></a>00350     <span class="keywordflow">if</span> (s != org.npos)
<a name="l00351"></a>00351     {
<a name="l00352"></a>00352         org = org.substr(0, s);
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     <span class="keywordflow">return</span> (org == ctx-&gt;nick);
<a name="l00356"></a>00356 }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 <span class="keywordtype">void</span> addlog (<span class="keyword">const</span> <span class="keywordtype">char</span> * fmt, ...)
<a name="l00359"></a>00359 {
<a name="l00360"></a>00360     <span class="keywordtype">char</span> buf[1024];
<a name="l00361"></a>00361     va_list va_alist;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     va_start (va_alist, fmt);
<a name="l00364"></a>00364 <span class="preprocessor">#if defined (_WIN32)</span>
<a name="l00365"></a>00365 <span class="preprocessor"></span>    _vsnprintf (buf, <span class="keyword">sizeof</span>(buf), fmt, va_alist);
<a name="l00366"></a>00366 <span class="preprocessor">#else</span>
<a name="l00367"></a>00367 <span class="preprocessor"></span>    vsnprintf (buf, <span class="keyword">sizeof</span>(buf), fmt, va_alist);
<a name="l00368"></a>00368 <span class="preprocessor">#endif // _WIN32</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span>    va_end (va_alist);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371     <a class="code" href="_ro_r_prerequisites_8h.html#af855c94dc540e943632089ce7496faac">LOG</a>(<span class="stringliteral">&quot;IRC| &quot;</span> + String(buf));
<a name="l00372"></a>00372 }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 <span class="keywordtype">void</span> dump_event (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00375"></a>00375 {
<a name="l00376"></a>00376     <span class="keywordtype">char</span> buf[512] = {};
<a name="l00377"></a>00377     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cnt;
<a name="l00378"></a>00378 
<a name="l00379"></a>00379     buf[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     <span class="keywordflow">for</span> ( cnt = 0; cnt &lt; count; cnt++ )
<a name="l00382"></a>00382     {
<a name="l00383"></a>00383         <span class="keywordflow">if</span> ( cnt )
<a name="l00384"></a>00384             strcat (buf, <span class="stringliteral">&quot;|&quot;</span>);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386         strcat (buf, params[cnt]);
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     addlog (<span class="stringliteral">&quot;Event \&quot;%s\&quot;, origin: \&quot;%s\&quot;, params: %d [%s]&quot;</span>, event, origin ? origin : <span class="stringliteral">&quot;NULL&quot;</span>, cnt, buf);
<a name="l00390"></a>00390 }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392 <span class="keywordtype">void</span> event_connect (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00393"></a>00393 {
<a name="l00394"></a>00394     <span class="comment">// no params</span>
<a name="l00395"></a>00395     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00396"></a>00396     
<a name="l00397"></a>00397     ctx-&gt;push(constructMessage(MT_StatusUpdate, 0, 0, <span class="stringliteral">&quot;Joining Channels ...&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>));
<a name="l00398"></a>00398     
<a name="l00399"></a>00399     <span class="comment">// join our preset channel</span>
<a name="l00400"></a>00400     <span class="keyword">const</span> <span class="keywordtype">char</span> *channelKey = ctx-&gt;channelKey.c_str();
<a name="l00401"></a>00401     <span class="keywordflow">if</span> (ctx-&gt;channelKey.empty()) channelKey = 0;
<a name="l00402"></a>00402     <a class="code" href="libircclient_8h.html#a4960c546c2a077e8fb01fc7aa5ae7add" title="Joins the new IRC channel.">irc_cmd_join</a> (session, ctx-&gt;channel.c_str(), channelKey);
<a name="l00403"></a>00403     <span class="comment">// tell the main that we are connected now</span>
<a name="l00404"></a>00404     ctx-&gt;wasConnected = <span class="keyword">true</span>;
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 <span class="keywordtype">void</span> event_nick (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00408"></a>00408 {
<a name="l00409"></a>00409     <span class="comment">/*</span>
<a name="l00410"></a>00410 <span class="comment">        origin  the person, who changes the nick. Note that it can be you!</span>
<a name="l00411"></a>00411 <span class="comment">        params[0]   mandatory, contains the new nick.</span>
<a name="l00412"></a>00412 <span class="comment">    */</span>
<a name="l00413"></a>00413     <span class="keywordflow">if</span> ( count != 1 ) <span class="keywordflow">return</span>;
<a name="l00414"></a>00414     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00415"></a>00415     
<a name="l00416"></a>00416     <span class="keywordtype">bool</span> myself = isSelf(ctx, origin);
<a name="l00417"></a>00417     ctx-&gt;push(constructMessage(myself ? MT_NickChangeSelf : MT_NickChangeOther, 0, origin, params[0]));
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420 <span class="keywordtype">void</span> event_quit (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00421"></a>00421 {
<a name="l00422"></a>00422     <span class="comment">/*</span>
<a name="l00423"></a>00423 <span class="comment">        origin  the person, who is disconnected</span>
<a name="l00424"></a>00424 <span class="comment">        params[0]   optional, contains the reason message (user-specified).</span>
<a name="l00425"></a>00425 <span class="comment">    */</span>
<a name="l00426"></a>00426     <span class="keywordflow">if</span> ( count != 1 ) <span class="keywordflow">return</span>;
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00429"></a>00429     ctx-&gt;push(constructMessage(MT_QuitOther, 0, origin, params[0]));
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 <span class="keywordtype">void</span> event_join (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00433"></a>00433 {
<a name="l00434"></a>00434     <span class="comment">/*</span>
<a name="l00435"></a>00435 <span class="comment">        origin  the person, who joins the channel. By comparing it with your own nickname, you can check whether your JOIN command succeed.</span>
<a name="l00436"></a>00436 <span class="comment">        params[0]   mandatory, contains the channel name.</span>
<a name="l00437"></a>00437 <span class="comment">    */</span>
<a name="l00438"></a>00438     
<a name="l00439"></a>00439     <span class="comment">// set some user modes</span>
<a name="l00440"></a>00440     
<a name="l00441"></a>00441     <span class="comment">// i - if set, marks a user as &#39;invisible&#39; - that is, not seen by lookups if the user is not in a channel.</span>
<a name="l00442"></a>00442     <span class="comment">// s - if set, marks a user for receipt of server notices.</span>
<a name="l00443"></a>00443     <a class="code" href="libircclient_8h.html#a71b0c8a534600d2b354be35e28735513" title="Views or changes your own user mode.">irc_cmd_user_mode</a> (session, <span class="stringliteral">&quot;+is&quot;</span>);
<a name="l00444"></a>00444 
<a name="l00445"></a>00445     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00446"></a>00446     <span class="keywordtype">bool</span> myself = isSelf(ctx, origin);
<a name="l00447"></a>00447     ctx-&gt;push(constructMessage(myself ? MT_JoinChannelSelf : MT_JoinChannelOther, params[0], origin, 0));
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     <span class="keywordflow">if</span> (myself)
<a name="l00450"></a>00450     {
<a name="l00451"></a>00451         <span class="comment">// clear status</span>
<a name="l00452"></a>00452         ctx-&gt;push(constructMessage(MT_StatusUpdate, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>));
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454 }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456 <span class="keywordtype">void</span> event_part (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00457"></a>00457 {
<a name="l00458"></a>00458     <span class="comment">/*</span>
<a name="l00459"></a>00459 <span class="comment">        origin  the person, who leaves the channel. By comparing it with your own nickname, you can check whether your PART command succeed.</span>
<a name="l00460"></a>00460 <span class="comment">        params[0]   mandatory, contains the channel name.</span>
<a name="l00461"></a>00461 <span class="comment">        params[1]   optional, contains the reason message (user-defined).</span>
<a name="l00462"></a>00462 <span class="comment">    */</span>
<a name="l00463"></a>00463     <span class="keywordflow">if</span> ( count != 2 ) <span class="keywordflow">return</span>;
<a name="l00464"></a>00464     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00465"></a>00465     <span class="keywordtype">bool</span> myself = isSelf(ctx, origin);
<a name="l00466"></a>00466     ctx-&gt;push(constructMessage(myself ? MT_PartChannelSelf : MT_PartChannelOther, params[0], origin, params[1]));
<a name="l00467"></a>00467 }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469 <span class="keywordtype">void</span> event_mode (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00470"></a>00470 {
<a name="l00471"></a>00471     <span class="comment">/*</span>
<a name="l00472"></a>00472 <span class="comment">        origin  the person, who changed the channel mode.</span>
<a name="l00473"></a>00473 <span class="comment">        params[0]   mandatory, contains the channel name.</span>
<a name="l00474"></a>00474 <span class="comment">        params[1]   mandatory, contains the changed channel mode, like &#39;+t&#39;, &#39;-i&#39; and so on.</span>
<a name="l00475"></a>00475 <span class="comment">        params[2]   optional, contains the mode argument (for example, a key for +k mode, or user who got the channel operator status for +o mode)</span>
<a name="l00476"></a>00476 <span class="comment">    */</span>
<a name="l00477"></a>00477     <span class="keywordflow">if</span> ( count != 3 ) <span class="keywordflow">return</span>;
<a name="l00478"></a>00478     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00479"></a>00479     ctx-&gt;push(constructMessage(MT_ChangedChannelMode, params[0], params[1], 0, params[2]));
<a name="l00480"></a>00480 }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 <span class="keywordtype">void</span> event_umode (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00483"></a>00483 {
<a name="l00484"></a>00484     <span class="comment">/*</span>
<a name="l00485"></a>00485 <span class="comment">        origin  the person, who changed the user mode.</span>
<a name="l00486"></a>00486 <span class="comment">        params[0]   mandatory, contains the user changed mode, like &#39;+t&#39;, &#39;-i&#39; and so on.</span>
<a name="l00487"></a>00487 <span class="comment">    */</span>
<a name="l00488"></a>00488     <span class="keywordflow">if</span> ( count != 1 ) <span class="keywordflow">return</span>;
<a name="l00489"></a>00489     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00490"></a>00490     ctx-&gt;push(constructMessage(MT_ChangedUserModeSelf, 0, 0, params[0]));
<a name="l00491"></a>00491 }
<a name="l00492"></a>00492 
<a name="l00493"></a>00493 <span class="keywordtype">void</span> event_topic (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00494"></a>00494 {
<a name="l00495"></a>00495     <span class="comment">/*</span>
<a name="l00496"></a>00496 <span class="comment">        origin  the person, who changes the channel topic.</span>
<a name="l00497"></a>00497 <span class="comment">        params[0]   mandatory, contains the channel name.</span>
<a name="l00498"></a>00498 <span class="comment">        params[1]   optional, contains the new topic.</span>
<a name="l00499"></a>00499 <span class="comment">    */</span>
<a name="l00500"></a>00500     <span class="keywordflow">if</span> (count != 2) <span class="keywordflow">return</span>;
<a name="l00501"></a>00501     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00502"></a>00502     ctx-&gt;push(constructMessage(MT_ChangedChannelTopic, params[0], origin, params[1]));
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505 <span class="keywordtype">void</span> event_kick (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00506"></a>00506 {
<a name="l00507"></a>00507     <span class="comment">/*</span>
<a name="l00508"></a>00508 <span class="comment">        origin  the person, who kicked the poor.</span>
<a name="l00509"></a>00509 <span class="comment">        params[0]   mandatory, contains the channel name.</span>
<a name="l00510"></a>00510 <span class="comment">        params[1]   optional, contains the nick of kicked person.</span>
<a name="l00511"></a>00511 <span class="comment">        params[2]   optional, contains the kick text</span>
<a name="l00512"></a>00512 <span class="comment">    */</span>
<a name="l00513"></a>00513     <span class="keywordflow">if</span> (count != 3) <span class="keywordflow">return</span>;
<a name="l00514"></a>00514     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00515"></a>00515     <span class="keywordtype">bool</span> myself = isSelf(ctx, params[1]);
<a name="l00516"></a>00516     ctx-&gt;push(constructMessage(myself ? MT_WeGotKicked : MT_SomeoneGotKicked, params[0], origin, params[2], params[1]));
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     <span class="keywordflow">if</span> (myself &amp;&amp; ctx-&gt;reJoin)
<a name="l00519"></a>00519     {
<a name="l00520"></a>00520         <span class="comment">// try to rejoin the channel</span>
<a name="l00521"></a>00521         <span class="keyword">const</span> <span class="keywordtype">char</span> *channelKey = ctx-&gt;channelKey.c_str();
<a name="l00522"></a>00522         <span class="keywordflow">if</span> (ctx-&gt;channelKey.empty()) channelKey = 0;
<a name="l00523"></a>00523         <a class="code" href="libircclient_8h.html#a4960c546c2a077e8fb01fc7aa5ae7add" title="Joins the new IRC channel.">irc_cmd_join</a> (session, ctx-&gt;channel.c_str(), channelKey);   
<a name="l00524"></a>00524     }
<a name="l00525"></a>00525 
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528 <span class="keywordtype">void</span> event_channel (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00529"></a>00529 {
<a name="l00530"></a>00530     <span class="comment">/*</span>
<a name="l00531"></a>00531 <span class="comment">        origin  the person, who generates the message.</span>
<a name="l00532"></a>00532 <span class="comment">        params[0]   mandatory, contains the channel name.</span>
<a name="l00533"></a>00533 <span class="comment">        params[1]   optional, contains the message text</span>
<a name="l00534"></a>00534 <span class="comment">    */</span>
<a name="l00535"></a>00535     <span class="keywordflow">if</span> ( count != 2 ) <span class="keywordflow">return</span>;
<a name="l00536"></a>00536     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00537"></a>00537     ctx-&gt;push(constructMessage(MT_Channel, params[0], origin, params[1]));
<a name="l00538"></a>00538 }
<a name="l00539"></a>00539 
<a name="l00540"></a>00540 <span class="keywordtype">void</span> event_privmsg (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00541"></a>00541 {
<a name="l00542"></a>00542     <span class="comment">/*</span>
<a name="l00543"></a>00543 <span class="comment">        origin  the person, who generates the message.</span>
<a name="l00544"></a>00544 <span class="comment">        params[0]   mandatory, contains your nick.</span>
<a name="l00545"></a>00545 <span class="comment">        params[1]   optional, contains the message text</span>
<a name="l00546"></a>00546 <span class="comment">    */</span>
<a name="l00547"></a>00547     <span class="keywordflow">if</span> ( count != 2 ) <span class="keywordflow">return</span>;
<a name="l00548"></a>00548     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00549"></a>00549     ctx-&gt;push(constructMessage(MT_GotPrivateMessage, 0, origin, params[1], params[0]));
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="keywordtype">void</span> event_notice (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00553"></a>00553 {
<a name="l00554"></a>00554     <span class="comment">/*</span>
<a name="l00555"></a>00555 <span class="comment">        origin  the person, who generates the message.</span>
<a name="l00556"></a>00556 <span class="comment">        params[0]   mandatory, contains the target nick name.</span>
<a name="l00557"></a>00557 <span class="comment">        params[1]   optional, contains the message text</span>
<a name="l00558"></a>00558 <span class="comment">    */</span>
<a name="l00559"></a>00559     <span class="keywordflow">if</span> ( count != 2 ) <span class="keywordflow">return</span>;
<a name="l00560"></a>00560     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00561"></a>00561     ctx-&gt;push(constructMessage(MT_GotNotice, 0, origin, params[1], params[0]));
<a name="l00562"></a>00562 }
<a name="l00563"></a>00563 
<a name="l00564"></a>00564 <span class="keywordtype">void</span> event_invite (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keyword">const</span> <span class="keywordtype">char</span> * event, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00565"></a>00565 {
<a name="l00566"></a>00566     <span class="comment">/*</span>
<a name="l00567"></a>00567 <span class="comment">        origin  the person, who INVITEs you.</span>
<a name="l00568"></a>00568 <span class="comment">        params[0]   mandatory, contains your nick.</span>
<a name="l00569"></a>00569 <span class="comment">        params[1]   mandatory, contains the channel name you&#39;re invited into.</span>
<a name="l00570"></a>00570 <span class="comment">    */</span>
<a name="l00571"></a>00571     <span class="keywordflow">if</span> ( count != 2 ) <span class="keywordflow">return</span>;
<a name="l00572"></a>00572     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00573"></a>00573     ctx-&gt;push(constructMessage(MT_GotInvitation, params[1], origin, 0, params[0]));
<a name="l00574"></a>00574 }
<a name="l00575"></a>00575 
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 
<a name="l00578"></a>00578 <span class="keywordtype">void</span> event_numeric (<a class="code" href="structirc__session__s.html">irc_session_t</a> * session, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> eventNum, <span class="keyword">const</span> <span class="keywordtype">char</span> * origin, <span class="keyword">const</span> <span class="keywordtype">char</span> ** params, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00579"></a>00579 {
<a name="l00580"></a>00580     IRCWrapper * ctx = (IRCWrapper *) <a class="code" href="libircclient_8h.html#a341a8954613f29c7ff5a92413398ce7d" title="Returns the IRC session context.">irc_get_ctx</a> (session);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582     <span class="keywordtype">char</span> buf[24];
<a name="l00583"></a>00583     sprintf (buf, <span class="stringliteral">&quot;%d&quot;</span>, eventNum);
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     <span class="keywordflow">if</span> (eventNum == 433)
<a name="l00586"></a>00586     {
<a name="l00587"></a>00587         <span class="comment">// 433 = uername already used, try to take another one</span>
<a name="l00588"></a>00588         <a class="code" href="_utils_8h.html#adf01f31d14c27678973fd6603dae2feb">sleepMilliSeconds</a>(500);
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         <span class="comment">//irc_ctx_t * ctx = (irc_ctx_t *) irc_get_ctx (session);</span>
<a name="l00592"></a>00592         <span class="comment">//ctx-&gt;retryCounter++;</span>
<a name="l00593"></a>00593         ctx-&gt;nick += <span class="stringliteral">&quot;_&quot;</span>;
<a name="l00594"></a>00594 
<a name="l00595"></a>00595         <span class="comment">// now change the nick</span>
<a name="l00596"></a>00596         <a class="code" href="libircclient_8h.html#a19ae1ad61caf031e5c2dc950e24b7370" title="Changes your nick.">irc_cmd_nick</a>(session, ctx-&gt;<a class="code" href="structirc__session__s.html#a4f14fbbac50a5d9616f3c4a9677ac2b6">nick</a>.c_str());
<a name="l00597"></a>00597         <a class="code" href="_utils_8h.html#adf01f31d14c27678973fd6603dae2feb">sleepMilliSeconds</a>(500);
<a name="l00598"></a>00598 
<a name="l00599"></a>00599         <span class="comment">// and rejoin the channels</span>
<a name="l00600"></a>00600         <a class="code" href="libircclient_8h.html#a4960c546c2a077e8fb01fc7aa5ae7add" title="Joins the new IRC channel.">irc_cmd_join</a> (session, ctx-&gt;channel.c_str(), 0);
<a name="l00601"></a>00601     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (eventNum == 251)
<a name="l00602"></a>00602     {
<a name="l00603"></a>00603         <span class="comment">// 251 = There are &lt;integer&gt; users and &lt;integer&gt; services on &lt;integer&gt; servers</span>
<a name="l00604"></a>00604         <span class="keywordflow">if</span> (count != 2) <span class="keywordflow">return</span>;
<a name="l00605"></a>00605         ctx-&gt;push(constructMessage(MT_VerboseMessage, 0, origin, params[1], params[0]));
<a name="l00606"></a>00606     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (eventNum == 372)
<a name="l00607"></a>00607     {
<a name="l00608"></a>00608         <span class="comment">// 372 = RPL_MOTD</span>
<a name="l00609"></a>00609         <span class="keywordflow">if</span> (count != 2) <span class="keywordflow">return</span>;
<a name="l00610"></a>00610         ctx-&gt;push(constructMessage(MT_VerboseMessage, 0, origin, params[1], params[0]));
<a name="l00611"></a>00611     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (eventNum == 332)
<a name="l00612"></a>00612     {
<a name="l00613"></a>00613         <span class="comment">// 332 = RPL_TOPIC / When sending a TOPIC message to determine the channel topic, one of two replies is sent. If the topic is set, RPL_TOPIC is sent back else RPL_NOTOPIC.</span>
<a name="l00614"></a>00614         <span class="keywordflow">if</span> (count != 3) <span class="keywordflow">return</span>;
<a name="l00615"></a>00615         ctx-&gt;push(constructMessage(MT_TopicInfo, params[1], origin, params[2], params[0]));
<a name="l00616"></a>00616     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (eventNum == 353)
<a name="l00617"></a>00617     {
<a name="l00618"></a>00618         <span class="comment">// 353 = RPL_NAMREPLY</span>
<a name="l00619"></a>00619         <span class="keywordflow">if</span> (count != 4) <span class="keywordflow">return</span>;
<a name="l00620"></a>00620         ctx-&gt;push(constructMessage(MT_NameList, params[2], origin, params[3], params[1  ]));
<a name="l00621"></a>00621 
<a name="l00622"></a>00622     } <span class="keywordflow">else</span>
<a name="l00623"></a>00623     {
<a name="l00624"></a>00624         dump_event (session, buf, origin, params, count);
<a name="l00625"></a>00625     }
<a name="l00626"></a>00626 }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628 
<a name="l00629"></a>00629 <span class="keywordtype">void</span> *s_ircthreadstart(<span class="keywordtype">void</span>* arg)
<a name="l00630"></a>00630 {
<a name="l00631"></a>00631     IRCWrapper *ctx = (IRCWrapper *)arg;
<a name="l00632"></a>00632 
<a name="l00633"></a>00633     ctx-&gt;push(constructMessage(MT_StatusUpdate, 0, 0, <span class="stringliteral">&quot;Authenticating ...&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>));
<a name="l00634"></a>00634     
<a name="l00635"></a>00635     <span class="comment">// authenticate before doing anything else</span>
<a name="l00636"></a>00636     <span class="comment">// we are doing it in this thread so the userinteface will not lag</span>
<a name="l00637"></a>00637     <span class="keywordflow">if</span> (ctx-&gt;authenticate())
<a name="l00638"></a>00638     {
<a name="l00639"></a>00639         
<a name="l00640"></a>00640         ctx-&gt;push(constructMessage(MT_ErrorAuth, 0, 0, <span class="stringliteral">&quot;Could not authenticate, please try again later&quot;</span>));
<a name="l00641"></a>00641         <span class="comment">// clear status</span>
<a name="l00642"></a>00642         ctx-&gt;push(constructMessage(MT_StatusUpdate, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>));
<a name="l00643"></a>00643         <span class="comment">// end thread</span>
<a name="l00644"></a>00644         <span class="keywordflow">return</span> 0;
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00648"></a>00648 <span class="preprocessor"></span>    <span class="comment">// winsock startup, required</span>
<a name="l00649"></a>00649     WORD wVersionRequested = MAKEWORD (1, 1);
<a name="l00650"></a>00650     WSADATA wsaData;
<a name="l00651"></a>00651 
<a name="l00652"></a>00652     <span class="keywordflow">if</span> ( WSAStartup (wVersionRequested, &amp;wsaData) != 0 )
<a name="l00653"></a>00653     {
<a name="l00654"></a>00654         <a class="code" href="_ro_r_prerequisites_8h.html#af855c94dc540e943632089ce7496faac">LOG</a>(<span class="stringliteral">&quot;IRC| failed to init IRC socket&quot;</span>);
<a name="l00655"></a>00655         <span class="keywordflow">return</span> 0;
<a name="l00656"></a>00656     }
<a name="l00657"></a>00657 <span class="preprocessor">#endif // _WIN32</span>
<a name="l00658"></a>00658 <span class="preprocessor"></span>
<a name="l00659"></a>00659     <span class="comment">// setup the callbacks</span>
<a name="l00660"></a>00660     <a class="code" href="structirc__callbacks__t.html" title="Event callbacks structure.">irc_callbacks_t</a> callbacks;
<a name="l00661"></a>00661     memset (&amp;callbacks, 0, <span class="keyword">sizeof</span>(callbacks));
<a name="l00662"></a>00662 
<a name="l00663"></a>00663     <span class="comment">// The &quot;on_connect&quot; event is triggered when the client successfully connects to the server, and could send commands to the server. No extra params supplied; params is 0.</span>
<a name="l00664"></a>00664     callbacks.<a class="code" href="structirc__callbacks__t.html#a7294e75ca74ba6dc2b5c18ef8e7795a2">event_connect</a> = event_connect;
<a name="l00665"></a>00665     <span class="comment">// The &quot;nick&quot; event is triggered when the client receives a NICK message, meaning that someone (including you) on a channel with the client has changed their nickname.</span>
<a name="l00666"></a>00666     callbacks.<a class="code" href="structirc__callbacks__t.html#a6151296f8a888132bd25d7db67ff70a5">event_nick</a> = event_nick;
<a name="l00667"></a>00667     <span class="comment">// The &quot;quit&quot; event is triggered upon receipt of a QUIT message, which means that someone on a channel with the client has disconnected.</span>
<a name="l00668"></a>00668     callbacks.<a class="code" href="structirc__callbacks__t.html#aa4a728c3926384c3781aa65a18ebeb7a">event_quit</a> = event_quit;
<a name="l00669"></a>00669     <span class="comment">// The &quot;join&quot; event is triggered upon receipt of a JOIN message, which means that someone has entered a channel that the client is on.</span>
<a name="l00670"></a>00670     callbacks.<a class="code" href="structirc__callbacks__t.html#a8f24c0e2b05425c2308a0106dbaaffec">event_join</a> = event_join;
<a name="l00671"></a>00671     <span class="comment">// The &quot;part&quot; event is triggered upon receipt of a PART message, which means that someone has left a channel that the client is on.</span>
<a name="l00672"></a>00672     callbacks.<a class="code" href="structirc__callbacks__t.html#a0076faaabcf638dba3f08c2048956621">event_part</a> = event_part;
<a name="l00673"></a>00673     <span class="comment">// The &quot;mode&quot; event is triggered upon receipt of a channel MODE message, which means that someone on a channel with the client has changed the channel&#39;s parameters.</span>
<a name="l00674"></a>00674     callbacks.<a class="code" href="structirc__callbacks__t.html#a3d7add398f78ad0a3c5d96133411d60a">event_mode</a> = event_mode;
<a name="l00675"></a>00675     <span class="comment">// The &quot;umode&quot; event is triggered upon receipt of a user MODE message, which means that your user mode has been changed.</span>
<a name="l00676"></a>00676     callbacks.<a class="code" href="structirc__callbacks__t.html#aa92693d9acb2013f6f4b54301ee54d61">event_umode</a> = event_umode;
<a name="l00677"></a>00677     <span class="comment">// The &quot;topic&quot; event is triggered upon receipt of a TOPIC message, which means that someone on a channel with the client has changed the channel&#39;s topic.</span>
<a name="l00678"></a>00678     callbacks.<a class="code" href="structirc__callbacks__t.html#a8a5ab3ffc89e19d5748c58bb675436b5">event_topic</a> = event_topic;
<a name="l00679"></a>00679     <span class="comment">// The &quot;kick&quot; event is triggered upon receipt of a KICK message, which means that someone on a channel with the client (or possibly the client itself!) has been forcibly ejected.</span>
<a name="l00680"></a>00680     callbacks.<a class="code" href="structirc__callbacks__t.html#a1a8194bfdbf2622e9384fbd1ac1a67d7">event_kick</a> = event_kick;
<a name="l00681"></a>00681     <span class="comment">// The &quot;channel&quot; event is triggered upon receipt of a PRIVMSG message to an entire channel, which means that someone on a channel with the client has said something aloud. Your own messages don&#39;t trigger PRIVMSG event.</span>
<a name="l00682"></a>00682     callbacks.<a class="code" href="structirc__callbacks__t.html#a87d4401073ce8dba9a43fcbcaa20d341">event_channel</a> = event_channel;
<a name="l00683"></a>00683     <span class="comment">// The &quot;privmsg&quot; event is triggered upon receipt of a PRIVMSG message which is addressed to one or more clients, which means that someone is sending the client a private message.</span>
<a name="l00684"></a>00684     callbacks.<a class="code" href="structirc__callbacks__t.html#af0fe4e42f9d675f0d844fc3c58b2dc5d">event_privmsg</a> = event_privmsg;
<a name="l00685"></a>00685     <span class="comment">// The &quot;notice&quot; event is triggered upon receipt of a NOTICE message which means that someone has sent the client a public or private notice. According to RFC 1459, the only difference between NOTICE and PRIVMSG is that you should NEVER automatically reply to NOTICE messages. Unfortunately, this rule is frequently violated by IRC servers itself - for example, NICKSERV messages require reply, and are NOTICEs.</span>
<a name="l00686"></a>00686     callbacks.<a class="code" href="structirc__callbacks__t.html#a92a5b22ba900f06fa04ea9e79462ffc6">event_notice</a> = event_notice;
<a name="l00687"></a>00687     <span class="comment">// The &quot;channel_notice&quot; event is triggered upon receipt of a NOTICE message which means that someone has sent the client a public notice. According to RFC 1459, the only difference between NOTICE and PRIVMSG is that you should NEVER automatically reply to NOTICE messages. Unfortunately, this rule is frequently violated by IRC servers itself - for example, NICKSERV messages require reply, and are NOTICEs.</span>
<a name="l00688"></a>00688     <span class="comment">//callbacks.event_channel_notice = dump_event;</span>
<a name="l00689"></a>00689     <span class="comment">// The &quot;invite&quot; event is triggered upon receipt of an INVITE message, which means that someone is permitting the client&#39;s entry into a +i channel.</span>
<a name="l00690"></a>00690     callbacks.<a class="code" href="structirc__callbacks__t.html#ae5f3325ab13c3a36ed84435e3bcf7b61">event_invite</a> = event_invite;
<a name="l00691"></a>00691     <span class="comment">// The &quot;ctcp&quot; event is triggered when the client receives the CTCP request. By default, the built-in CTCP request handler is used. The build-in handler automatically replies on most CTCP messages, so you will rarely need to override it.</span>
<a name="l00692"></a>00692     <span class="comment">//callbacks.event_ctcp_req = dump_event;</span>
<a name="l00693"></a>00693     <span class="comment">// The &quot;ctcp&quot; event is triggered when the client receives the CTCP reply.</span>
<a name="l00694"></a>00694     <span class="comment">//callbacks.event_ctcp_rep = dump_event;</span>
<a name="l00695"></a>00695     <span class="comment">// The &quot;action&quot; event is triggered when the client receives the CTCP ACTION message.</span>
<a name="l00696"></a>00696     <span class="comment">//callbacks.event_ctcp_action = dump_event;</span>
<a name="l00697"></a>00697     <span class="comment">// The &quot;unknown&quot; event is triggered upon receipt of any number of unclassifiable miscellaneous messages, which aren&#39;t handled by the library.</span>
<a name="l00698"></a>00698     callbacks.<a class="code" href="structirc__callbacks__t.html#a765b4f0a622cedf2c26c1a615414a3a4">event_unknown</a> = dump_event;
<a name="l00699"></a>00699     <span class="comment">// The &quot;numeric&quot; event is triggered upon receipt of any numeric response from the server. There is a lot of such responses, see the full list here: Numeric reply codes from RFC1459.</span>
<a name="l00700"></a>00700     callbacks.<a class="code" href="structirc__callbacks__t.html#a85951d45acff22aea37a822bb9c7aef7">event_numeric</a> = event_numeric;
<a name="l00701"></a>00701     <span class="comment">// The &quot;dcc chat&quot; event is triggered when someone requests a DCC CHAT from you.</span>
<a name="l00702"></a>00702     <span class="comment">//callbacks.event_dcc_chat_req = dump_event;</span>
<a name="l00703"></a>00703     <span class="comment">// The &quot;dcc chat&quot; event is triggered when someone wants to send a file to you via DCC SEND request.</span>
<a name="l00704"></a>00704     <span class="comment">//callbacks.event_dcc_send_req = dump_event;</span>
<a name="l00705"></a>00705 
<a name="l00706"></a>00706     ctx-&gt;push(constructMessage(MT_StatusUpdate, 0, 0, <span class="stringliteral">&quot;Connecting ...&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>));
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     ctx-&gt;irc_session = <a class="code" href="libircclient_8h.html#ac5dada35ee77795d8bb77b6701853b98" title="Creates and initiates a new IRC session.">irc_create_session</a> (&amp;callbacks);
<a name="l00709"></a>00709     <span class="keywordflow">if</span> (!ctx-&gt;irc_session)
<a name="l00710"></a>00710     {
<a name="l00711"></a>00711         <a class="code" href="_ro_r_prerequisites_8h.html#af855c94dc540e943632089ce7496faac">LOG</a> (<span class="stringliteral">&quot;Could not create session&quot;</span>);
<a name="l00712"></a>00712         <span class="comment">// clear status</span>
<a name="l00713"></a>00713         ctx-&gt;push(constructMessage(MT_StatusUpdate, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>));
<a name="l00714"></a>00714         <span class="keywordflow">return</span> 0;
<a name="l00715"></a>00715     }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     ctx-&gt;retryCounter++;
<a name="l00718"></a>00718     <span class="keywordflow">if</span> (ctx-&gt;retryCounter &gt; 1)
<a name="l00719"></a>00719     {
<a name="l00720"></a>00720         <span class="comment">// sleep longer the more often we try to connect - security measure</span>
<a name="l00721"></a>00721         <span class="comment">// gives the old connection the chance to time-out</span>
<a name="l00722"></a>00722         <a class="code" href="_utils_8h.html#adf01f31d14c27678973fd6603dae2feb">sleepMilliSeconds</a>(2000*ctx-&gt;retryCounter);
<a name="l00723"></a>00723     }
<a name="l00724"></a>00724 
<a name="l00725"></a>00725     <a class="code" href="libircclient_8h.html#ae0cf439a36aafce4abab8f4cce5ac5ff" title="Sets the IRC session context.">irc_set_ctx</a> (ctx-&gt;irc_session, ctx);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     <span class="comment">// allows to strip origins automatically</span>
<a name="l00728"></a>00728     <a class="code" href="libircclient_8h.html#af56687ccad2045204ae23f70d2f54860" title="Resets the libircclient option.">irc_option_reset</a>(ctx-&gt;irc_session, <a class="code" href="libirc__options_8h.html#a0dd67b0a5373a108d86d911fa5741e72" title="allows to strip origins automatically.">LIBIRC_OPTION_STRIPNICKS</a>);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     <span class="comment">// some c++ -&gt; c mapping</span>
<a name="l00731"></a>00731     <span class="keyword">const</span> <span class="keywordtype">char</span> *serverName     = ctx-&gt;serverName.c_str();
<a name="l00732"></a>00732     <span class="keyword">const</span> <span class="keywordtype">char</span> *serverPassword = ctx-&gt;serverPassword.c_str();
<a name="l00733"></a>00733     <span class="keywordflow">if</span> (ctx-&gt;serverPassword.empty()) serverPassword = 0;
<a name="l00734"></a>00734     <span class="keyword">const</span> <span class="keywordtype">char</span> *nick           = ctx-&gt;nick.c_str();
<a name="l00735"></a>00735     <span class="keywordflow">if</span> (ctx-&gt;nick.empty()) nick = 0;
<a name="l00736"></a>00736     <span class="keyword">const</span> <span class="keywordtype">char</span> *userName       = ctx-&gt;userName.c_str();
<a name="l00737"></a>00737     <span class="keywordflow">if</span> (ctx-&gt;userName.empty()) userName = 0;
<a name="l00738"></a>00738     <span class="keyword">const</span> <span class="keywordtype">char</span> *realName       = ctx-&gt;realName.c_str();
<a name="l00739"></a>00739     <span class="keywordflow">if</span> (ctx-&gt;realName.empty()) realName = 0;
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     <span class="keywordflow">if</span> (<a class="code" href="libircclient_8h.html#a121b23c9e131da651175ae779e1b6851" title="Initiates a connection to IRC server.">irc_connect</a> (ctx-&gt;irc_session, serverName, ctx-&gt;serverPort, serverPassword, nick, userName, realName))
<a name="l00742"></a>00742     {
<a name="l00743"></a>00743         <a class="code" href="_ro_r_prerequisites_8h.html#af855c94dc540e943632089ce7496faac">LOG</a> (<span class="stringliteral">&quot;Could not connect: &quot;</span> + String(<a class="code" href="errors_8c_09_09.html#afdc70ca04626818d2fd9a55da0b90e5f" title="Returns the text error message associated with this error code.">irc_strerror</a> (<a class="code" href="errors_8c_09_09.html#a3a18336093ee74751244d996bc32247d" title="Returns the last error code.">irc_errno</a>(ctx-&gt;irc_session))));
<a name="l00744"></a>00744         <span class="keywordflow">return</span> 0;
<a name="l00745"></a>00745     }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747 
<a name="l00748"></a>00748     <span class="comment">// start the main loop in this thread</span>
<a name="l00749"></a>00749     <a class="code" href="libircclient_8h.html#a112631b75eb9997868d73fede17440d0" title="Goes into forever-loop, processing IRC events and generating callbacks.">irc_run</a> (ctx-&gt;irc_session);
<a name="l00750"></a>00750     <a class="code" href="libircclient_8h.html#a30c6cea4f149632d1905b097a3a573f7" title="Destroys previously created IRC session.">irc_destroy_session</a>(ctx-&gt;irc_session);
<a name="l00751"></a>00751     <span class="keywordflow">return</span> 0;
<a name="l00752"></a>00752 }
<a name="l00753"></a>00753 
<a name="l00754"></a>00754 <span class="preprocessor">#endif // USE_SOCKETW</span>
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Mon Oct 12 2015 12:27:51 for Rigs of Rods by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
