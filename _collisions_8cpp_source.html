<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Rigs of Rods: source/main/physics/collision/Collisions.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="rorlogo.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Rigs of Rods
   
   </div>
   <div id="projectbrief">Soft-body Physics Simulation</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">source/main/physics/collision/Collisions.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_collisions_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">This source file is part of Rigs of Rods</span>
<a name="l00003"></a>00003 <span class="comment">Copyright 2005-2012 Pierre-Michel Ricordel</span>
<a name="l00004"></a>00004 <span class="comment">Copyright 2007-2012 Thomas Fischer</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">For more information, see http://www.rigsofrods.com/</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">Rigs of Rods is free software: you can redistribute it and/or modify</span>
<a name="l00009"></a>00009 <span class="comment">it under the terms of the GNU General Public License version 3, as</span>
<a name="l00010"></a>00010 <span class="comment">published by the Free Software Foundation.</span>
<a name="l00011"></a>00011 <span class="comment"></span>
<a name="l00012"></a>00012 <span class="comment">Rigs of Rods is distributed in the hope that it will be useful,</span>
<a name="l00013"></a>00013 <span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00014"></a>00014 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00015"></a>00015 <span class="comment">GNU General Public License for more details.</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">You should have received a copy of the GNU General Public License</span>
<a name="l00018"></a>00018 <span class="comment">along with Rigs of Rods.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00019"></a>00019 <span class="comment">*/</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="_collisions_8h.html">Collisions.h</a>&quot;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="_approx_math_8h.html">ApproxMath.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="_beam_factory_8h.html">BeamFactory.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="_error_utils_8h.html">ErrorUtils.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="_i_height_finder_8h.html">IHeightFinder.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="_landusemap_8h.html">Landusemap.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="_language_8h.html">Language.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="_movable_text_8h.html">MovableText.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="_scripting_8h.html">Scripting.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="_settings_8h.html">Settings.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="_terrain_manager_8h.html">TerrainManager.h</a>&quot;</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment">// some gcc fixes</span>
<a name="l00034"></a>00034 <span class="preprocessor">#if OGRE_PLATFORM == OGRE_PLATFORM_LINUX</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">#pragma GCC diagnostic ignored &quot;-Wfloat-equal&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#endif //OGRE_PLATFORM_LINUX</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span>
<a name="l00038"></a>00038 <span class="comment">//hash function SBOX</span>
<a name="l00039"></a>00039 <span class="comment">//from http://home.comcast.net/~bretm/hash/10.html</span>
<a name="l00040"></a><a class="code" href="_collisions_8cpp.html#ad4a184f987800468b1178cfc1a286a51">00040</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="_collisions_8cpp.html#ad4a184f987800468b1178cfc1a286a51">sbox</a>[] =
<a name="l00041"></a>00041 {
<a name="l00042"></a>00042     0xF53E1837, 0x5F14C86B, 0x9EE3964C, 0xFA796D53,
<a name="l00043"></a>00043     0x32223FC3, 0x4D82BC98, 0xA0C7FA62, 0x63E2C982,
<a name="l00044"></a>00044     0x24994A5B, 0x1ECE7BEE, 0x292B38EF, 0xD5CD4E56,
<a name="l00045"></a>00045     0x514F4303, 0x7BE12B83, 0x7192F195, 0x82DC7300,
<a name="l00046"></a>00046     0x084380B4, 0x480B55D3, 0x5F430471, 0x13F75991,
<a name="l00047"></a>00047     0x3F9CF22C, 0x2FE0907A, 0xFD8E1E69, 0x7B1D5DE8,
<a name="l00048"></a>00048     0xD575A85C, 0xAD01C50A, 0x7EE00737, 0x3CE981E8,
<a name="l00049"></a>00049     0x0E447EFA, 0x23089DD6, 0xB59F149F, 0x13600EC7,
<a name="l00050"></a>00050     0xE802C8E6, 0x670921E4, 0x7207EFF0, 0xE74761B0,
<a name="l00051"></a>00051     0x69035234, 0xBFA40F19, 0xF63651A0, 0x29E64C26,
<a name="l00052"></a>00052     0x1F98CCA7, 0xD957007E, 0xE71DDC75, 0x3E729595,
<a name="l00053"></a>00053     0x7580B7CC, 0xD7FAF60B, 0x92484323, 0xA44113EB,
<a name="l00054"></a>00054     0xE4CBDE08, 0x346827C9, 0x3CF32AFA, 0x0B29BCF1,
<a name="l00055"></a>00055     0x6E29F7DF, 0xB01E71CB, 0x3BFBC0D1, 0x62EDC5B8,
<a name="l00056"></a>00056     0xB7DE789A, 0xA4748EC9, 0xE17A4C4F, 0x67E5BD03,
<a name="l00057"></a>00057     0xF3B33D1A, 0x97D8D3E9, 0x09121BC0, 0x347B2D2C,
<a name="l00058"></a>00058     0x79A1913C, 0x504172DE, 0x7F1F8483, 0x13AC3CF6,
<a name="l00059"></a>00059     0x7A2094DB, 0xC778FA12, 0xADF7469F, 0x21786B7B,
<a name="l00060"></a>00060     0x71A445D0, 0xA8896C1B, 0x656F62FB, 0x83A059B3,
<a name="l00061"></a>00061     0x972DFE6E, 0x4122000C, 0x97D9DA19, 0x17D5947B,
<a name="l00062"></a>00062     0xB1AFFD0C, 0x6EF83B97, 0xAF7F780B, 0x4613138A,
<a name="l00063"></a>00063     0x7C3E73A6, 0xCF15E03D, 0x41576322, 0x672DF292,
<a name="l00064"></a>00064     0xB658588D, 0x33EBEFA9, 0x938CBF06, 0x06B67381,
<a name="l00065"></a>00065     0x07F192C6, 0x2BDA5855, 0x348EE0E8, 0x19DBB6E3,
<a name="l00066"></a>00066     0x3222184B, 0xB69D5DBA, 0x7E760B88, 0xAF4D8154,
<a name="l00067"></a>00067     0x007A51AD, 0x35112500, 0xC9CD2D7D, 0x4F4FB761,
<a name="l00068"></a>00068     0x694772E3, 0x694C8351, 0x4A7E3AF5, 0x67D65CE1,
<a name="l00069"></a>00069     0x9287DE92, 0x2518DB3C, 0x8CB4EC06, 0xD154D38F,
<a name="l00070"></a>00070     0xE19A26BB, 0x295EE439, 0xC50A1104, 0x2153C6A7,
<a name="l00071"></a>00071     0x82366656, 0x0713BC2F, 0x6462215A, 0x21D9BFCE,
<a name="l00072"></a>00072     0xBA8EACE6, 0xAE2DF4C1, 0x2A8D5E80, 0x3F7E52D1,
<a name="l00073"></a>00073     0x29359399, 0xFEA1D19C, 0x18879313, 0x455AFA81,
<a name="l00074"></a>00074     0xFADFE838, 0x62609838, 0xD1028839, 0x0736E92F,
<a name="l00075"></a>00075     0x3BCA22A3, 0x1485B08A, 0x2DA7900B, 0x852C156D,
<a name="l00076"></a>00076     0xE8F24803, 0x00078472, 0x13F0D332, 0x2ACFD0CF,
<a name="l00077"></a>00077     0x5F747F5C, 0x87BB1E2F, 0xA7EFCB63, 0x23F432F0,
<a name="l00078"></a>00078     0xE6CE7C5C, 0x1F954EF6, 0xB609C91B, 0x3B4571BF,
<a name="l00079"></a>00079     0xEED17DC0, 0xE556CDA0, 0xA7846A8D, 0xFF105F94,
<a name="l00080"></a>00080     0x52B7CCDE, 0x0E33E801, 0x664455EA, 0xF2C70414,
<a name="l00081"></a>00081     0x73E7B486, 0x8F830661, 0x8B59E826, 0xBB8AEDCA,
<a name="l00082"></a>00082     0xF3D70AB9, 0xD739F2B9, 0x4A04C34A, 0x88D0F089,
<a name="l00083"></a>00083     0xE02191A2, 0xD89D9C78, 0x192C2749, 0xFC43A78F,
<a name="l00084"></a>00084     0x0AAC88CB, 0x9438D42D, 0x9E280F7A, 0x36063802,
<a name="l00085"></a>00085     0x38E8D018, 0x1C42A9CB, 0x92AAFF6C, 0xA24820C5,
<a name="l00086"></a>00086     0x007F077F, 0xCE5BC543, 0x69668D58, 0x10D6FF74,
<a name="l00087"></a>00087     0xBE00F621, 0x21300BBE, 0x2E9E8F46, 0x5ACEA629,
<a name="l00088"></a>00088     0xFA1F86C7, 0x52F206B8, 0x3EDF1A75, 0x6DA8D843,
<a name="l00089"></a>00089     0xCF719928, 0x73E3891F, 0xB4B95DD6, 0xB2A42D27,
<a name="l00090"></a>00090     0xEDA20BBF, 0x1A58DBDF, 0xA449AD03, 0x6DDEF22B,
<a name="l00091"></a>00091     0x900531E6, 0x3D3BFF35, 0x5B24ABA2, 0x472B3E4C,
<a name="l00092"></a>00092     0x387F2D75, 0x4D8DBA36, 0x71CB5641, 0xE3473F3F,
<a name="l00093"></a>00093     0xF6CD4B7F, 0xBF7D1428, 0x344B64D0, 0xC5CDFCB6,
<a name="l00094"></a>00094     0xFE2E0182, 0x2C37A673, 0xDE4EB7A3, 0x63FDC933,
<a name="l00095"></a>00095     0x01DC4063, 0x611F3571, 0xD167BFAF, 0x4496596F,
<a name="l00096"></a>00096     0x3DEE0689, 0xD8704910, 0x7052A114, 0x068C9EC5,
<a name="l00097"></a>00097     0x75D0E766, 0x4D54CC20, 0xB44ECDE2, 0x4ABC653E,
<a name="l00098"></a>00098     0x2C550A21, 0x1A52C0DB, 0xCFED03D0, 0x119BAFE2,
<a name="l00099"></a>00099     0x876A6133, 0xBC232088, 0x435BA1B2, 0xAE99BBFA,
<a name="l00100"></a>00100     0xBB4F08E4, 0xA62B5F49, 0x1DA4B695, 0x336B84DE,
<a name="l00101"></a>00101     0xDC813D31, 0x00C134FB, 0x397A98E6, 0x151F0E64,
<a name="l00102"></a>00102     0xD9EB3E69, 0xD3C7DF60, 0xD2F2C336, 0x2DDD067B,
<a name="l00103"></a>00103     0xBD122835, 0xB0B3BD3A, 0xB0D54E46, 0x8641F1E4,
<a name="l00104"></a>00104     0xA0B38F96, 0x51D39199, 0x37A6AD75, 0xDF84EE41,
<a name="l00105"></a>00105     0x3C034CBA, 0xACDA62FC, 0x11923B8B, 0x45EF170A,
<a name="l00106"></a>00106 };
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="keyword">using namespace </span>Ogre;
<a name="l00109"></a>00109 
<a name="l00110"></a><a class="code" href="class_collisions.html#a006630da4b62b10ebf123c6333c2b198">00110</a> <a class="code" href="class_collisions.html#a006630da4b62b10ebf123c6333c2b198">Collisions::Collisions</a>() :
<a name="l00111"></a>00111       collision_count(0)
<a name="l00112"></a>00112     , collision_tris(0)
<a name="l00113"></a>00113     , debugMode(false)
<a name="l00114"></a>00114     , forcecam(false)
<a name="l00115"></a>00115     , free_collision_box(0)
<a name="l00116"></a>00116     , free_collision_tri(0)
<a name="l00117"></a>00117     , free_eventsource(0)
<a name="l00118"></a>00118     , hashmask(0)
<a name="l00119"></a>00119     , landuse(0)
<a name="l00120"></a>00120     , largest_cellcount(0)
<a name="l00121"></a>00121     , last_called_cbox(0)
<a name="l00122"></a>00122     , last_used_ground_model(0)
<a name="l00123"></a>00123     , max_col_tris(MAX_COLLISION_TRIS)
<a name="l00124"></a>00124 {
<a name="l00125"></a>00125     <a class="code" href="class_collisions.html#a622cf0a2757c6b8d0cc72e582d365712">hFinder</a> = <a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#a23825f69e60897a660d18659399e0de2">terrainManager</a>-&gt;<a class="code" href="class_terrain_manager.html#ae63cfc0dda4ab62dc7f6d72eb7845628">getHeightFinder</a>();
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     <a class="code" href="class_collisions.html#ac22cd0e0bf7bc504f7974244801cb175">debugMode</a> = <a class="code" href="_settings_8h.html#af577ee09bf1afff38ddb26d32ce320fb">BSETTING</a>(<span class="stringliteral">&quot;Debug Collisions&quot;</span>, <span class="keyword">false</span>);
<a name="l00128"></a>00128     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="class_collisions.html#a8621492923315e19fc57ac59b54382c8">HASH_POWER</a>; i++)
<a name="l00129"></a>00129     {
<a name="l00130"></a>00130         <a class="code" href="class_collisions.html#a4237ecf9c0d9a71cfae3ec537b8fc4b8">hashmask</a> = <a class="code" href="class_collisions.html#a4237ecf9c0d9a71cfae3ec537b8fc4b8">hashmask</a> &lt;&lt; 1;
<a name="l00131"></a>00131         <a class="code" href="class_collisions.html#a4237ecf9c0d9a71cfae3ec537b8fc4b8">hashmask</a>++;
<a name="l00132"></a>00132     }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="class_collisions.html#a44f5dfebd3fdda32c4a16ca76c71c70c">HASH_SIZE</a>; i++)
<a name="l00135"></a>00135     {
<a name="l00136"></a>00136         <a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[i].<a class="code" href="struct_collisions_1_1hash__t.html#a916ba00d84b1b6ce2da334c203940592">cellid</a> = <a class="code" href="class_collisions.html#af41c143ba3769c60bc0f3526988e584a">UNUSED_CELLID</a>; <span class="comment">// conversion from &#39;const int&#39; to &#39;unsigned int&#39;, signed/unsigned mismatch!</span>
<a name="l00137"></a>00137     }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a> = (<a class="code" href="struct_collisions_1_1collision__tri__t.html">collision_tri_t</a>*)malloc(<span class="keyword">sizeof</span>(<a class="code" href="struct_collisions_1_1collision__tri__t.html">collision_tri_t</a>) * <a class="code" href="class_collisions.html#a4c0335201f7449732767160ffa29e831">MAX_COLLISION_TRIS</a>);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <a class="code" href="class_collisions.html#ab787df47353b8b839cf2187ab61ee514">loadDefaultModels</a>();
<a name="l00142"></a>00142     <a class="code" href="class_collisions.html#aa8d0184cb98d4141bccad32cc50fde1d">defaultgm</a> = <a class="code" href="class_collisions.html#a7840c7d5b2b56b4cc8f41778c0edb7a7">getGroundModelByString</a>(<span class="stringliteral">&quot;concrete&quot;</span>);
<a name="l00143"></a>00143     <a class="code" href="class_collisions.html#ace408979e984d8003d614048445b9d2a">defaultgroundgm</a> = <a class="code" href="class_collisions.html#a7840c7d5b2b56b4cc8f41778c0edb7a7">getGroundModelByString</a>(<span class="stringliteral">&quot;gravel&quot;</span>);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#ac22cd0e0bf7bc504f7974244801cb175">debugMode</a>)
<a name="l00146"></a>00146     {
<a name="l00147"></a>00147         <a class="code" href="class_collisions.html#a071e5015fc25d34315f5a0caf73e9a09">debugmo</a> = <a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#af1dd98dd6dbe5353a6a0b7bd2a2e42ee">sceneManager</a>-&gt;createManualObject();
<a name="l00148"></a>00148         <a class="code" href="class_collisions.html#a071e5015fc25d34315f5a0caf73e9a09">debugmo</a>-&gt;begin(<span class="stringliteral">&quot;tracks/debug/collision/triangle&quot;</span>, RenderOperation::OT_TRIANGLE_LIST);
<a name="l00149"></a>00149     }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     pthread_mutex_init(&amp;<a class="code" href="class_collisions.html#a87ed8396f2a9257fa2e961a48d784f61">scriptcallback_mutex</a>, NULL);
<a name="l00152"></a>00152 }
<a name="l00153"></a>00153 
<a name="l00154"></a><a class="code" href="class_collisions.html#a39a613fd2a130b096c616f74f776d2f9">00154</a> <a class="code" href="class_collisions.html#a39a613fd2a130b096c616f74f776d2f9">Collisions::~Collisions</a>()
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156     pthread_mutex_destroy(&amp;<a class="code" href="class_collisions.html#a87ed8396f2a9257fa2e961a48d784f61">scriptcallback_mutex</a>);
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00159"></a><a class="code" href="class_collisions.html#a21f009772ed183e030db9aa3d2fd6a62">00159</a> <span class="keywordtype">void</span> <a class="code" href="class_collisions.html#a21f009772ed183e030db9aa3d2fd6a62">Collisions::resizeMemory</a>(<span class="keywordtype">long</span> newSize)
<a name="l00160"></a>00160 {
<a name="l00161"></a>00161     <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>)
<a name="l00162"></a>00162     {
<a name="l00163"></a>00163         free(<a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>);
<a name="l00164"></a>00164     }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a> = 0;
<a name="l00167"></a>00167     <a class="code" href="class_collisions.html#aa6a642407632d7270f8864875fa5e46f">max_col_tris</a> = newSize;
<a name="l00168"></a>00168     <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a> = (<a class="code" href="struct_collisions_1_1collision__tri__t.html">collision_tri_t</a>*)malloc(<span class="keyword">sizeof</span>(<a class="code" href="struct_collisions_1_1collision__tri__t.html">collision_tri_t</a>) * newSize);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>==NULL)
<a name="l00171"></a>00171     {
<a name="l00172"></a>00172         <a class="code" href="_ro_r_prerequisites_8h.html#af855c94dc540e943632089ce7496faac">LOG</a>(<span class="stringliteral">&quot;COLL: Failed to allocate &quot;</span> + <a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_collisions_1_1collision__tri__t.html">collision_tri_t</a>) * newSize) + <span class="stringliteral">&quot;bytes of memory&quot;</span>);
<a name="l00173"></a>00173         <span class="keywordflow">if</span> (newSize &gt; <a class="code" href="class_collisions.html#a4c0335201f7449732767160ffa29e831">Collisions::MAX_COLLISION_TRIS</a>)
<a name="l00174"></a>00174         {
<a name="l00175"></a>00175             <span class="comment">// Try to restore the default memory size</span>
<a name="l00176"></a>00176             <a class="code" href="class_collisions.html#a21f009772ed183e030db9aa3d2fd6a62">resizeMemory</a>(<a class="code" href="class_collisions.html#a4c0335201f7449732767160ffa29e831">MAX_COLLISION_TRIS</a>);
<a name="l00177"></a>00177         }
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 
<a name="l00181"></a><a class="code" href="class_collisions.html#ab787df47353b8b839cf2187ab61ee514">00181</a> <span class="keywordtype">int</span> <a class="code" href="class_collisions.html#ab787df47353b8b839cf2187ab61ee514">Collisions::loadDefaultModels</a>()
<a name="l00182"></a>00182 {
<a name="l00183"></a>00183     <span class="keywordflow">return</span> <a class="code" href="class_collisions.html#a3f2acd0249632458dd92a551210f83a1">loadGroundModelsConfigFile</a>(<a class="code" href="_settings_8h.html#a59d79e9512ab19f4eb8a322f1e32dc11">SSETTING</a>(<span class="stringliteral">&quot;Config Root&quot;</span>, <span class="stringliteral">&quot;config\\&quot;</span>)+<span class="stringliteral">&quot;ground_models.cfg&quot;</span>);
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00186"></a><a class="code" href="class_collisions.html#a3f2acd0249632458dd92a551210f83a1">00186</a> <span class="keywordtype">int</span> <a class="code" href="class_collisions.html#a3f2acd0249632458dd92a551210f83a1">Collisions::loadGroundModelsConfigFile</a>(Ogre::String filename)
<a name="l00187"></a>00187 {
<a name="l00188"></a>00188     String group = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00189"></a>00189     <span class="keywordflow">try</span>
<a name="l00190"></a>00190     {
<a name="l00191"></a>00191         group = ResourceGroupManager::getSingleton().findGroupContainingResource(filename);
<a name="l00192"></a>00192     }<span class="keywordflow">catch</span>(...)
<a name="l00193"></a>00193     {
<a name="l00194"></a>00194         <span class="comment">// we wont catch anything, since the path could be absolute as well, then the group is not found</span>
<a name="l00195"></a>00195     }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     Ogre::ConfigFile cfg;
<a name="l00198"></a>00198     <span class="keywordflow">try</span>
<a name="l00199"></a>00199     {
<a name="l00200"></a>00200         <span class="comment">// try to load directly otherwise via resource group</span>
<a name="l00201"></a>00201         <span class="keywordflow">if</span> (group == <span class="stringliteral">&quot;&quot;</span>)
<a name="l00202"></a>00202             cfg.loadDirect(filename);
<a name="l00203"></a>00203         <span class="keywordflow">else</span>
<a name="l00204"></a>00204             cfg.loadFromResourceSystem(filename, group, <span class="stringliteral">&quot;\x09:=&quot;</span>, <span class="keyword">true</span>);
<a name="l00205"></a>00205     } <span class="keywordflow">catch</span>(Ogre::Exception&amp; e)
<a name="l00206"></a>00206     {
<a name="l00207"></a>00207         <a class="code" href="struct_error_utils.html#aec73b03c7829838888bbecf9acda1b98">ErrorUtils::ShowError</a>(<span class="stringliteral">&quot;Error while loading ground model&quot;</span>, e.getFullDescription());
<a name="l00208"></a>00208         <span class="keywordflow">return</span> 1;
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="comment">// parse the whole config</span>
<a name="l00212"></a>00212     <a class="code" href="class_collisions.html#aaa893c509f9b9b77459d50e3bef2c6ff">parseGroundConfig</a>(&amp;cfg);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="comment">// after it was parsed, resolve the dependencies</span>
<a name="l00215"></a>00215     std::map&lt;Ogre::String, ground_model_t&gt;::iterator it;
<a name="l00216"></a>00216     <span class="keywordflow">for</span> (it=<a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>.begin(); it!=<a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>.end(); it++)
<a name="l00217"></a>00217     {
<a name="l00218"></a>00218         <span class="keywordflow">if</span> (!it-&gt;second.basename) <span class="keywordflow">continue</span>; <span class="comment">// no base, normal material</span>
<a name="l00219"></a>00219         String bname = String(it-&gt;second.basename);
<a name="l00220"></a>00220         <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>.find(bname) == <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>.end()) <span class="keywordflow">continue</span>; <span class="comment">// base not found!</span>
<a name="l00221"></a>00221         <span class="comment">// copy the values from the base if not set otherwise</span>
<a name="l00222"></a>00222         <a class="code" href="structground__model__t.html">ground_model_t</a> *thisgm = &amp;(it-&gt;second);
<a name="l00223"></a>00223         <a class="code" href="structground__model__t.html">ground_model_t</a> *basegm = &amp;<a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[bname];
<a name="l00224"></a>00224         memcpy(thisgm, basegm, <span class="keyword">sizeof</span>(<a class="code" href="structground__model__t.html">ground_model_t</a>));
<a name="l00225"></a>00225         <span class="comment">// re-set the name</span>
<a name="l00226"></a>00226         strncpy(thisgm-&gt;<a class="code" href="structground__model__t.html#afea47c52a768b30dbd001cd0fd98f67e">name</a>, it-&gt;first.c_str(), 255);
<a name="l00227"></a>00227         <span class="comment">// after that we need to reload the config to overwrite settings of the base</span>
<a name="l00228"></a>00228         <a class="code" href="class_collisions.html#aaa893c509f9b9b77459d50e3bef2c6ff">parseGroundConfig</a>(&amp;cfg, it-&gt;first);
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230     <span class="comment">// check the version</span>
<a name="l00231"></a>00231     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_collisions.html#ad170e9c43e65adb7095a1b4b9e5cd5be">collision_version</a> != <a class="code" href="class_collisions.html#a618450e73c631222e3710673ce2f215e">LATEST_GROUND_MODEL_VERSION</a>)
<a name="l00232"></a>00232     {
<a name="l00233"></a>00233         <span class="comment">// message box</span>
<a name="l00234"></a>00234         String url = <span class="stringliteral">&quot;http://wiki.rigsofrods.com/index.php?title=Error_Old_ground_model#&quot;</span>+<a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(this-&gt;<a class="code" href="class_collisions.html#ad170e9c43e65adb7095a1b4b9e5cd5be">collision_version</a>)+<span class="stringliteral">&quot;to&quot;</span>+<a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(<a class="code" href="class_collisions.html#a618450e73c631222e3710673ce2f215e">LATEST_GROUND_MODEL_VERSION</a>);
<a name="l00235"></a>00235         <a class="code" href="struct_error_utils.html#a5877046712b57723ec40772afd980378">ErrorUtils::ShowOgreWebError</a>(<a class="code" href="_error_utils_8cpp.html#a23b3808d12342e40e7459e77fccb85b6">_L</a>(<span class="stringliteral">&quot;Configuration error&quot;</span>), <a class="code" href="_error_utils_8cpp.html#a23b3808d12342e40e7459e77fccb85b6">_L</a>(<span class="stringliteral">&quot;Your ground configuration is too old, please copy skeleton/config/ground_models.cfg to My Documents/Rigs of Rods/config&quot;</span>), url);
<a name="l00236"></a>00236         <a class="code" href="struct_error_utils.html#a456df0e866bb9548a583476db551ca09">ErrorUtils::ShowStoredOgreWebErrors</a>();
<a name="l00237"></a>00237         <a class="code" href="namespace_profiler.html#af79bb59414ef3ba134213bb6f2f2d292">exit</a>(124);
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239     <span class="keywordflow">return</span> 0;
<a name="l00240"></a>00240 }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 
<a name="l00243"></a><a class="code" href="class_collisions.html#aaa893c509f9b9b77459d50e3bef2c6ff">00243</a> <span class="keywordtype">void</span> <a class="code" href="class_collisions.html#aaa893c509f9b9b77459d50e3bef2c6ff">Collisions::parseGroundConfig</a>(Ogre::ConfigFile *cfg, String groundModel)
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245     Ogre::ConfigFile::SectionIterator seci = cfg-&gt;getSectionIterator();
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     Ogre::String secName, kname, kvalue;
<a name="l00248"></a>00248     <span class="keywordflow">while</span> (seci.hasMoreElements())
<a name="l00249"></a>00249     {
<a name="l00250"></a>00250         secName = seci.peekNextKey();
<a name="l00251"></a>00251         Ogre::ConfigFile::SettingsMultiMap *<a class="code" href="_configurator_8cpp.html#a59fefa40487f3cfafe5755942393375b">settings</a> = seci.getNext();
<a name="l00252"></a>00252 
<a name="l00253"></a>00253         <span class="keywordflow">if</span> (!groundModel.empty() &amp;&amp; secName != groundModel) <span class="keywordflow">continue</span>;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255         Ogre::ConfigFile::SettingsMultiMap::iterator i;
<a name="l00256"></a>00256         <span class="keywordflow">for</span> (i = settings-&gt;begin(); i != settings-&gt;end(); ++i)
<a name="l00257"></a>00257         {
<a name="l00258"></a>00258             kname = i-&gt;first;
<a name="l00259"></a>00259             kvalue = i-&gt;second;
<a name="l00260"></a>00260             <span class="comment">// we got all the data available now, processing now</span>
<a name="l00261"></a>00261             <span class="keywordflow">if</span> (secName == <span class="stringliteral">&quot;general&quot;</span> || secName == <span class="stringliteral">&quot;config&quot;</span>)
<a name="l00262"></a>00262             {
<a name="l00263"></a>00263                 <span class="comment">// set some class properties accoring to the information in this section</span>
<a name="l00264"></a>00264                 <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;version&quot;</span>) this-&gt;<a class="code" href="class_collisions.html#ad170e9c43e65adb7095a1b4b9e5cd5be">collision_version</a> = <a class="code" href="scriptstdstring_8cpp.html#ab33d705eee9afd65e8991f82d9c71fe3">StringConverter::parseInt</a>(kvalue);
<a name="l00265"></a>00265             } <span class="keywordflow">else</span>
<a name="l00266"></a>00266             {
<a name="l00267"></a>00267                 <span class="comment">// we assume that all other sections are separate ground types!</span>
<a name="l00268"></a>00268                 <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>.find(secName) == <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>.end())
<a name="l00269"></a>00269                 {
<a name="l00270"></a>00270                     <span class="comment">// ground models not known yet, init it!</span>
<a name="l00271"></a>00271                     <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName] = <a class="code" href="structground__model__t.html">ground_model_t</a>();
<a name="l00272"></a>00272                     <span class="comment">// clear it</span>
<a name="l00273"></a>00273                     memset(&amp;<a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName], 0, <span class="keyword">sizeof</span>(<a class="code" href="structground__model__t.html">ground_model_t</a>));
<a name="l00274"></a>00274                     <span class="comment">// set some default values</span>
<a name="l00275"></a>00275                     <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].alpha = 2.0f;
<a name="l00276"></a>00276                     <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].strength = 1.0f;
<a name="l00277"></a>00277                     <span class="comment">// some fx defaults</span>
<a name="l00278"></a>00278                     <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_amount = 20;
<a name="l00279"></a>00279                     <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_min_velo = 5;
<a name="l00280"></a>00280                     <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_max_velo = 99999;
<a name="l00281"></a>00281                     <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_velo_factor = 0.7f;
<a name="l00282"></a>00282                     <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_fade = -1;
<a name="l00283"></a>00283                     <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_timedelta = 1;
<a name="l00284"></a>00284                     <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_ttl = 2;
<a name="l00285"></a>00285                     strncpy(<a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].name, secName.c_str(), 255);
<a name="l00286"></a>00286 
<a name="l00287"></a>00287                 }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289                 <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;adhesion velocity&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].va = StringConverter::parseReal(kvalue);
<a name="l00290"></a>00290                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;static friction coefficient&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].ms = StringConverter::parseReal(kvalue);
<a name="l00291"></a>00291                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;sliding friction coefficient&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].mc = StringConverter::parseReal(kvalue);
<a name="l00292"></a>00292                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;hydrodynamic friction&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].t2 = StringConverter::parseReal(kvalue);
<a name="l00293"></a>00293                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;stribeck velocity&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].vs = StringConverter::parseReal(kvalue);
<a name="l00294"></a>00294                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;alpha&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].alpha = StringConverter::parseReal(kvalue);
<a name="l00295"></a>00295                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;strength&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].strength = StringConverter::parseReal(kvalue);
<a name="l00296"></a>00296                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;base&quot;</span>) strncpy(<a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].basename, kvalue.c_str(), 255);
<a name="l00297"></a>00297                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;fx_type&quot;</span>)
<a name="l00298"></a>00298                 {
<a name="l00299"></a>00299                     <span class="keywordflow">if</span> (kvalue == <span class="stringliteral">&quot;PARTICLE&quot;</span>)
<a name="l00300"></a>00300                         <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_type = <a class="code" href="class_collisions.html#abc67d9eaedcf832c061f5925bdae7964a42160375b24354ceaa106b5e2c1cb263">FX_PARTICLE</a>;
<a name="l00301"></a>00301                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kvalue == <span class="stringliteral">&quot;HARD&quot;</span>)
<a name="l00302"></a>00302                         <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_type = <a class="code" href="class_collisions.html#abc67d9eaedcf832c061f5925bdae7964a0f5d1f2e514c983bc896b8e3a163c1fd">FX_HARD</a>;
<a name="l00303"></a>00303                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kvalue == <span class="stringliteral">&quot;DUSTY&quot;</span>)
<a name="l00304"></a>00304                         <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_type = <a class="code" href="class_collisions.html#abc67d9eaedcf832c061f5925bdae7964ae4e1f5c321d124ba62e63e9e2294d4d4">FX_DUSTY</a>;
<a name="l00305"></a>00305                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kvalue == <span class="stringliteral">&quot;CLUMPY&quot;</span>)
<a name="l00306"></a>00306                         <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_type = <a class="code" href="class_collisions.html#abc67d9eaedcf832c061f5925bdae7964ad63920e8d3da864a3421380e5fbe7579">FX_CLUMPY</a>;
<a name="l00307"></a>00307                 }
<a name="l00308"></a>00308                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;fx_particle_name&quot;</span>) strncpy(<a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].particle_name, kvalue.c_str(), 255);
<a name="l00309"></a>00309                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;fx_colour&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_colour = StringConverter::parseColourValue(kvalue);
<a name="l00310"></a>00310                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;fx_particle_amount&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_amount = <a class="code" href="scriptstdstring_8cpp.html#ab33d705eee9afd65e8991f82d9c71fe3">StringConverter::parseInt</a>(kvalue);
<a name="l00311"></a>00311                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;fx_particle_min_velo&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_min_velo = StringConverter::parseReal(kvalue);
<a name="l00312"></a>00312                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;fx_particle_max_velo&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_max_velo = StringConverter::parseReal(kvalue);
<a name="l00313"></a>00313                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;fx_particle_fade&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_fade = StringConverter::parseReal(kvalue);
<a name="l00314"></a>00314                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;fx_particle_timedelta&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_timedelta = StringConverter::parseReal(kvalue);
<a name="l00315"></a>00315                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;fx_particle_velo_factor&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_velo_factor = StringConverter::parseReal(kvalue);
<a name="l00316"></a>00316                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;fx_particle_ttl&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fx_particle_ttl = StringConverter::parseReal(kvalue);
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 
<a name="l00319"></a>00319                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;fluid density&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].fluid_density = StringConverter::parseReal(kvalue);
<a name="l00320"></a>00320                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;flow consistency index&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].flow_consistency_index = StringConverter::parseReal(kvalue);
<a name="l00321"></a>00321                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;flow behavior index&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].flow_behavior_index = StringConverter::parseReal(kvalue);
<a name="l00322"></a>00322                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;solid ground level&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].solid_ground_level = StringConverter::parseReal(kvalue);
<a name="l00323"></a>00323                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kname == <span class="stringliteral">&quot;drag anisotropy&quot;</span>) <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[secName].drag_anisotropy = StringConverter::parseReal(kvalue);
<a name="l00324"></a>00324 
<a name="l00325"></a>00325             }
<a name="l00326"></a>00326         }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         <span class="keywordflow">if</span> (!groundModel.empty()) <span class="keywordflow">break</span>; <span class="comment">// we dont need to go through the other sections</span>
<a name="l00329"></a>00329     }
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a><a class="code" href="class_collisions.html#accb10540c3aa849f57b7fd3b9da2e1c6">00332</a> Ogre::Vector3 <a class="code" href="class_collisions.html#accb10540c3aa849f57b7fd3b9da2e1c6">Collisions::calcCollidedSide</a>(<span class="keyword">const</span> Ogre::Vector3&amp; pos, <span class="keyword">const</span> Ogre::Vector3&amp; lo, <span class="keyword">const</span> Ogre::Vector3&amp; hi)
<a name="l00333"></a>00333 {   
<a name="l00334"></a>00334     Ogre::Real min = pos.x - lo.x;
<a name="l00335"></a>00335     Ogre::Vector3 newPos = Ogre::Vector3(lo.x, pos.y, pos.z);
<a name="l00336"></a>00336     
<a name="l00337"></a>00337     Ogre::Real t = pos.y - lo.y;
<a name="l00338"></a>00338     <span class="keywordflow">if</span> (t &lt; min) {
<a name="l00339"></a>00339         min=t;
<a name="l00340"></a>00340         newPos = Ogre::Vector3(pos.x, lo.y, pos.z);
<a name="l00341"></a>00341     }
<a name="l00342"></a>00342     
<a name="l00343"></a>00343     t = pos.z - lo.z;
<a name="l00344"></a>00344     <span class="keywordflow">if</span> (t &lt; min) {
<a name="l00345"></a>00345         min=t;
<a name="l00346"></a>00346         newPos = Ogre::Vector3(pos.x, pos.y, lo.z);
<a name="l00347"></a>00347     }
<a name="l00348"></a>00348     
<a name="l00349"></a>00349     t = hi.x - pos.x;
<a name="l00350"></a>00350     <span class="keywordflow">if</span> (t &lt; min) {
<a name="l00351"></a>00351         min=t;
<a name="l00352"></a>00352         newPos = Ogre::Vector3(hi.x, pos.y, pos.z);
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354     
<a name="l00355"></a>00355     t = hi.y - pos.y;
<a name="l00356"></a>00356     <span class="keywordflow">if</span> (t &lt; min) {
<a name="l00357"></a>00357         min=t;
<a name="l00358"></a>00358         newPos = Ogre::Vector3(pos.x, hi.y, pos.z);
<a name="l00359"></a>00359     }
<a name="l00360"></a>00360     
<a name="l00361"></a>00361     t = hi.z - pos.z;
<a name="l00362"></a>00362     <span class="keywordflow">if</span> (t &lt; min) {
<a name="l00363"></a>00363         min=t;
<a name="l00364"></a>00364         newPos = Ogre::Vector3(pos.x, pos.y, hi.z);
<a name="l00365"></a>00365     }
<a name="l00366"></a>00366     
<a name="l00367"></a>00367     <span class="keywordflow">return</span> newPos;
<a name="l00368"></a>00368 }
<a name="l00369"></a>00369 
<a name="l00370"></a><a class="code" href="class_collisions.html#ab17c7108653b2c5391aa8590f7eaa518">00370</a> <span class="keywordtype">void</span> <a class="code" href="class_collisions.html#ab17c7108653b2c5391aa8590f7eaa518">Collisions::setupLandUse</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *configfile)
<a name="l00371"></a>00371 {
<a name="l00372"></a>00372 <span class="preprocessor">#ifdef USE_PAGED</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#ad3329ede724eac28a8e260ed8f801590">landuse</a>) <span class="keywordflow">return</span>;
<a name="l00374"></a>00374     <a class="code" href="class_collisions.html#ad3329ede724eac28a8e260ed8f801590">landuse</a> = <span class="keyword">new</span> <a class="code" href="class_landusemap.html">Landusemap</a>(configfile);
<a name="l00375"></a>00375 <span class="preprocessor">#else</span>
<a name="l00376"></a>00376 <span class="preprocessor"></span>    <a class="code" href="_ro_r_prerequisites_8h.html#af855c94dc540e943632089ce7496faac">LOG</a>(<span class="stringliteral">&quot;RoR was not compiled with PagedGeometry support. You cannot use Landuse maps with it.&quot;</span>);
<a name="l00377"></a>00377 <span class="preprocessor">#endif //USE_PAGED</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span>}
<a name="l00379"></a>00379 
<a name="l00380"></a><a class="code" href="class_collisions.html#a7840c7d5b2b56b4cc8f41778c0edb7a7">00380</a> <a class="code" href="structground__model__t.html">ground_model_t</a> *<a class="code" href="class_collisions.html#a7840c7d5b2b56b4cc8f41778c0edb7a7">Collisions::getGroundModelByString</a>(<span class="keyword">const</span> String name)
<a name="l00381"></a>00381 {
<a name="l00382"></a>00382     <span class="keywordflow">if</span> (!<a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>.size() || <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>.find(name) == <a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>.end())
<a name="l00383"></a>00383         <span class="keywordflow">return</span> 0;
<a name="l00384"></a>00384 
<a name="l00385"></a>00385     <span class="keywordflow">return</span> &amp;<a class="code" href="class_collisions.html#ae7c76837b4b6e7437687c0c8c8dd1b9f">ground_models</a>[name];
<a name="l00386"></a>00386 }
<a name="l00387"></a>00387 
<a name="l00388"></a><a class="code" href="class_collisions.html#a7e21c069d16d661d211d0cb896577edf">00388</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="class_collisions.html#a7e21c069d16d661d211d0cb896577edf">Collisions::hashfunc</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cellid)
<a name="l00389"></a>00389 {
<a name="l00390"></a>00390     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hash = 0;
<a name="l00391"></a>00391     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; 4; i++)
<a name="l00392"></a>00392     {
<a name="l00393"></a>00393         hash ^= <a class="code" href="_collisions_8cpp.html#ad4a184f987800468b1178cfc1a286a51">sbox</a>[((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;cellid)[i]];
<a name="l00394"></a>00394         hash *= 3;
<a name="l00395"></a>00395     }
<a name="l00396"></a>00396     <span class="keywordflow">return</span> hash&amp;<a class="code" href="class_collisions.html#a4237ecf9c0d9a71cfae3ec537b8fc4b8">hashmask</a>;
<a name="l00397"></a>00397 }
<a name="l00398"></a>00398 
<a name="l00399"></a><a class="code" href="class_collisions.html#ac9796300989b7f75868f6b4707f4dec0">00399</a> <span class="keywordtype">int</span> <a class="code" href="class_collisions.html#ac9796300989b7f75868f6b4707f4dec0">Collisions::removeCollisionTri</a>(<span class="keywordtype">int</span> number)
<a name="l00400"></a>00400 {
<a name="l00401"></a>00401     <span class="keywordflow">if</span> (number &gt; <a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>) <span class="keywordflow">return</span> -1;
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     <a class="code" href="struct_vector3.html">Vector3</a> p1 = <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[number].<a class="code" href="struct_collisions_1_1collision__tri__t.html#a44309866094911fd5a0c0733a5fe6288">a</a>;
<a name="l00404"></a>00404     <a class="code" href="struct_vector3.html">Vector3</a> p2 = <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[number].<a class="code" href="struct_collisions_1_1collision__tri__t.html#ab1273374d5fda34e5bcf6615becb0d83">b</a>;
<a name="l00405"></a>00405     <a class="code" href="struct_vector3.html">Vector3</a> p3 = <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[number].<a class="code" href="struct_collisions_1_1collision__tri__t.html#a054ab156cb2a95d68c28969c411204d1">c</a>;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407     <span class="comment">// compute tri AAB</span>
<a name="l00408"></a>00408     AxisAlignedBox aab;
<a name="l00409"></a>00409     aab.merge(p1);
<a name="l00410"></a>00410     aab.merge(p2);
<a name="l00411"></a>00411     aab.merge(p3);
<a name="l00412"></a>00412     <span class="comment">// register this collision tri in the index</span>
<a name="l00413"></a>00413     <span class="keywordtype">int</span> ilox, ihix, iloz, ihiz;
<a name="l00414"></a>00414     ilox=(int)(aab.getMinimum().x/(float)<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>);
<a name="l00415"></a>00415     <span class="keywordflow">if</span> (ilox&lt;0) ilox=0; <span class="keywordflow">if</span> (ilox&gt;<a class="code" href="class_collisions.html#acc03c83e0628bfd4804c5451583f7426">MAXIMUM_CELL</a>) ilox=<a class="code" href="class_collisions.html#acc03c83e0628bfd4804c5451583f7426">MAXIMUM_CELL</a>;
<a name="l00416"></a>00416     ihix=(int)(aab.getMaximum().x/(float)<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>);
<a name="l00417"></a>00417     <span class="keywordflow">if</span> (ihix&lt;0) ihix=0; <span class="keywordflow">if</span> (ihix&gt;<a class="code" href="class_collisions.html#acc03c83e0628bfd4804c5451583f7426">MAXIMUM_CELL</a>) ihix=<a class="code" href="class_collisions.html#acc03c83e0628bfd4804c5451583f7426">MAXIMUM_CELL</a>;
<a name="l00418"></a>00418     iloz=(int)(aab.getMinimum().z/(float)<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>);
<a name="l00419"></a>00419     <span class="keywordflow">if</span> (iloz&lt;0) iloz=0; <span class="keywordflow">if</span> (iloz&gt;<a class="code" href="class_collisions.html#acc03c83e0628bfd4804c5451583f7426">MAXIMUM_CELL</a>) iloz=<a class="code" href="class_collisions.html#acc03c83e0628bfd4804c5451583f7426">MAXIMUM_CELL</a>;
<a name="l00420"></a>00420     ihiz=(int)(aab.getMaximum().z/(float)<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>);
<a name="l00421"></a>00421     <span class="keywordflow">if</span> (ihiz&lt;0) ihiz=0; <span class="keywordflow">if</span> (ihiz&gt;<a class="code" href="class_collisions.html#acc03c83e0628bfd4804c5451583f7426">MAXIMUM_CELL</a>) ihiz=<a class="code" href="class_collisions.html#acc03c83e0628bfd4804c5451583f7426">MAXIMUM_CELL</a>;
<a name="l00422"></a>00422     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=ilox; i &lt;= ihix; i++)
<a name="l00423"></a>00423     {
<a name="l00424"></a>00424         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=iloz; j &lt;= ihiz; j++)
<a name="l00425"></a>00425         {
<a name="l00426"></a>00426             <a class="code" href="class_collisions.html#a5daaefbf4b30949f1d68ba5ae38d9b9b">hash_free</a>(i,j,number+<a class="code" href="class_collisions.html#afee2a1122b17c9daec024a08a86c5ebe">MAX_COLLISION_BOXES</a>);
<a name="l00427"></a>00427         }
<a name="l00428"></a>00428     }
<a name="l00429"></a>00429     <span class="keywordflow">return</span> 0;
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 
<a name="l00432"></a><a class="code" href="class_collisions.html#a5daaefbf4b30949f1d68ba5ae38d9b9b">00432</a> <span class="keywordtype">void</span> <a class="code" href="class_collisions.html#a5daaefbf4b30949f1d68ba5ae38d9b9b">Collisions::hash_free</a>(<span class="keywordtype">int</span> cell_x, <span class="keywordtype">int</span> cell_z, <span class="keywordtype">int</span> value)
<a name="l00433"></a>00433 {
<a name="l00434"></a>00434     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cellid = (cell_x &lt;&lt; 16) + cell_z;
<a name="l00435"></a>00435     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos    = <a class="code" href="class_collisions.html#a7e21c069d16d661d211d0cb896577edf">hashfunc</a>(cellid);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437     <span class="comment">// set cell to free state</span>
<a name="l00438"></a>00438     <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[pos].cellid != <a class="code" href="class_collisions.html#af41c143ba3769c60bc0f3526988e584a">UNUSED_CELLID</a>)
<a name="l00439"></a>00439     {
<a name="l00440"></a>00440         <a class="code" href="_collisions_8h.html#aca38c9e35e209557ac5566b0f445696d">cell_t</a> *cell = <a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[pos].<a class="code" href="struct_collisions_1_1hash__t.html#a9094c3e7ca154a4a3c7542e9e05ce9a2">cell</a>;
<a name="l00441"></a>00441         <span class="comment">// cell has content, search it</span>
<a name="l00442"></a>00442         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i &lt; cell-&gt;size(); i++)
<a name="l00443"></a>00443         {
<a name="l00444"></a>00444             <span class="keywordflow">if</span> ((*cell)[i] == value)
<a name="l00445"></a>00445             {
<a name="l00446"></a>00446                 <span class="comment">// remove that element</span>
<a name="l00447"></a>00447                 cell-&gt;erase(cell-&gt;begin() + i);
<a name="l00448"></a>00448                 <span class="keywordflow">break</span>;
<a name="l00449"></a>00449             }
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452 }
<a name="l00453"></a>00453 
<a name="l00454"></a><a class="code" href="class_collisions.html#ab8dc3b86fee4e2aa47927bfeabe2ddfe">00454</a> <span class="keywordtype">void</span> <a class="code" href="class_collisions.html#ab8dc3b86fee4e2aa47927bfeabe2ddfe">Collisions::hash_add</a>(<span class="keywordtype">int</span> cell_x, <span class="keywordtype">int</span> cell_z, <span class="keywordtype">int</span> value)
<a name="l00455"></a>00455 {
<a name="l00456"></a>00456     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cellid = (cell_x &lt;&lt; 16) + cell_z;
<a name="l00457"></a>00457     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos    = <a class="code" href="class_collisions.html#a7e21c069d16d661d211d0cb896577edf">hashfunc</a>(cellid);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     <span class="comment">// Cycle through hashtable: start at pos</span>
<a name="l00460"></a>00460     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="class_collisions.html#a44f5dfebd3fdda32c4a16ca76c71c70c">HASH_SIZE</a>; i++)
<a name="l00461"></a>00461     {
<a name="l00462"></a>00462         <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[pos].cellid == <a class="code" href="class_collisions.html#af41c143ba3769c60bc0f3526988e584a">UNUSED_CELLID</a> || <a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[pos].cellid == cellid)
<a name="l00463"></a>00463             <span class="keywordflow">break</span>;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465         pos++;
<a name="l00466"></a>00466         <span class="keywordflow">if</span> (pos &gt;= HASH_SIZE) pos = 0;
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469     <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[pos].cellid == <a class="code" href="class_collisions.html#af41c143ba3769c60bc0f3526988e584a">UNUSED_CELLID</a>)
<a name="l00470"></a>00470     {
<a name="l00471"></a>00471         <span class="comment">// create a new cell</span>
<a name="l00472"></a>00472         <a class="code" href="_collisions_8h.html#aca38c9e35e209557ac5566b0f445696d">cell_t</a>* newcell = <span class="keyword">new</span> <a class="code" href="_collisions_8h.html#aca38c9e35e209557ac5566b0f445696d">cell_t</a>;
<a name="l00473"></a>00473         
<a name="l00474"></a>00474         <a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[pos].<a class="code" href="struct_collisions_1_1hash__t.html#a916ba00d84b1b6ce2da334c203940592">cellid</a> = cellid;
<a name="l00475"></a>00475         <a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[pos].<a class="code" href="struct_collisions_1_1hash__t.html#a9094c3e7ca154a4a3c7542e9e05ce9a2">cell</a> = newcell;
<a name="l00476"></a>00476         newcell-&gt;push_back(value);
<a name="l00477"></a>00477         <a class="code" href="class_collisions.html#aecc9b19321fbf9163a606ba73f89f746">cells</a>.push_back(newcell);
<a name="l00478"></a>00478         <span class="keywordflow">if</span> (pos != <a class="code" href="class_collisions.html#a7e21c069d16d661d211d0cb896577edf">hashfunc</a>(cellid))
<a name="l00479"></a>00479         {
<a name="l00480"></a>00480             <a class="code" href="class_collisions.html#a87d5b05b8cf46f4a40dd5f39dd295f44">collision_count</a>++;
<a name="l00481"></a>00481         }
<a name="l00482"></a>00482         <a class="code" href="class_collisions.html#a2fc69b5019b2fcc216940f804b4b6f50">largest_cellcount</a> = std::max(<a class="code" href="class_collisions.html#a2fc69b5019b2fcc216940f804b4b6f50">largest_cellcount</a>, (<span class="keywordtype">int</span>)newcell-&gt;size());
<a name="l00483"></a>00483     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[pos].cellid == cellid)
<a name="l00484"></a>00484     {
<a name="l00485"></a>00485         <span class="comment">// there is already a cell ready</span>
<a name="l00486"></a>00486         <a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[pos].<a class="code" href="struct_collisions_1_1hash__t.html#a9094c3e7ca154a4a3c7542e9e05ce9a2">cell</a>-&gt;push_back(value);
<a name="l00487"></a>00487         <a class="code" href="class_collisions.html#a2fc69b5019b2fcc216940f804b4b6f50">largest_cellcount</a> = std::max(<a class="code" href="class_collisions.html#a2fc69b5019b2fcc216940f804b4b6f50">largest_cellcount</a>, (<span class="keywordtype">int</span>)<a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[pos].cell-&gt;size());
<a name="l00488"></a>00488     } <span class="keywordflow">else</span>
<a name="l00489"></a>00489     {
<a name="l00490"></a>00490         <a class="code" href="_ro_r_prerequisites_8h.html#af855c94dc540e943632089ce7496faac">LOG</a>(<span class="stringliteral">&quot;COLL: The hashtable is full.&quot;</span>);
<a name="l00491"></a>00491     }
<a name="l00492"></a>00492 }
<a name="l00493"></a>00493 
<a name="l00494"></a><a class="code" href="class_collisions.html#a4d438eb211fe0953343dc39f478e14e0">00494</a> <a class="code" href="_collisions_8h.html#aca38c9e35e209557ac5566b0f445696d">cell_t</a> *<a class="code" href="class_collisions.html#a4d438eb211fe0953343dc39f478e14e0">Collisions::hash_find</a>(<span class="keywordtype">int</span> cell_x, <span class="keywordtype">int</span> cell_z)
<a name="l00495"></a>00495 {
<a name="l00496"></a>00496     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cellid = (cell_x &lt;&lt; 16) + cell_z;
<a name="l00497"></a>00497     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos    = <a class="code" href="class_collisions.html#a7e21c069d16d661d211d0cb896577edf">hashfunc</a>(cellid);
<a name="l00498"></a>00498 
<a name="l00499"></a>00499     <span class="comment">// Cycle through hashtable: start at pos</span>
<a name="l00500"></a>00500     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="class_collisions.html#a44f5dfebd3fdda32c4a16ca76c71c70c">HASH_SIZE</a>; i++)
<a name="l00501"></a>00501     {
<a name="l00502"></a>00502         <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[pos].cellid == <a class="code" href="class_collisions.html#af41c143ba3769c60bc0f3526988e584a">UNUSED_CELLID</a>)
<a name="l00503"></a>00503             <span class="keywordflow">return</span> NULL;
<a name="l00504"></a>00504 
<a name="l00505"></a>00505         <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[pos].cellid == cellid)
<a name="l00506"></a>00506             <span class="keywordflow">return</span> <a class="code" href="class_collisions.html#a21a9cdad27076c67c4708a16f038bf39">hashtable</a>[pos].<a class="code" href="struct_collisions_1_1hash__t.html#a9094c3e7ca154a4a3c7542e9e05ce9a2">cell</a>;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508         pos++;
<a name="l00509"></a>00509         <span class="keywordflow">if</span> (pos &gt;= HASH_SIZE) pos = 0;
<a name="l00510"></a>00510     }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512     <span class="keywordflow">return</span> NULL;
<a name="l00513"></a>00513 }
<a name="l00514"></a>00514 
<a name="l00515"></a><a class="code" href="class_collisions.html#a50cf1fc86be3b7e69b687256f6d5d1f3">00515</a> <span class="keywordtype">int</span> <a class="code" href="class_collisions.html#a50cf1fc86be3b7e69b687256f6d5d1f3">Collisions::addCollisionBox</a>(SceneNode *tenode, <span class="keywordtype">bool</span> rotating, <span class="keywordtype">bool</span> virt, <a class="code" href="struct_vector3.html">Vector3</a> pos, Ogre::Vector3 rot, Ogre::Vector3 l, Ogre::Vector3 h, Ogre::Vector3 sr, <span class="keyword">const</span> Ogre::String &amp;eventname, <span class="keyword">const</span> Ogre::String &amp;instancename, <span class="keywordtype">bool</span> forcecam, Ogre::Vector3 campos, Ogre::Vector3 sc <span class="comment">/* = Vector3::UNIT_SCALE */</span>, Ogre::Vector3 dr <span class="comment">/* = Vector3::ZERO */</span>, <span class="keywordtype">int</span> event_filter <span class="comment">/* = EVENT_ALL */</span>, <span class="keywordtype">int</span> scripthandler <span class="comment">/* = -1 */</span>)
<a name="l00516"></a>00516 {
<a name="l00517"></a>00517     Quaternion rotation  = Quaternion(Degree(rot.x), Vector3::UNIT_X) * Quaternion(Degree(rot.y), Vector3::UNIT_Y) * Quaternion(Degree(rot.z), Vector3::UNIT_Z);
<a name="l00518"></a>00518     Quaternion direction = Quaternion(Degree(dr.x), Vector3::UNIT_X) * Quaternion(Degree(dr.y), Vector3::UNIT_Y) * Quaternion(Degree(dr.z), Vector3::UNIT_Z);
<a name="l00519"></a>00519     <a class="code" href="structcollision__box__t.html">collision_box_t</a>&amp; coll_box = <a class="code" href="class_collisions.html#a1792d7c6e15ade78504de1f7ae88f11a">collision_boxes</a>[<a class="code" href="class_collisions.html#a98767788cb04680d636588eb567cc34e">free_collision_box</a>];
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     coll_box.<a class="code" href="structcollision__box__t.html#a6497936ab1181364758f995eb3ac91a2">enabled</a> = <span class="keyword">true</span>;
<a name="l00522"></a>00522     
<a name="l00523"></a>00523     <span class="comment">// set refined box anyway</span>
<a name="l00524"></a>00524     coll_box.<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a> = l*sc;
<a name="l00525"></a>00525     coll_box.<a class="code" href="structcollision__box__t.html#a6e337e38343e67297b6b82179fe7da6b" title="relative collision box">rehi</a> = h*sc;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="comment">// calculate selfcenter anyway</span>
<a name="l00528"></a>00528     coll_box.<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a>  = coll_box.<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a>;
<a name="l00529"></a>00529     coll_box.<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a> += coll_box.<a class="code" href="structcollision__box__t.html#a6e337e38343e67297b6b82179fe7da6b" title="relative collision box">rehi</a>;
<a name="l00530"></a>00530     coll_box.<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a> *= 0.5;
<a name="l00531"></a>00531     
<a name="l00532"></a>00532     <span class="comment">// and center too (we need it)</span>
<a name="l00533"></a>00533     coll_box.<a class="code" href="structcollision__box__t.html#ad5543051f6fbf88976a77e9a91f0ef2b" title="center of rotation">center</a> = pos;
<a name="l00534"></a>00534     coll_box.<a class="code" href="structcollision__box__t.html#a9f4e4e18026a732706583e631dddacf9">virt</a> = virt;
<a name="l00535"></a>00535     coll_box.<a class="code" href="structcollision__box__t.html#a61a2fca190a8ff6cc72b60e7668ac668">event_filter</a> = event_filter;
<a name="l00536"></a>00536 
<a name="l00537"></a>00537     <span class="comment">// camera stuff</span>
<a name="l00538"></a>00538     coll_box.<a class="code" href="structcollision__box__t.html#a69512e322f0e8263d297c1f582e751ba">camforced</a> = <a class="code" href="class_collisions.html#a1d54296b1450d26f7d064b05dacd9f48">forcecam</a>;
<a name="l00539"></a>00539     <span class="keywordflow">if</span> (forcecam)
<a name="l00540"></a>00540     {
<a name="l00541"></a>00541         coll_box.<a class="code" href="structcollision__box__t.html#a2a4bba59907d49b981b70b4033cae5d8">campos</a> = coll_box.<a class="code" href="structcollision__box__t.html#ad5543051f6fbf88976a77e9a91f0ef2b" title="center of rotation">center</a> + rotation * campos;
<a name="l00542"></a>00542     }
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <span class="comment">// first, self-rotate</span>
<a name="l00545"></a>00545     <span class="keywordflow">if</span> (rotating)
<a name="l00546"></a>00546     {
<a name="l00547"></a>00547         <span class="comment">// we have a self-rotated block</span>
<a name="l00548"></a>00548         coll_box.<a class="code" href="structcollision__box__t.html#a0e1f524e7f0c98b5f379c7ac58e048e5">selfrotated</a> = <span class="keyword">true</span>;
<a name="l00549"></a>00549         coll_box.<a class="code" href="structcollision__box__t.html#ac4bee195d4369ec039daa878bba17da9">selfrot</a>     = Quaternion(Degree(sr.x), Vector3::UNIT_X) * Quaternion(Degree(sr.y), Vector3::UNIT_Y) * Quaternion(Degree(sr.z), Vector3::UNIT_Z);
<a name="l00550"></a>00550         coll_box.<a class="code" href="structcollision__box__t.html#a2303a5deb886472eba840b7504dad117">selfunrot</a>   = coll_box.<a class="code" href="structcollision__box__t.html#ac4bee195d4369ec039daa878bba17da9">selfrot</a>.Inverse();
<a name="l00551"></a>00551     } <span class="keywordflow">else</span>
<a name="l00552"></a>00552     {
<a name="l00553"></a>00553         coll_box.<a class="code" href="structcollision__box__t.html#a0e1f524e7f0c98b5f379c7ac58e048e5">selfrotated</a> = <span class="keyword">false</span>;
<a name="l00554"></a>00554     }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556     coll_box.<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a> = -1;
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     <span class="keywordflow">if</span> (!eventname.empty())
<a name="l00559"></a>00559     {
<a name="l00560"></a>00560         <span class="comment">//LOG(&quot;COLL: adding &quot;+TOSTRING(free_eventsource)+&quot; &quot;+String(instancename)+&quot; &quot;+String(eventname));</span>
<a name="l00561"></a>00561         <span class="comment">// this is event-generating</span>
<a name="l00562"></a>00562         strcpy(<a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[<a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>].boxname, eventname.c_str());
<a name="l00563"></a>00563         strcpy(<a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[<a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>].instancename, instancename.c_str());
<a name="l00564"></a>00564         <a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[<a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>].<a class="code" href="structeventsource__t.html#a2a5d584128b80e684e34f5b0a68f8d16">scripthandler</a> = scripthandler;
<a name="l00565"></a>00565         <a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[<a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>].<a class="code" href="structeventsource__t.html#a2973ade596dd7dca2ba99a95e95d2dfa">cbox</a> = <a class="code" href="class_collisions.html#a98767788cb04680d636588eb567cc34e">free_collision_box</a>;
<a name="l00566"></a>00566         <a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[<a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>].<a class="code" href="structeventsource__t.html#ae3bd108240a459a11f1b504d7e62dbfe">snode</a> = tenode;
<a name="l00567"></a>00567         <a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[<a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>].<a class="code" href="structeventsource__t.html#aad222236043a12d98515f09f919695ba">direction</a> = direction;
<a name="l00568"></a>00568         <a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[<a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>].<a class="code" href="structeventsource__t.html#ab401d84e2169f61554afce331c02d0ae">enabled</a> = <span class="keyword">true</span>;
<a name="l00569"></a>00569         coll_box.<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a> = <a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>;
<a name="l00570"></a>00570         <a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>++;
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573     <span class="comment">// next, global rotate</span>
<a name="l00574"></a>00574     <span class="keywordflow">if</span> (fabs(rot.x) &lt; 0.0001f &amp;&amp; fabs(rot.y) &lt; 0.0001f &amp;&amp; fabs(rot.z) &lt; 0.0001f)
<a name="l00575"></a>00575     {
<a name="l00576"></a>00576         <span class="comment">// unrefined box</span>
<a name="l00577"></a>00577         coll_box.<a class="code" href="structcollision__box__t.html#ad5a9be1b8a51c3ba2cac03d9082f1dbe">refined</a> = <span class="keyword">false</span>;
<a name="l00578"></a>00578     } <span class="keywordflow">else</span>
<a name="l00579"></a>00579     {
<a name="l00580"></a>00580         <span class="comment">// refined box</span>
<a name="l00581"></a>00581         coll_box.<a class="code" href="structcollision__box__t.html#ad5a9be1b8a51c3ba2cac03d9082f1dbe">refined</a> = <span class="keyword">true</span>;
<a name="l00582"></a>00582         <span class="comment">// build rotation</span>
<a name="l00583"></a>00583         coll_box.<a class="code" href="structcollision__box__t.html#a9c56bbd867fa23d92410daa621d7f7ca" title="rotation">rot</a>   = rotation;
<a name="l00584"></a>00584         coll_box.<a class="code" href="structcollision__box__t.html#ae942a108071fe9c7192d049efca5c2a4" title="rotation">unrot</a> = rotation.Inverse();
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587     SceneNode *debugsn = 0;
<a name="l00588"></a>00588     
<a name="l00589"></a>00589     <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#ac22cd0e0bf7bc504f7974244801cb175">debugMode</a>)
<a name="l00590"></a>00590     {
<a name="l00591"></a>00591         debugsn = <a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#af1dd98dd6dbe5353a6a0b7bd2a2e42ee">sceneManager</a>-&gt;getRootSceneNode()-&gt;createChildSceneNode();
<a name="l00592"></a>00592     }
<a name="l00593"></a>00593 
<a name="l00594"></a>00594     <span class="comment">// set raw box</span>
<a name="l00595"></a>00595     <span class="comment">// 8 points of a cube</span>
<a name="l00596"></a>00596     <a class="code" href="struct_vector3.html">Vector3</a> cube_points[8];
<a name="l00597"></a>00597     <span class="keywordflow">if</span> (coll_box.<a class="code" href="structcollision__box__t.html#a0e1f524e7f0c98b5f379c7ac58e048e5">selfrotated</a> || coll_box.<a class="code" href="structcollision__box__t.html#ad5a9be1b8a51c3ba2cac03d9082f1dbe">refined</a>)
<a name="l00598"></a>00598     {
<a name="l00599"></a>00599         cube_points[0] = Ogre::Vector3(l.x, l.y, l.z) * sc;
<a name="l00600"></a>00600         cube_points[1] = Ogre::Vector3(h.x, l.y, l.z) * sc;
<a name="l00601"></a>00601         cube_points[2] = Ogre::Vector3(l.x, h.y, l.z) * sc;
<a name="l00602"></a>00602         cube_points[3] = Ogre::Vector3(h.x, h.y, l.z) * sc;
<a name="l00603"></a>00603         cube_points[4] = Ogre::Vector3(l.x, l.y, h.z) * sc;
<a name="l00604"></a>00604         cube_points[5] = Ogre::Vector3(h.x, l.y, h.z) * sc;
<a name="l00605"></a>00605         cube_points[6] = Ogre::Vector3(l.x, h.y, h.z) * sc;
<a name="l00606"></a>00606         cube_points[7] = Ogre::Vector3(h.x, h.y, h.z) * sc;
<a name="l00607"></a>00607         
<a name="l00608"></a>00608         <span class="comment">// rotate box</span>
<a name="l00609"></a>00609         <span class="keywordflow">if</span> (coll_box.<a class="code" href="structcollision__box__t.html#a0e1f524e7f0c98b5f379c7ac58e048e5">selfrotated</a>)
<a name="l00610"></a>00610             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; 8; i++)
<a name="l00611"></a>00611             {
<a name="l00612"></a>00612                 cube_points[i]=cube_points[i]-coll_box.<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a>;
<a name="l00613"></a>00613                 cube_points[i]=coll_box.<a class="code" href="structcollision__box__t.html#ac4bee195d4369ec039daa878bba17da9">selfrot</a>*cube_points[i];
<a name="l00614"></a>00614                 cube_points[i]=cube_points[i]+coll_box.<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a>;
<a name="l00615"></a>00615             }
<a name="l00616"></a>00616             <span class="keywordflow">if</span> (coll_box.<a class="code" href="structcollision__box__t.html#ad5a9be1b8a51c3ba2cac03d9082f1dbe">refined</a>)
<a name="l00617"></a>00617             {
<a name="l00618"></a>00618                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; 8; i++)
<a name="l00619"></a>00619                 {
<a name="l00620"></a>00620                     cube_points[i] = coll_box.<a class="code" href="structcollision__box__t.html#a9c56bbd867fa23d92410daa621d7f7ca" title="rotation">rot</a> * cube_points[i];
<a name="l00621"></a>00621                 }
<a name="l00622"></a>00622             }
<a name="l00623"></a>00623             <span class="comment">// find min/max</span>
<a name="l00624"></a>00624             coll_box.<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a> = cube_points[0];
<a name="l00625"></a>00625             coll_box.<a class="code" href="structcollision__box__t.html#a9ec6254c84de43834cc76f58418c7f43" title="absolute collision box">hi</a> = cube_points[0];
<a name="l00626"></a>00626             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt; 8; i++)
<a name="l00627"></a>00627             {
<a name="l00628"></a>00628                 coll_box.<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a>.makeFloor(cube_points[i]);
<a name="l00629"></a>00629                 coll_box.<a class="code" href="structcollision__box__t.html#a9ec6254c84de43834cc76f58418c7f43" title="absolute collision box">hi</a>.makeCeil(cube_points[i]);
<a name="l00630"></a>00630             }
<a name="l00631"></a>00631             <span class="comment">// set absolute coords</span>
<a name="l00632"></a>00632             coll_box.<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a> += pos;
<a name="l00633"></a>00633             coll_box.<a class="code" href="structcollision__box__t.html#a9ec6254c84de43834cc76f58418c7f43" title="absolute collision box">hi</a> += pos;
<a name="l00634"></a>00634     } <span class="keywordflow">else</span>
<a name="l00635"></a>00635     {
<a name="l00636"></a>00636         <span class="comment">// unrefined box</span>
<a name="l00637"></a>00637         coll_box.<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a> = pos + coll_box.<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a>;
<a name="l00638"></a>00638         coll_box.<a class="code" href="structcollision__box__t.html#a9ec6254c84de43834cc76f58418c7f43" title="absolute collision box">hi</a> = pos + coll_box.<a class="code" href="structcollision__box__t.html#a6e337e38343e67297b6b82179fe7da6b" title="relative collision box">rehi</a>;
<a name="l00639"></a>00639         <a class="code" href="struct_vector3.html">Vector3</a> d = (coll_box.<a class="code" href="structcollision__box__t.html#a6e337e38343e67297b6b82179fe7da6b" title="relative collision box">rehi</a> - coll_box.<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a>);
<a name="l00640"></a>00640         cube_points[0] = coll_box.<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a>;
<a name="l00641"></a>00641         cube_points[1] = coll_box.<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a>; cube_points[1].<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a> += d.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>;
<a name="l00642"></a>00642         cube_points[2] = coll_box.<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a>;                          cube_points[2].<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a> += d.<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a>;
<a name="l00643"></a>00643         cube_points[3] = coll_box.<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a>; cube_points[3].<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a> += d.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>; cube_points[3].<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a> += d.<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a>;
<a name="l00644"></a>00644         cube_points[4] = coll_box.<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a>;                                                   cube_points[4].<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a> += d.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>;
<a name="l00645"></a>00645         cube_points[5] = coll_box.<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a>; cube_points[5].<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a> += d.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>;                          cube_points[5].<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a> += d.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>;
<a name="l00646"></a>00646         cube_points[6] = coll_box.<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a>; cube_points[6].<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a> += d.<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a>;                          cube_points[6].<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a> += d.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>;
<a name="l00647"></a>00647         cube_points[7] = coll_box.<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a>; cube_points[7].<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a> += d.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>; cube_points[7].<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a> += d.<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a>; cube_points[7].<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a> += d.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>;
<a name="l00648"></a>00648     }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650     <span class="keywordflow">if</span> (debugsn)
<a name="l00651"></a>00651     {
<a name="l00652"></a>00652         debugsn-&gt;setPosition(pos);
<a name="l00653"></a>00653         <span class="comment">// box content</span>
<a name="l00654"></a>00654         ManualObject *mo = <a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#af1dd98dd6dbe5353a6a0b7bd2a2e42ee">sceneManager</a>-&gt;createManualObject();
<a name="l00655"></a>00655         String matName = <span class="stringliteral">&quot;tracks/debug/collision/box&quot;</span>;
<a name="l00656"></a>00656         <span class="keywordflow">if</span> (virt &amp;&amp; scripthandler == -1)
<a name="l00657"></a>00657             matName = <span class="stringliteral">&quot;tracks/debug/eventbox/unused&quot;</span>;
<a name="l00658"></a>00658         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (virt)
<a name="l00659"></a>00659             matName = <span class="stringliteral">&quot;tracks/debug/eventbox/used&quot;</span>;
<a name="l00660"></a>00660         AxisAlignedBox *aa = <span class="keyword">new</span> AxisAlignedBox();
<a name="l00661"></a>00661         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; 8; i++)
<a name="l00662"></a>00662         {
<a name="l00663"></a>00663             aa-&gt;merge(cube_points[i]);
<a name="l00664"></a>00664         }
<a name="l00665"></a>00665         mo-&gt;begin(matName, Ogre::RenderOperation::OT_TRIANGLE_LIST);
<a name="l00666"></a>00666         mo-&gt;position(cube_points[0]);
<a name="l00667"></a>00667         mo-&gt;position(cube_points[1]);
<a name="l00668"></a>00668         mo-&gt;position(cube_points[2]);
<a name="l00669"></a>00669         mo-&gt;position(cube_points[3]);
<a name="l00670"></a>00670         mo-&gt;position(cube_points[4]);
<a name="l00671"></a>00671         mo-&gt;position(cube_points[5]);
<a name="l00672"></a>00672         mo-&gt;position(cube_points[6]);
<a name="l00673"></a>00673         mo-&gt;position(cube_points[7]);
<a name="l00674"></a>00674 
<a name="l00675"></a>00675         <span class="comment">// front</span>
<a name="l00676"></a>00676         mo-&gt;triangle(0,1,2);
<a name="l00677"></a>00677         mo-&gt;triangle(1,3,2);
<a name="l00678"></a>00678         <span class="comment">// right side</span>
<a name="l00679"></a>00679         mo-&gt;triangle(3,1,5);
<a name="l00680"></a>00680         mo-&gt;triangle(5,7,3);
<a name="l00681"></a>00681         <span class="comment">// left side</span>
<a name="l00682"></a>00682         mo-&gt;triangle(6,4,0);
<a name="l00683"></a>00683         mo-&gt;triangle(0,2,6);
<a name="l00684"></a>00684         <span class="comment">// back side</span>
<a name="l00685"></a>00685         mo-&gt;triangle(7,5,4);
<a name="l00686"></a>00686         mo-&gt;triangle(4,6,7);
<a name="l00687"></a>00687         <span class="comment">// bottom</span>
<a name="l00688"></a>00688         mo-&gt;triangle(5,4,1);
<a name="l00689"></a>00689         mo-&gt;triangle(4,0,1);
<a name="l00690"></a>00690         <span class="comment">// top</span>
<a name="l00691"></a>00691         mo-&gt;triangle(2,3,6);
<a name="l00692"></a>00692         mo-&gt;triangle(3,7,6);
<a name="l00693"></a>00693 
<a name="l00694"></a>00694         mo-&gt;end();
<a name="l00695"></a>00695         mo-&gt;setBoundingBox(*aa);
<a name="l00696"></a>00696         mo-&gt;setRenderingDistance(200);
<a name="l00697"></a>00697         debugsn-&gt;attachObject(mo);
<a name="l00698"></a>00698 
<a name="l00699"></a>00699         <span class="comment">// the border</span>
<a name="l00700"></a>00700         mo = <a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#af1dd98dd6dbe5353a6a0b7bd2a2e42ee">sceneManager</a>-&gt;createManualObject();
<a name="l00701"></a>00701         mo-&gt;begin(matName, Ogre::RenderOperation::OT_LINE_LIST);
<a name="l00702"></a>00702         mo-&gt;position(cube_points[0]);
<a name="l00703"></a>00703         mo-&gt;position(cube_points[1]);
<a name="l00704"></a>00704         mo-&gt;position(cube_points[2]);
<a name="l00705"></a>00705         mo-&gt;position(cube_points[3]);
<a name="l00706"></a>00706         mo-&gt;position(cube_points[4]);
<a name="l00707"></a>00707         mo-&gt;position(cube_points[5]);
<a name="l00708"></a>00708         mo-&gt;position(cube_points[6]);
<a name="l00709"></a>00709         mo-&gt;position(cube_points[7]);
<a name="l00710"></a>00710         <span class="comment">//front</span>
<a name="l00711"></a>00711         mo-&gt;index(0);mo-&gt;index(1); mo-&gt;index(1);mo-&gt;index(3); mo-&gt;index(3);mo-&gt;index(2); mo-&gt;index(2);mo-&gt;index(0);
<a name="l00712"></a>00712         <span class="comment">// right side</span>
<a name="l00713"></a>00713         mo-&gt;index(1);mo-&gt;index(5); mo-&gt;index(5);mo-&gt;index(7); mo-&gt;index(7);mo-&gt;index(3); mo-&gt;index(3);mo-&gt;index(1);
<a name="l00714"></a>00714         <span class="comment">// left side</span>
<a name="l00715"></a>00715         mo-&gt;index(0);mo-&gt;index(2); mo-&gt;index(2);mo-&gt;index(6); mo-&gt;index(6);mo-&gt;index(4); mo-&gt;index(4);mo-&gt;index(0);
<a name="l00716"></a>00716         <span class="comment">// back side</span>
<a name="l00717"></a>00717         mo-&gt;index(5);mo-&gt;index(4); mo-&gt;index(4);mo-&gt;index(6); mo-&gt;index(6);mo-&gt;index(7); mo-&gt;index(7);mo-&gt;index(5);
<a name="l00718"></a>00718         <span class="comment">// bottom and top not needed</span>
<a name="l00719"></a>00719         mo-&gt;end();
<a name="l00720"></a>00720         mo-&gt;setBoundingBox(*aa);
<a name="l00721"></a>00721         debugsn-&gt;attachObject(mo);
<a name="l00722"></a>00722         mo-&gt;setRenderingDistance(200);
<a name="l00723"></a>00723         <span class="keyword">delete</span>(aa);
<a name="l00724"></a>00724 
<a name="l00725"></a>00725         <span class="comment">// label</span>
<a name="l00726"></a>00726         <span class="comment">// setup a label</span>
<a name="l00727"></a>00727         <span class="keywordflow">if</span> (virt)
<a name="l00728"></a>00728         {
<a name="l00729"></a>00729             String labelName = <span class="stringliteral">&quot;collision_box_label_&quot;</span>+<a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(<a class="code" href="class_collisions.html#a98767788cb04680d636588eb567cc34e">free_collision_box</a>);
<a name="l00730"></a>00730             String labelCaption = <span class="stringliteral">&quot;EVENTBOX\nevent:&quot;</span>+String(eventname) + <span class="stringliteral">&quot;\ninstance:&quot;</span> + String(instancename);
<a name="l00731"></a>00731             <span class="keywordflow">if</span> (scripthandler != -1)
<a name="l00732"></a>00732                 labelCaption += <span class="stringliteral">&quot;\nhandler:&quot;</span> + <a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(scripthandler);
<a name="l00733"></a>00733             <a class="code" href="class_ogre_1_1_movable_text.html">MovableText</a> *mt = <span class="keyword">new</span> <a class="code" href="class_ogre_1_1_movable_text.html">MovableText</a>(labelName, labelCaption);
<a name="l00734"></a>00734             mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#aed27a49ecadb3905afb7b5de4409d799">setFontName</a>(<span class="stringliteral">&quot;highcontrast_black&quot;</span>);
<a name="l00735"></a>00735             mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a8fc0b2d13ba89695e53152ad1c435306">setTextAlignment</a>(MovableText::H_CENTER, MovableText::V_ABOVE);
<a name="l00736"></a>00736             mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a0e4f2340efd854e591e07fb4bebcbeaa">setAdditionalHeight</a>(1);
<a name="l00737"></a>00737             mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a88bb2321dd352795dfeff306928e48bc">showOnTop</a>(<span class="keyword">false</span>);
<a name="l00738"></a>00738             mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a0562e7c4341e263ae6e9d55f91643ade">setCharacterHeight</a>(0.3);
<a name="l00739"></a>00739             mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a7ed5e440d32fee6180e6eaa7094b3f5c">setColor</a>(ColourValue::Black);
<a name="l00740"></a>00740             mt-&gt;setRenderingDistance(200);
<a name="l00741"></a>00741 
<a name="l00742"></a>00742             SceneNode *n2 = <a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#af1dd98dd6dbe5353a6a0b7bd2a2e42ee">sceneManager</a>-&gt;getRootSceneNode()-&gt;createChildSceneNode();
<a name="l00743"></a>00743             n2-&gt;attachObject(mt);
<a name="l00744"></a>00744             n2-&gt;setPosition(coll_box.<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a> + (coll_box.<a class="code" href="structcollision__box__t.html#a9ec6254c84de43834cc76f58418c7f43" title="absolute collision box">hi</a> - coll_box.<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a>) * 0.5f);
<a name="l00745"></a>00745         }
<a name="l00746"></a>00746     }
<a name="l00747"></a>00747 
<a name="l00748"></a>00748     <span class="comment">// register this collision box in the index</span>
<a name="l00749"></a>00749     coll_box.<a class="code" href="structcollision__box__t.html#a99e11f2493865ad31e90675d4c4c8054">ilo</a> = Ogre::Vector3(coll_box.<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a> / Ogre::Real(<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>));
<a name="l00750"></a>00750     coll_box.<a class="code" href="structcollision__box__t.html#a27c24cef0508929250a53b3d09e94d75">ihi</a> = Ogre::Vector3(coll_box.<a class="code" href="structcollision__box__t.html#a9ec6254c84de43834cc76f58418c7f43" title="absolute collision box">hi</a> / Ogre::Real(<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>));
<a name="l00751"></a>00751     
<a name="l00752"></a>00752     <span class="comment">// clamp between 0 and MAXIMUM_CELL;</span>
<a name="l00753"></a>00753     coll_box.<a class="code" href="structcollision__box__t.html#a99e11f2493865ad31e90675d4c4c8054">ilo</a>.makeCeil(Ogre::Vector3(0.0f));
<a name="l00754"></a>00754     coll_box.<a class="code" href="structcollision__box__t.html#a99e11f2493865ad31e90675d4c4c8054">ilo</a>.makeFloor(Ogre::Vector3(<a class="code" href="class_collisions.html#acc03c83e0628bfd4804c5451583f7426">MAXIMUM_CELL</a>));
<a name="l00755"></a>00755     coll_box.<a class="code" href="structcollision__box__t.html#a27c24cef0508929250a53b3d09e94d75">ihi</a>.makeCeil(Ogre::Vector3(0.0f));
<a name="l00756"></a>00756     coll_box.<a class="code" href="structcollision__box__t.html#a27c24cef0508929250a53b3d09e94d75">ihi</a>.makeFloor(Ogre::Vector3(<a class="code" href="class_collisions.html#acc03c83e0628bfd4804c5451583f7426">MAXIMUM_CELL</a>));
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=coll_box.<a class="code" href="structcollision__box__t.html#a99e11f2493865ad31e90675d4c4c8054">ilo</a>.x; i &lt;= coll_box.<a class="code" href="structcollision__box__t.html#a27c24cef0508929250a53b3d09e94d75">ihi</a>.x; i++)
<a name="l00759"></a>00759     {
<a name="l00760"></a>00760         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=coll_box.<a class="code" href="structcollision__box__t.html#a99e11f2493865ad31e90675d4c4c8054">ilo</a>.z; j &lt;= coll_box.<a class="code" href="structcollision__box__t.html#a27c24cef0508929250a53b3d09e94d75">ihi</a>.z; j++)
<a name="l00761"></a>00761         {
<a name="l00762"></a>00762             <span class="comment">//LOG(&quot;Adding a reference to cell &quot;+TOSTRING(i)+&quot; &quot;+TOSTRING(j)+&quot; at index &quot;+TOSTRING(collision_index_free[i*NUM_COLLISON_CELLS+j]));</span>
<a name="l00763"></a>00763             <a class="code" href="class_collisions.html#ab8dc3b86fee4e2aa47927bfeabe2ddfe">hash_add</a>(i,j,<a class="code" href="class_collisions.html#a98767788cb04680d636588eb567cc34e">free_collision_box</a>);
<a name="l00764"></a>00764         }
<a name="l00765"></a>00765     }
<a name="l00766"></a>00766     <span class="keywordtype">int</span> num = <a class="code" href="class_collisions.html#a98767788cb04680d636588eb567cc34e">free_collision_box</a>;
<a name="l00767"></a>00767     <a class="code" href="class_collisions.html#a98767788cb04680d636588eb567cc34e">free_collision_box</a>++;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769     <span class="keywordflow">return</span> num;
<a name="l00770"></a>00770 }
<a name="l00771"></a>00771 
<a name="l00772"></a><a class="code" href="class_collisions.html#a2b717349889d16df812225582f8ac943">00772</a> <span class="keywordtype">int</span> <a class="code" href="class_collisions.html#a2b717349889d16df812225582f8ac943">Collisions::removeCollisionBox</a>(<span class="keywordtype">int</span> num)
<a name="l00773"></a>00773 {
<a name="l00774"></a>00774     <span class="keywordflow">if</span> (num &lt; 0 || num &gt; <a class="code" href="class_collisions.html#a98767788cb04680d636588eb567cc34e">free_collision_box</a>)
<a name="l00775"></a>00775         <span class="keywordflow">return</span> 1;
<a name="l00776"></a>00776     
<a name="l00777"></a>00777     <a class="code" href="structcollision__box__t.html">collision_box_t</a>&amp; coll_box = <a class="code" href="class_collisions.html#a1792d7c6e15ade78504de1f7ae88f11a">collision_boxes</a>[num];
<a name="l00778"></a>00778     
<a name="l00779"></a>00779     <span class="keywordflow">if</span> (!coll_box.<a class="code" href="structcollision__box__t.html#a6497936ab1181364758f995eb3ac91a2">enabled</a>)
<a name="l00780"></a>00780         <span class="keywordflow">return</span> 2;
<a name="l00781"></a>00781 
<a name="l00782"></a>00782     <span class="comment">// disable the box</span>
<a name="l00783"></a>00783     coll_box.<a class="code" href="structcollision__box__t.html#a6497936ab1181364758f995eb3ac91a2">enabled</a> = <span class="keyword">false</span>;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785     <span class="comment">// disable the event</span>
<a name="l00786"></a>00786     <span class="keywordflow">if</span> (coll_box.<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a> != -1 &amp;&amp; coll_box.<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a> &gt;= 0 &amp;&amp; coll_box.<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a> &lt; <a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>)
<a name="l00787"></a>00787     {
<a name="l00788"></a>00788         <a class="code" href="structeventsource__t.html">eventsource_t</a>&amp; es = <a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[coll_box.<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a>];
<a name="l00789"></a>00789         es.<a class="code" href="structeventsource__t.html#ab401d84e2169f61554afce331c02d0ae">enabled</a> = <span class="keyword">false</span>;
<a name="l00790"></a>00790     }
<a name="l00791"></a>00791 
<a name="l00792"></a>00792     <span class="comment">// then remove it from the hashtable</span>
<a name="l00793"></a>00793     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = coll_box.<a class="code" href="structcollision__box__t.html#a99e11f2493865ad31e90675d4c4c8054">ilo</a>.x; i &lt;= coll_box.<a class="code" href="structcollision__box__t.html#a27c24cef0508929250a53b3d09e94d75">ihi</a>.x; i++)
<a name="l00794"></a>00794     {
<a name="l00795"></a>00795         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = coll_box.<a class="code" href="structcollision__box__t.html#a99e11f2493865ad31e90675d4c4c8054">ilo</a>.z; j &lt;= coll_box.<a class="code" href="structcollision__box__t.html#a27c24cef0508929250a53b3d09e94d75">ihi</a>.z; j++)
<a name="l00796"></a>00796         {
<a name="l00797"></a>00797             <a class="code" href="class_collisions.html#a5daaefbf4b30949f1d68ba5ae38d9b9b">hash_free</a>(i,j,num);
<a name="l00798"></a>00798         }
<a name="l00799"></a>00799     }
<a name="l00800"></a>00800 
<a name="l00801"></a>00801     <span class="keywordflow">return</span> 0;
<a name="l00802"></a>00802 }
<a name="l00803"></a>00803 
<a name="l00804"></a><a class="code" href="class_collisions.html#a44e7f403a680e597a54209b2873b6e28">00804</a> <span class="keywordtype">int</span> <a class="code" href="class_collisions.html#a44e7f403a680e597a54209b2873b6e28">Collisions::addCollisionTri</a>(<a class="code" href="struct_vector3.html">Vector3</a> p1, <a class="code" href="struct_vector3.html">Vector3</a> p2, <a class="code" href="struct_vector3.html">Vector3</a> p3, <a class="code" href="structground__model__t.html">ground_model_t</a>* gm)
<a name="l00805"></a>00805 {
<a name="l00806"></a>00806     <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a> &gt;= <a class="code" href="class_collisions.html#aa6a642407632d7270f8864875fa5e46f">max_col_tris</a>) <span class="keywordflow">return</span> -1;
<a name="l00807"></a>00807     <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[<a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>].<a class="code" href="struct_collisions_1_1collision__tri__t.html#a44309866094911fd5a0c0733a5fe6288">a</a>=p1;
<a name="l00808"></a>00808     <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[<a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>].<a class="code" href="struct_collisions_1_1collision__tri__t.html#ab1273374d5fda34e5bcf6615becb0d83">b</a>=p2;
<a name="l00809"></a>00809     <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[<a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>].<a class="code" href="struct_collisions_1_1collision__tri__t.html#a054ab156cb2a95d68c28969c411204d1">c</a>=p3;
<a name="l00810"></a>00810     <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[<a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>].<a class="code" href="struct_collisions_1_1collision__tri__t.html#ae05146f8b1acdd6b1c4e80dfb20b809c">gm</a>=gm;
<a name="l00811"></a>00811     <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[<a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>].<a class="code" href="struct_collisions_1_1collision__tri__t.html#a0ee18c811839c7a415c09e44f9a35fe6">enabled</a>=<span class="keyword">true</span>;
<a name="l00812"></a>00812     <span class="comment">// compute transformations</span>
<a name="l00813"></a>00813     <span class="comment">// base construction</span>
<a name="l00814"></a>00814     <a class="code" href="struct_vector3.html">Vector3</a> bx=p2-p1;
<a name="l00815"></a>00815     <a class="code" href="struct_vector3.html">Vector3</a> by=p3-p1;
<a name="l00816"></a>00816     <a class="code" href="struct_vector3.html">Vector3</a> bz=bx.crossProduct(by);
<a name="l00817"></a>00817     bz.normalise();
<a name="l00818"></a>00818     <span class="comment">// coordinates change matrix</span>
<a name="l00819"></a>00819     <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[<a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>].<a class="code" href="struct_collisions_1_1collision__tri__t.html#af99309e21509f90173a873e871d40b73">reverse</a>.SetColumn(0, bx);
<a name="l00820"></a>00820     <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[<a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>].<a class="code" href="struct_collisions_1_1collision__tri__t.html#af99309e21509f90173a873e871d40b73">reverse</a>.SetColumn(1, by);
<a name="l00821"></a>00821     <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[<a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>].<a class="code" href="struct_collisions_1_1collision__tri__t.html#af99309e21509f90173a873e871d40b73">reverse</a>.SetColumn(2, bz);
<a name="l00822"></a>00822     <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[<a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>].<a class="code" href="struct_collisions_1_1collision__tri__t.html#abd01fe73556b208d69f17040246522b9">forward</a>=<a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[<a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>].<a class="code" href="struct_collisions_1_1collision__tri__t.html#af99309e21509f90173a873e871d40b73">reverse</a>.Inverse();
<a name="l00823"></a>00823 
<a name="l00824"></a>00824     <span class="comment">// compute tri AAB</span>
<a name="l00825"></a>00825     AxisAlignedBox aab;
<a name="l00826"></a>00826     aab.merge(p1);
<a name="l00827"></a>00827     aab.merge(p2);
<a name="l00828"></a>00828     aab.merge(p3);
<a name="l00829"></a>00829     
<a name="l00830"></a>00830     <span class="comment">// register this collision tri in the index</span>
<a name="l00831"></a>00831     Ogre::Vector3 ilo(aab.getMinimum() / Ogre::Real(<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>));
<a name="l00832"></a>00832     Ogre::Vector3 ihi(aab.getMaximum() / Ogre::Real(<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>));
<a name="l00833"></a>00833     
<a name="l00834"></a>00834     <span class="comment">// clamp between 0 and MAXIMUM_CELL;</span>
<a name="l00835"></a>00835     ilo.makeCeil(Ogre::Vector3(0.0f));
<a name="l00836"></a>00836     ilo.makeFloor(Ogre::Vector3(<a class="code" href="class_collisions.html#acc03c83e0628bfd4804c5451583f7426">MAXIMUM_CELL</a>));
<a name="l00837"></a>00837     ihi.makeCeil(Ogre::Vector3(0.0f));
<a name="l00838"></a>00838     ihi.makeFloor(Ogre::Vector3(<a class="code" href="class_collisions.html#acc03c83e0628bfd4804c5451583f7426">MAXIMUM_CELL</a>));
<a name="l00839"></a>00839     
<a name="l00840"></a>00840     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = ilo.x; i &lt;= ihi.x; i++)
<a name="l00841"></a>00841     {
<a name="l00842"></a>00842         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=ilo.z; j&lt;=ihi.z; j++)
<a name="l00843"></a>00843         {
<a name="l00844"></a>00844             <a class="code" href="class_collisions.html#ab8dc3b86fee4e2aa47927bfeabe2ddfe">hash_add</a>(i,j,<a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>+<a class="code" href="class_collisions.html#afee2a1122b17c9daec024a08a86c5ebe">MAX_COLLISION_BOXES</a>);
<a name="l00845"></a>00845         }
<a name="l00846"></a>00846     }
<a name="l00847"></a>00847     
<a name="l00848"></a>00848     <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#ac22cd0e0bf7bc504f7974244801cb175">debugMode</a>)
<a name="l00849"></a>00849     {
<a name="l00850"></a>00850         <a class="code" href="class_collisions.html#a071e5015fc25d34315f5a0caf73e9a09">debugmo</a>-&gt;position(p1);
<a name="l00851"></a>00851         <a class="code" href="class_collisions.html#a071e5015fc25d34315f5a0caf73e9a09">debugmo</a>-&gt;position(p2);
<a name="l00852"></a>00852         <a class="code" href="class_collisions.html#a071e5015fc25d34315f5a0caf73e9a09">debugmo</a>-&gt;position(p3);
<a name="l00853"></a>00853     }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855     <span class="keywordflow">return</span> <a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>++;
<a name="l00856"></a>00856 }
<a name="l00857"></a>00857 
<a name="l00858"></a><a class="code" href="class_collisions.html#ae850c379555c9ea261b4db7a72bd425e">00858</a> <span class="keywordtype">void</span> <a class="code" href="class_collisions.html#ae850c379555c9ea261b4db7a72bd425e">Collisions::printStats</a>()
<a name="l00859"></a>00859 {
<a name="l00860"></a>00860     <a class="code" href="_ro_r_prerequisites_8h.html#af855c94dc540e943632089ce7496faac">LOG</a>(<span class="stringliteral">&quot;COLL: Collision system statistics:&quot;</span>);
<a name="l00861"></a>00861     <a class="code" href="_ro_r_prerequisites_8h.html#af855c94dc540e943632089ce7496faac">LOG</a>(<span class="stringliteral">&quot;COLL: Cell size: &quot;</span>+<a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>((<span class="keywordtype">float</span>)<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>)+<span class="stringliteral">&quot; m&quot;</span>);
<a name="l00862"></a>00862     <a class="code" href="_ro_r_prerequisites_8h.html#af855c94dc540e943632089ce7496faac">LOG</a>(<span class="stringliteral">&quot;COLL: Hashtable occupation: &quot;</span>+<a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(<a class="code" href="class_collisions.html#aecc9b19321fbf9163a606ba73f89f746">cells</a>.size()));
<a name="l00863"></a>00863     <a class="code" href="_ro_r_prerequisites_8h.html#af855c94dc540e943632089ce7496faac">LOG</a>(<span class="stringliteral">&quot;COLL: Hashtable collisions: &quot;</span>+<a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(<a class="code" href="class_collisions.html#a87d5b05b8cf46f4a40dd5f39dd295f44">collision_count</a>));
<a name="l00864"></a>00864     <a class="code" href="_ro_r_prerequisites_8h.html#af855c94dc540e943632089ce7496faac">LOG</a>(<span class="stringliteral">&quot;COLL: Largest cell: &quot;</span>+<a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(<a class="code" href="class_collisions.html#a2fc69b5019b2fcc216940f804b4b6f50">largest_cellcount</a>));
<a name="l00865"></a>00865 }
<a name="l00866"></a>00866 
<a name="l00867"></a><a class="code" href="class_collisions.html#afab554d00436aa9157c93a4eaecf8d74">00867</a> <span class="keywordtype">bool</span> <a class="code" href="class_collisions.html#afab554d00436aa9157c93a4eaecf8d74">Collisions::envokeScriptCallback</a>(<a class="code" href="structcollision__box__t.html">collision_box_t</a> *cbox, <a class="code" href="structnode__t.html">node_t</a> *node)
<a name="l00868"></a>00868 {
<a name="l00869"></a>00869     <span class="keywordtype">bool</span> handled = <span class="keyword">false</span>;
<a name="l00870"></a>00870 
<a name="l00871"></a>00871     <span class="comment">// check if this box is active anymore</span>
<a name="l00872"></a>00872     <span class="keywordflow">if</span> (!<a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[cbox-&gt;<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a>].<a class="code" href="structeventsource__t.html#ab401d84e2169f61554afce331c02d0ae">enabled</a>)
<a name="l00873"></a>00873         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00874"></a>00874     
<a name="l00875"></a>00875     <a class="code" href="_ro_r_prerequisites_8h.html#a441b021fa23aeb332a6aa860cb1aee7c" title="FEAT_DEBUG_MUTEX.">MUTEX_LOCK</a>(&amp;<a class="code" href="class_collisions.html#a87ed8396f2a9257fa2e961a48d784f61">scriptcallback_mutex</a>);
<a name="l00876"></a>00876     <span class="comment">// this prevents that the same callback gets called at 2k FPS all the time, serious hit on FPS ...</span>
<a name="l00877"></a>00877     <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#a320a3ed8bce1d0fb95de2ca7a6d34af0">last_called_cbox</a> != cbox)
<a name="l00878"></a>00878     {
<a name="l00879"></a>00879 <span class="preprocessor">#ifdef USE_ANGELSCRIPT</span>
<a name="l00880"></a>00880 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="class_ro_r_singleton_no_creation.html#a5e7a47f4b2d6d0abaa3a1ea5ca1f216a">ScriptEngine::getSingleton</a>().envokeCallback(<a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[cbox-&gt;<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a>].<a class="code" href="structeventsource__t.html#a2a5d584128b80e684e34f5b0a68f8d16">scripthandler</a>, &amp;<a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[cbox-&gt;<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a>], node))
<a name="l00881"></a>00881             handled = <span class="keyword">true</span>;
<a name="l00882"></a>00882 <span class="preprocessor">#endif //USE_ANGELSCRIPT</span>
<a name="l00883"></a>00883 <span class="preprocessor"></span>        <a class="code" href="class_collisions.html#a320a3ed8bce1d0fb95de2ca7a6d34af0">last_called_cbox</a> = cbox;
<a name="l00884"></a>00884     }
<a name="l00885"></a>00885     <a class="code" href="_ro_r_prerequisites_8h.html#a04bad901d24418b1d7e307edb0d38662">MUTEX_UNLOCK</a>(&amp;<a class="code" href="class_collisions.html#a87ed8396f2a9257fa2e961a48d784f61">scriptcallback_mutex</a>);
<a name="l00886"></a>00886 
<a name="l00887"></a>00887     <span class="keywordflow">return</span> handled;
<a name="l00888"></a>00888 }
<a name="l00889"></a>00889 
<a name="l00890"></a><a class="code" href="class_collisions.html#ad12c4976773ee3a8034b02fe1cd0212d">00890</a> <span class="keywordtype">void</span> <a class="code" href="class_collisions.html#ad12c4976773ee3a8034b02fe1cd0212d">Collisions::clearEventCache</a>()
<a name="l00891"></a>00891 {
<a name="l00892"></a>00892     <a class="code" href="class_collisions.html#a320a3ed8bce1d0fb95de2ca7a6d34af0">last_called_cbox</a> = 0;
<a name="l00893"></a>00893 }
<a name="l00894"></a>00894 
<a name="l00895"></a><a class="code" href="class_collisions.html#a76f3fda7383ac14c38f2f31f3ba9e691">00895</a> <span class="keywordtype">bool</span> <a class="code" href="class_collisions.html#a76f3fda7383ac14c38f2f31f3ba9e691">Collisions::collisionCorrect</a>(<a class="code" href="struct_vector3.html">Vector3</a> *refpos)
<a name="l00896"></a>00896 {
<a name="l00897"></a>00897     <span class="comment">// find the correct cell</span>
<a name="l00898"></a>00898     <span class="keywordtype">bool</span> contacted=<span class="keyword">false</span>;
<a name="l00899"></a>00899     <span class="keywordtype">int</span> refx, refz;
<a name="l00900"></a>00900     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k;
<a name="l00901"></a>00901 
<a name="l00902"></a>00902     <a class="code" href="struct_vector3.html">Vector3</a> mapSize = <a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#a23825f69e60897a660d18659399e0de2">terrainManager</a>-&gt;<a class="code" href="class_terrain_manager.html#a41fdd66a57990a5fb33d253213fd04e3">getMaxTerrainSize</a>();
<a name="l00903"></a>00903     <span class="keywordflow">if</span> (!(refpos-&gt;<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>&gt;0 &amp;&amp; refpos-&gt;<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>&lt;mapSize.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a> &amp;&amp; refpos-&gt;<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>&gt;0 &amp;&amp; refpos-&gt;<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>&lt;mapSize.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00904"></a>00904 
<a name="l00905"></a>00905     refx=(int)(refpos-&gt;<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>/(<span class="keywordtype">float</span>)<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>);
<a name="l00906"></a>00906     refz=(int)(refpos-&gt;<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>/(<span class="keywordtype">float</span>)<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>);
<a name="l00907"></a>00907     <a class="code" href="_collisions_8h.html#aca38c9e35e209557ac5566b0f445696d">cell_t</a> *cell=<a class="code" href="class_collisions.html#a4d438eb211fe0953343dc39f478e14e0">hash_find</a>(refx, refz);
<a name="l00908"></a>00908     <span class="keywordflow">if</span> ( !cell ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00909"></a>00909 
<a name="l00910"></a>00910     <a class="code" href="struct_collisions_1_1collision__tri__t.html">collision_tri_t</a> *minctri=0;
<a name="l00911"></a>00911     <span class="keywordtype">float</span> minctridist=100.0;
<a name="l00912"></a>00912     <a class="code" href="struct_vector3.html">Vector3</a> minctripoint;
<a name="l00913"></a>00913 
<a name="l00914"></a>00914     <span class="keywordflow">for</span> (k=0; k&lt;cell-&gt;size(); k++)
<a name="l00915"></a>00915     {
<a name="l00916"></a>00916         <span class="keywordflow">if</span> ((*cell)[k] != (int)<a class="code" href="class_collisions.html#a98a1a447e5f5317ed810b1ad2c3d398f">UNUSED_CELLELEMENT</a> &amp;&amp; (*cell)[k]&lt;<a class="code" href="class_collisions.html#afee2a1122b17c9daec024a08a86c5ebe">MAX_COLLISION_BOXES</a>)
<a name="l00917"></a>00917         {
<a name="l00918"></a>00918             <a class="code" href="structcollision__box__t.html">collision_box_t</a> *cbox=&amp;<a class="code" href="class_collisions.html#a1792d7c6e15ade78504de1f7ae88f11a">collision_boxes</a>[(*cell)[k]];
<a name="l00919"></a>00919             <span class="keywordflow">if</span> ( !( (*refpos) &gt; cbox-&gt;<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a> &amp;&amp; (*refpos) &lt; cbox-&gt;<a class="code" href="structcollision__box__t.html#a9ec6254c84de43834cc76f58418c7f43" title="absolute collision box">hi</a> ) ) <span class="keywordflow">continue</span>;
<a name="l00920"></a>00920 
<a name="l00921"></a>00921             <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#ad5a9be1b8a51c3ba2cac03d9082f1dbe">refined</a> || cbox-&gt;<a class="code" href="structcollision__box__t.html#a0e1f524e7f0c98b5f379c7ac58e048e5">selfrotated</a>)
<a name="l00922"></a>00922             {
<a name="l00923"></a>00923                 <span class="comment">// we may have a collision, do a change of repere</span>
<a name="l00924"></a>00924                 <a class="code" href="struct_vector3.html">Vector3</a> Pos=*refpos-cbox-&gt;<a class="code" href="structcollision__box__t.html#ad5543051f6fbf88976a77e9a91f0ef2b" title="center of rotation">center</a>;
<a name="l00925"></a>00925                 <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#ad5a9be1b8a51c3ba2cac03d9082f1dbe">refined</a>) Pos=cbox-&gt;<a class="code" href="structcollision__box__t.html#ae942a108071fe9c7192d049efca5c2a4" title="rotation">unrot</a>*Pos;
<a name="l00926"></a>00926                 <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#a0e1f524e7f0c98b5f379c7ac58e048e5">selfrotated</a>)
<a name="l00927"></a>00927                 {
<a name="l00928"></a>00928                     Pos=Pos-cbox-&gt;<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a>;
<a name="l00929"></a>00929                     Pos=cbox-&gt;<a class="code" href="structcollision__box__t.html#a2303a5deb886472eba840b7504dad117">selfunrot</a>*Pos;
<a name="l00930"></a>00930                     Pos=Pos+cbox-&gt;<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a>;
<a name="l00931"></a>00931                 }
<a name="l00932"></a>00932                 <span class="comment">// now test with the inner box</span>
<a name="l00933"></a>00933                 <span class="keywordflow">if</span> (Pos &gt; cbox-&gt;<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a> &amp;&amp; Pos &lt; cbox-&gt;rehi)
<a name="l00934"></a>00934                 {
<a name="l00935"></a>00935                     <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a>!=-1 &amp;&amp; <a class="code" href="class_collisions.html#a169c711864e32721fb5daab7d7d01df4">permitEvent</a>(cbox-&gt;<a class="code" href="structcollision__box__t.html#a61a2fca190a8ff6cc72b60e7668ac668">event_filter</a>))
<a name="l00936"></a>00936                     {
<a name="l00937"></a>00937                         <a class="code" href="class_collisions.html#afab554d00436aa9157c93a4eaecf8d74">envokeScriptCallback</a>(cbox);
<a name="l00938"></a>00938                     }
<a name="l00939"></a>00939                     <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#a69512e322f0e8263d297c1f582e751ba">camforced</a> &amp;&amp; !<a class="code" href="class_collisions.html#a1d54296b1450d26f7d064b05dacd9f48">forcecam</a>)
<a name="l00940"></a>00940                     {
<a name="l00941"></a>00941                         <a class="code" href="class_collisions.html#a1d54296b1450d26f7d064b05dacd9f48">forcecam</a>=<span class="keyword">true</span>;
<a name="l00942"></a>00942                         <a class="code" href="class_collisions.html#a7915cbb615e807b371b031c3e5ac4b78">forcecampos</a>=cbox-&gt;<a class="code" href="structcollision__box__t.html#a2a4bba59907d49b981b70b4033cae5d8">campos</a>;
<a name="l00943"></a>00943                     }
<a name="l00944"></a>00944                     <span class="keywordflow">if</span> (!cbox-&gt;<a class="code" href="structcollision__box__t.html#a9f4e4e18026a732706583e631dddacf9">virt</a>)
<a name="l00945"></a>00945                     {
<a name="l00946"></a>00946                         <span class="comment">// collision, process as usual</span>
<a name="l00947"></a>00947                         <span class="comment">// we have a collision</span>
<a name="l00948"></a>00948                         contacted = <span class="keyword">true</span>;
<a name="l00949"></a>00949                         <span class="comment">// determine which side collided</span>
<a name="l00950"></a>00950                         Pos = <a class="code" href="class_collisions.html#accb10540c3aa849f57b7fd3b9da2e1c6">calcCollidedSide</a>(Pos, cbox-&gt;<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a>, cbox-&gt;<a class="code" href="structcollision__box__t.html#a6e337e38343e67297b6b82179fe7da6b" title="relative collision box">rehi</a>);
<a name="l00951"></a>00951                         
<a name="l00952"></a>00952                         <span class="comment">// resume repere</span>
<a name="l00953"></a>00953                         <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#a0e1f524e7f0c98b5f379c7ac58e048e5">selfrotated</a>)
<a name="l00954"></a>00954                         {
<a name="l00955"></a>00955                             Pos=Pos-cbox-&gt;<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a>;
<a name="l00956"></a>00956                             Pos=cbox-&gt;<a class="code" href="structcollision__box__t.html#ac4bee195d4369ec039daa878bba17da9">selfrot</a>*Pos;
<a name="l00957"></a>00957                             Pos=Pos+cbox-&gt;<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a>;
<a name="l00958"></a>00958                         }
<a name="l00959"></a>00959                         <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#ad5a9be1b8a51c3ba2cac03d9082f1dbe">refined</a>) Pos=cbox-&gt;<a class="code" href="structcollision__box__t.html#a9c56bbd867fa23d92410daa621d7f7ca" title="rotation">rot</a>*Pos;
<a name="l00960"></a>00960                         *refpos=Pos+cbox-&gt;<a class="code" href="structcollision__box__t.html#ad5543051f6fbf88976a77e9a91f0ef2b" title="center of rotation">center</a>;
<a name="l00961"></a>00961                     }
<a name="l00962"></a>00962                 }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964             } <span class="keywordflow">else</span>
<a name="l00965"></a>00965             {
<a name="l00966"></a>00966                 <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a>!=-1 &amp;&amp; <a class="code" href="class_collisions.html#a169c711864e32721fb5daab7d7d01df4">permitEvent</a>(cbox-&gt;<a class="code" href="structcollision__box__t.html#a61a2fca190a8ff6cc72b60e7668ac668">event_filter</a>))
<a name="l00967"></a>00967                 {
<a name="l00968"></a>00968                     <a class="code" href="class_collisions.html#afab554d00436aa9157c93a4eaecf8d74">envokeScriptCallback</a>(cbox);
<a name="l00969"></a>00969                 }
<a name="l00970"></a>00970                 <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#a69512e322f0e8263d297c1f582e751ba">camforced</a> &amp;&amp; !<a class="code" href="class_collisions.html#a1d54296b1450d26f7d064b05dacd9f48">forcecam</a>)
<a name="l00971"></a>00971                 {
<a name="l00972"></a>00972                     <a class="code" href="class_collisions.html#a1d54296b1450d26f7d064b05dacd9f48">forcecam</a>=<span class="keyword">true</span>;
<a name="l00973"></a>00973                     <a class="code" href="class_collisions.html#a7915cbb615e807b371b031c3e5ac4b78">forcecampos</a>=cbox-&gt;<a class="code" href="structcollision__box__t.html#a2a4bba59907d49b981b70b4033cae5d8">campos</a>;
<a name="l00974"></a>00974                 }
<a name="l00975"></a>00975                 <span class="keywordflow">if</span> (!cbox-&gt;<a class="code" href="structcollision__box__t.html#a9f4e4e18026a732706583e631dddacf9">virt</a>)
<a name="l00976"></a>00976                 {
<a name="l00977"></a>00977                     <span class="comment">// we have a collision</span>
<a name="l00978"></a>00978                     contacted=<span class="keyword">true</span>;
<a name="l00979"></a>00979                     <span class="comment">// determine which side collided</span>
<a name="l00980"></a>00980                     (*refpos) = <a class="code" href="class_collisions.html#accb10540c3aa849f57b7fd3b9da2e1c6">calcCollidedSide</a>((*refpos), cbox-&gt;<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a>, cbox-&gt;<a class="code" href="structcollision__box__t.html#a9ec6254c84de43834cc76f58418c7f43" title="absolute collision box">hi</a>);
<a name="l00981"></a>00981                 }
<a name="l00982"></a>00982             }
<a name="l00983"></a>00983         } <span class="keywordflow">else</span>
<a name="l00984"></a>00984         {
<a name="l00985"></a>00985             <a class="code" href="struct_collisions_1_1collision__tri__t.html">collision_tri_t</a> *ctri=&amp;<a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[(*cell)[k]-<a class="code" href="class_collisions.html#afee2a1122b17c9daec024a08a86c5ebe">MAX_COLLISION_BOXES</a>];
<a name="l00986"></a>00986             <span class="keywordflow">if</span> (!ctri-&gt;<a class="code" href="struct_collisions_1_1collision__tri__t.html#a0ee18c811839c7a415c09e44f9a35fe6">enabled</a>)
<a name="l00987"></a>00987                 <span class="keywordflow">continue</span>;
<a name="l00988"></a>00988             <span class="comment">// check if this tri is minimal</span>
<a name="l00989"></a>00989             <span class="comment">// transform</span>
<a name="l00990"></a>00990             <a class="code" href="struct_vector3.html">Vector3</a> point=ctri-&gt;<a class="code" href="struct_collisions_1_1collision__tri__t.html#abd01fe73556b208d69f17040246522b9">forward</a>*(*refpos-ctri-&gt;<a class="code" href="struct_collisions_1_1collision__tri__t.html#a44309866094911fd5a0c0733a5fe6288">a</a>);
<a name="l00991"></a>00991             <span class="comment">// test if within tri collision volume (potential cause of bug!)</span>
<a name="l00992"></a>00992             <span class="keywordflow">if</span> (point.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>&gt;=0 &amp;&amp; point.<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a>&gt;=0 &amp;&amp; (point.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>+point.<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a>)&lt;=1.0 &amp;&amp; point.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>&lt;0 &amp;&amp; point.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>&gt;-0.1)
<a name="l00993"></a>00993             {
<a name="l00994"></a>00994                 <span class="keywordflow">if</span> (-point.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>&lt;minctridist)
<a name="l00995"></a>00995                 {
<a name="l00996"></a>00996                     minctridist=-point.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>;
<a name="l00997"></a>00997                     minctri=ctri;
<a name="l00998"></a>00998                     minctripoint=point;
<a name="l00999"></a>00999                 }
<a name="l01000"></a>01000             }
<a name="l01001"></a>01001         }
<a name="l01002"></a>01002     }
<a name="l01003"></a>01003         
<a name="l01004"></a>01004     <span class="comment">// process minctri collision</span>
<a name="l01005"></a>01005     <span class="keywordflow">if</span> (minctri)
<a name="l01006"></a>01006     {
<a name="l01007"></a>01007         <span class="comment">// we have a contact</span>
<a name="l01008"></a>01008         contacted=<span class="keyword">true</span>;
<a name="l01009"></a>01009         <span class="comment">// correct point</span>
<a name="l01010"></a>01010         minctripoint.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>=0;
<a name="l01011"></a>01011         <span class="comment">// reverse transform</span>
<a name="l01012"></a>01012         *refpos=(minctri-&gt;<a class="code" href="struct_collisions_1_1collision__tri__t.html#af99309e21509f90173a873e871d40b73">reverse</a>*minctripoint)+minctri-&gt;<a class="code" href="struct_collisions_1_1collision__tri__t.html#a44309866094911fd5a0c0733a5fe6288">a</a>;
<a name="l01013"></a>01013     }
<a name="l01014"></a>01014     <span class="keywordflow">return</span> contacted;
<a name="l01015"></a>01015 }
<a name="l01016"></a>01016 
<a name="l01017"></a><a class="code" href="class_collisions.html#a169c711864e32721fb5daab7d7d01df4">01017</a> <span class="keywordtype">bool</span> <a class="code" href="class_collisions.html#a169c711864e32721fb5daab7d7d01df4">Collisions::permitEvent</a>(<span class="keywordtype">int</span> filter)
<a name="l01018"></a>01018 {
<a name="l01019"></a>01019     <a class="code" href="class_beam.html">Beam</a> *b = <a class="code" href="class_streamable_factory.html#a233cafcf6f87f5779b1a26a5a48d8f6d">BeamFactory::getSingleton</a>().<a class="code" href="class_beam_factory.html#aeb17b3a10c961e56770f7dc87a16625c">getCurrentTruck</a>();
<a name="l01020"></a>01020 
<a name="l01021"></a>01021     <span class="keywordflow">switch</span> (filter)
<a name="l01022"></a>01022     {
<a name="l01023"></a>01023     <span class="keywordflow">case</span> <a class="code" href="_beam_data_8h.html#a46647e26ac2740f7c5e75378391d6afba0820e8dcfa858b72668b07b1d2b39834">EVENT_ALL</a>:
<a name="l01024"></a>01024         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01025"></a>01025     <span class="keywordflow">case</span> <a class="code" href="_beam_data_8h.html#a46647e26ac2740f7c5e75378391d6afbae228fd47a845b042b583724f092a11d3">EVENT_AVATAR</a>:
<a name="l01026"></a>01026         <span class="keywordflow">return</span> !b;
<a name="l01027"></a>01027     <span class="keywordflow">case</span> <a class="code" href="_beam_data_8h.html#a46647e26ac2740f7c5e75378391d6afba88d78c85ac4b9f3137d9f66e436e1be6">EVENT_TRUCK</a>:
<a name="l01028"></a>01028         <span class="keywordflow">return</span> b &amp;&amp; b-&gt;<a class="code" href="structrig__t.html#af5cdf2b08da0b98aed6f017ae3177444">driveable</a> == <a class="code" href="_beam_data_8h.html#ae4d5251432e1a9e6803c0240cc492e18ad70431030b2ce25863bfad2f593091a6" title="its a truck">TRUCK</a>;
<a name="l01029"></a>01029     <span class="keywordflow">case</span> <a class="code" href="_beam_data_8h.html#a46647e26ac2740f7c5e75378391d6afba2c06c071da2a380ee12f9b383b6843d0">EVENT_AIRPLANE</a>:
<a name="l01030"></a>01030         <span class="keywordflow">return</span> b &amp;&amp; b-&gt;<a class="code" href="structrig__t.html#af5cdf2b08da0b98aed6f017ae3177444">driveable</a> == <a class="code" href="_beam_data_8h.html#ae4d5251432e1a9e6803c0240cc492e18a9e543158d0fa5b033941649d12acdfc1" title="its an airplane">AIRPLANE</a>;
<a name="l01031"></a>01031     <span class="keywordflow">case</span> <a class="code" href="_beam_data_8h.html#a46647e26ac2740f7c5e75378391d6afbac6f355f54f73699456eb445e54f9b9a5">EVENT_BOAT</a>:
<a name="l01032"></a>01032         <span class="keywordflow">return</span> b &amp;&amp; b-&gt;<a class="code" href="structrig__t.html#af5cdf2b08da0b98aed6f017ae3177444">driveable</a> == <a class="code" href="_beam_data_8h.html#ae4d5251432e1a9e6803c0240cc492e18a5fcfdc36f4798fb6ace9348a10f1e1b3" title="its a boat">BOAT</a>;
<a name="l01033"></a>01033     <span class="keywordflow">case</span> <a class="code" href="_beam_data_8h.html#a46647e26ac2740f7c5e75378391d6afba3d2ea710723c7ac5ab6c44877abc7af3">EVENT_DELETE</a>:
<a name="l01034"></a>01034         <span class="keywordflow">return</span> !b;
<a name="l01035"></a>01035     <span class="keywordflow">default</span>:
<a name="l01036"></a>01036         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01037"></a>01037     }
<a name="l01038"></a>01038 }
<a name="l01039"></a>01039 
<a name="l01040"></a><a class="code" href="class_collisions.html#a09c628d3712eeb3621520519a4c08163">01040</a> <span class="keywordtype">int</span> <a class="code" href="class_collisions.html#a09c628d3712eeb3621520519a4c08163">Collisions::enableCollisionTri</a>(<span class="keywordtype">int</span> number, <span class="keywordtype">bool</span> enable)
<a name="l01041"></a>01041 {
<a name="l01042"></a>01042     <span class="keywordflow">if</span> (number &gt; <a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>) 
<a name="l01043"></a>01043         <span class="keywordflow">return</span> -1;
<a name="l01044"></a>01044 
<a name="l01045"></a>01045     <a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[number].<a class="code" href="struct_collisions_1_1collision__tri__t.html#a0ee18c811839c7a415c09e44f9a35fe6">enabled</a> = enable;
<a name="l01046"></a>01046     
<a name="l01047"></a>01047     <span class="keywordflow">return</span> 0;
<a name="l01048"></a>01048 }
<a name="l01049"></a>01049 
<a name="l01050"></a><a class="code" href="class_collisions.html#a7d672022c769ed5db3ea6aaf08117212">01050</a> <span class="keywordtype">bool</span> <a class="code" href="class_collisions.html#a7d672022c769ed5db3ea6aaf08117212">Collisions::nodeCollision</a>(<a class="code" href="structnode__t.html">node_t</a> *node, <span class="keywordtype">bool</span> iscinecam, <span class="keywordtype">int</span> contacted, <span class="keywordtype">float</span> dt, <span class="keywordtype">float</span>* nso, <a class="code" href="structground__model__t.html">ground_model_t</a>** ogm, <span class="keywordtype">int</span> *handlernum)
<a name="l01051"></a>01051 {
<a name="l01052"></a>01052     <span class="keywordtype">bool</span> smoky = <span class="keyword">false</span>;
<a name="l01053"></a>01053     <span class="comment">// float corrf=1.0;</span>
<a name="l01054"></a>01054     <a class="code" href="struct_vector3.html">Vector3</a> oripos = node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>;
<a name="l01055"></a>01055     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k;
<a name="l01056"></a>01056     <span class="comment">// find the correct cell</span>
<a name="l01057"></a>01057     <span class="keywordtype">int</span> refx = (int)(node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.x/<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>);
<a name="l01058"></a>01058     <span class="keywordtype">int</span> refz = (int)(node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.z/<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>);
<a name="l01059"></a>01059     <a class="code" href="_collisions_8h.html#aca38c9e35e209557ac5566b0f445696d">cell_t</a> *cell = <a class="code" href="class_collisions.html#a4d438eb211fe0953343dc39f478e14e0">hash_find</a>(refx, refz);
<a name="l01060"></a>01060     <span class="comment">//LOG(&quot;Checking cell &quot;+TOSTRING(refx)+&quot; &quot;+TOSTRING(refz)+&quot; total indexes: &quot;+TOSTRING(num_cboxes_index[refp]));</span>
<a name="l01061"></a>01061 
<a name="l01062"></a>01062     <a class="code" href="struct_collisions_1_1collision__tri__t.html">collision_tri_t</a> *minctri = 0;
<a name="l01063"></a>01063     <span class="keywordtype">float</span> minctridist = 100.0;
<a name="l01064"></a>01064     <a class="code" href="struct_vector3.html">Vector3</a> minctripoint;
<a name="l01065"></a>01065 
<a name="l01066"></a>01066     <span class="keywordflow">if</span> (cell)
<a name="l01067"></a>01067     {
<a name="l01068"></a>01068         <span class="keywordflow">for</span> (k=0; k&lt;cell-&gt;size(); k++)
<a name="l01069"></a>01069         {
<a name="l01070"></a>01070             <span class="keywordflow">if</span> ((*cell)[k] != (int)<a class="code" href="class_collisions.html#a98a1a447e5f5317ed810b1ad2c3d398f">UNUSED_CELLELEMENT</a> &amp;&amp; (*cell)[k] &lt; <a class="code" href="class_collisions.html#afee2a1122b17c9daec024a08a86c5ebe">MAX_COLLISION_BOXES</a>)
<a name="l01071"></a>01071             {
<a name="l01072"></a>01072                 <a class="code" href="structcollision__box__t.html">collision_box_t</a> *cbox = &amp;<a class="code" href="class_collisions.html#a1792d7c6e15ade78504de1f7ae88f11a">collision_boxes</a>[(*cell)[k]];
<a name="l01073"></a>01073                 <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a> &gt; cbox-&gt;<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a> - node-&gt;<a class="code" href="structnode__t.html#ae4cdde058fee35314660d4cbcb5949f8">collRadius</a> &amp;&amp; node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a> &lt; cbox-&gt;<a class="code" href="structcollision__box__t.html#a9ec6254c84de43834cc76f58418c7f43" title="absolute collision box">hi</a> + node-&gt;<a class="code" href="structnode__t.html#ae4cdde058fee35314660d4cbcb5949f8">collRadius</a>)
<a name="l01074"></a>01074                 {
<a name="l01075"></a>01075                     <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#ad5a9be1b8a51c3ba2cac03d9082f1dbe">refined</a> || cbox-&gt;<a class="code" href="structcollision__box__t.html#a0e1f524e7f0c98b5f379c7ac58e048e5">selfrotated</a>)
<a name="l01076"></a>01076                     {
<a name="l01077"></a>01077                         <span class="comment">// we may have a collision, do a change of repere</span>
<a name="l01078"></a>01078                         <a class="code" href="struct_vector3.html">Vector3</a> Pos = node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>-cbox-&gt;<a class="code" href="structcollision__box__t.html#ad5543051f6fbf88976a77e9a91f0ef2b" title="center of rotation">center</a>;
<a name="l01079"></a>01079                         <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#ad5a9be1b8a51c3ba2cac03d9082f1dbe">refined</a>) Pos = cbox-&gt;<a class="code" href="structcollision__box__t.html#ae942a108071fe9c7192d049efca5c2a4" title="rotation">unrot</a>*Pos;
<a name="l01080"></a>01080                         <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#a0e1f524e7f0c98b5f379c7ac58e048e5">selfrotated</a>)
<a name="l01081"></a>01081                         {
<a name="l01082"></a>01082                             Pos=Pos-cbox-&gt;<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a>;
<a name="l01083"></a>01083                             Pos=cbox-&gt;<a class="code" href="structcollision__box__t.html#a2303a5deb886472eba840b7504dad117">selfunrot</a>*Pos;
<a name="l01084"></a>01084                             Pos=Pos+cbox-&gt;<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a>;
<a name="l01085"></a>01085                         }
<a name="l01086"></a>01086                         <span class="comment">// now test with the inner box</span>
<a name="l01087"></a>01087                         <span class="keywordflow">if</span> (Pos &gt; cbox-&gt;<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a> - node-&gt;<a class="code" href="structnode__t.html#ae4cdde058fee35314660d4cbcb5949f8">collRadius</a> &amp;&amp; Pos &lt; cbox-&gt;rehi + node-&gt;<a class="code" href="structnode__t.html#ae4cdde058fee35314660d4cbcb5949f8">collRadius</a>)
<a name="l01088"></a>01088                         {
<a name="l01089"></a>01089                             <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a>!=-1 &amp;&amp; <a class="code" href="class_collisions.html#a169c711864e32721fb5daab7d7d01df4">permitEvent</a>(cbox-&gt;<a class="code" href="structcollision__box__t.html#a61a2fca190a8ff6cc72b60e7668ac668">event_filter</a>))
<a name="l01090"></a>01090                             {
<a name="l01091"></a>01091                                 <a class="code" href="class_collisions.html#afab554d00436aa9157c93a4eaecf8d74">envokeScriptCallback</a>(cbox, node);
<a name="l01092"></a>01092                             }
<a name="l01093"></a>01093                             <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#a69512e322f0e8263d297c1f582e751ba">camforced</a> &amp;&amp; !<a class="code" href="class_collisions.html#a1d54296b1450d26f7d064b05dacd9f48">forcecam</a>)
<a name="l01094"></a>01094                             {
<a name="l01095"></a>01095                                 <a class="code" href="class_collisions.html#a1d54296b1450d26f7d064b05dacd9f48">forcecam</a>=<span class="keyword">true</span>;
<a name="l01096"></a>01096                                 <a class="code" href="class_collisions.html#a7915cbb615e807b371b031c3e5ac4b78">forcecampos</a>=cbox-&gt;<a class="code" href="structcollision__box__t.html#a2a4bba59907d49b981b70b4033cae5d8">campos</a>;
<a name="l01097"></a>01097                             }
<a name="l01098"></a>01098                             <span class="keywordflow">if</span> (!cbox-&gt;<a class="code" href="structcollision__box__t.html#a9f4e4e18026a732706583e631dddacf9">virt</a>)
<a name="l01099"></a>01099                             {
<a name="l01100"></a>01100                                 <span class="comment">// collision, process as usual</span>
<a name="l01101"></a>01101                                 <span class="comment">// we have a collision</span>
<a name="l01102"></a>01102                                 contacted++;
<a name="l01103"></a>01103                                 <span class="comment">// setup smoke</span>
<a name="l01104"></a>01104                                 <span class="comment">//float ns=node-&gt;Velocity.length();</span>
<a name="l01105"></a>01105                                 smoky=<span class="keyword">true</span>;
<a name="l01106"></a>01106                                 <span class="comment">//*nso=ns;</span>
<a name="l01107"></a>01107                                 <span class="comment">// determine which side collided</span>
<a name="l01108"></a>01108                                 <span class="keywordtype">float</span> min=Pos.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>-(cbox-&gt;<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a> - node-&gt;<a class="code" href="structnode__t.html#ae4cdde058fee35314660d4cbcb5949f8">collRadius</a>).z;
<a name="l01109"></a>01109                                 <a class="code" href="struct_vector3.html">Vector3</a> normal=<a class="code" href="struct_vector3.html">Vector3</a>(0,0,-1);
<a name="l01110"></a>01110                                 <span class="keywordtype">float</span> t=(cbox-&gt;<a class="code" href="structcollision__box__t.html#a6e337e38343e67297b6b82179fe7da6b" title="relative collision box">rehi</a> + node-&gt;<a class="code" href="structnode__t.html#ae4cdde058fee35314660d4cbcb5949f8">collRadius</a>).z-Pos.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>;
<a name="l01111"></a>01111                                 if (t&lt;min){min=t; normal=<a class="code" href="struct_vector3.html">Vector3</a>(0,0,1);}; <span class="comment">//north</span>
<a name="l01112"></a>01112                                 t=Pos.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>-(cbox-&gt;<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a> - node-&gt;<a class="code" href="structnode__t.html#ae4cdde058fee35314660d4cbcb5949f8">collRadius</a>).x;
<a name="l01113"></a>01113                                 <span class="keywordflow">if</span> (t&lt;min) {min=t; normal=<a class="code" href="struct_vector3.html">Vector3</a>(-1,0,0);}; <span class="comment">//west</span>
<a name="l01114"></a>01114                                 t=(cbox-&gt;<a class="code" href="structcollision__box__t.html#a6e337e38343e67297b6b82179fe7da6b" title="relative collision box">rehi</a> + node-&gt;<a class="code" href="structnode__t.html#ae4cdde058fee35314660d4cbcb5949f8">collRadius</a>).x-Pos.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>;
<a name="l01115"></a>01115                                 if (t&lt;min) {min=t; normal=<a class="code" href="struct_vector3.html">Vector3</a>(1,0,0);}; <span class="comment">//east</span>
<a name="l01116"></a>01116                                 t=Pos.<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a>-(cbox-&gt;<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a> - node-&gt;<a class="code" href="structnode__t.html#ae4cdde058fee35314660d4cbcb5949f8">collRadius</a>).y;
<a name="l01117"></a>01117                                 <span class="keywordflow">if</span> (t&lt;min) {min=t; normal=<a class="code" href="struct_vector3.html">Vector3</a>(0,-1,0);}; <span class="comment">//down</span>
<a name="l01118"></a>01118                                 t=(cbox-&gt;<a class="code" href="structcollision__box__t.html#a6e337e38343e67297b6b82179fe7da6b" title="relative collision box">rehi</a> + node-&gt;<a class="code" href="structnode__t.html#ae4cdde058fee35314660d4cbcb5949f8">collRadius</a>).y-Pos.<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a>;
<a name="l01119"></a>01119                                 if (t&lt;min) {min=t; normal=<a class="code" href="struct_vector3.html">Vector3</a>(0,1,0);}; <span class="comment">//up</span>
<a name="l01120"></a>01120 
<a name="l01121"></a>01121                                 <span class="comment">// we need the normal, and the depth</span>
<a name="l01122"></a>01122                                 <span class="comment">// resume repere for the normal</span>
<a name="l01123"></a>01123                                 <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#a0e1f524e7f0c98b5f379c7ac58e048e5">selfrotated</a>) normal=cbox-&gt;<a class="code" href="structcollision__box__t.html#ac4bee195d4369ec039daa878bba17da9">selfrot</a>*normal;
<a name="l01124"></a>01124                                 <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#ad5a9be1b8a51c3ba2cac03d9082f1dbe">refined</a>) normal=cbox-&gt;<a class="code" href="structcollision__box__t.html#a9c56bbd867fa23d92410daa621d7f7ca" title="rotation">rot</a>*normal;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126                                 <span class="comment">// collision boxes are always out of concrete as it seems</span>
<a name="l01127"></a>01127                                 <a class="code" href="class_collisions.html#a37fe3226d0a0ad6497c97555f1aa4b31">primitiveCollision</a>(node, node-&gt;<a class="code" href="structnode__t.html#a108f2d86dc1b3737b91614fe9c8708e0">Forces</a>, node-&gt;<a class="code" href="structnode__t.html#a4036e953a028713b07a8ccff0f7202ce">Velocity</a>, normal, dt, <a class="code" href="class_collisions.html#aa8d0184cb98d4141bccad32cc50fde1d">defaultgm</a>, nso);
<a name="l01128"></a>01128                                 <span class="keywordflow">if</span> (ogm) *ogm=<a class="code" href="class_collisions.html#aa8d0184cb98d4141bccad32cc50fde1d">defaultgm</a>;
<a name="l01129"></a>01129                                 }
<a name="l01130"></a>01130                             }
<a name="l01131"></a>01131                     } <span class="keywordflow">else</span>
<a name="l01132"></a>01132                     {
<a name="l01133"></a>01133                         <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a>!=-1 &amp;&amp; <a class="code" href="class_collisions.html#a169c711864e32721fb5daab7d7d01df4">permitEvent</a>(cbox-&gt;<a class="code" href="structcollision__box__t.html#a61a2fca190a8ff6cc72b60e7668ac668">event_filter</a>))
<a name="l01134"></a>01134                         {
<a name="l01135"></a>01135                             <a class="code" href="class_collisions.html#afab554d00436aa9157c93a4eaecf8d74">envokeScriptCallback</a>(cbox, node);
<a name="l01136"></a>01136                         }
<a name="l01137"></a>01137                         <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#a69512e322f0e8263d297c1f582e751ba">camforced</a> &amp;&amp; !<a class="code" href="class_collisions.html#a1d54296b1450d26f7d064b05dacd9f48">forcecam</a>)
<a name="l01138"></a>01138                         {
<a name="l01139"></a>01139                             <a class="code" href="class_collisions.html#a1d54296b1450d26f7d064b05dacd9f48">forcecam</a>=<span class="keyword">true</span>;
<a name="l01140"></a>01140                             <a class="code" href="class_collisions.html#a7915cbb615e807b371b031c3e5ac4b78">forcecampos</a>=cbox-&gt;<a class="code" href="structcollision__box__t.html#a2a4bba59907d49b981b70b4033cae5d8">campos</a>;
<a name="l01141"></a>01141                         }
<a name="l01142"></a>01142                         <span class="keywordflow">if</span> (!cbox-&gt;<a class="code" href="structcollision__box__t.html#a9f4e4e18026a732706583e631dddacf9">virt</a>)
<a name="l01143"></a>01143                         {
<a name="l01144"></a>01144                             <span class="comment">// we have a collision</span>
<a name="l01145"></a>01145                             contacted++;
<a name="l01146"></a>01146                             <span class="comment">// setup smoke</span>
<a name="l01147"></a>01147                             <span class="comment">//float ns=node-&gt;Velocity.length();</span>
<a name="l01148"></a>01148                             smoky=<span class="keyword">true</span>;
<a name="l01149"></a>01149                             <span class="comment">//*nso=ns;</span>
<a name="l01150"></a>01150                             <span class="comment">// determine which side collided</span>
<a name="l01151"></a>01151                             <span class="keywordtype">float</span> min=node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.z-cbox-&gt;<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a>.z;
<a name="l01152"></a>01152                             <a class="code" href="struct_vector3.html">Vector3</a> normal=<a class="code" href="struct_vector3.html">Vector3</a>(0,0,-1);
<a name="l01153"></a>01153                             <span class="keywordtype">float</span> t=cbox-&gt;<a class="code" href="structcollision__box__t.html#a9ec6254c84de43834cc76f58418c7f43" title="absolute collision box">hi</a>.z-node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.z;
<a name="l01154"></a>01154                             <span class="keywordflow">if</span> (t&lt;min) {min=t; normal=<a class="code" href="struct_vector3.html">Vector3</a>(0,0,1);}; <span class="comment">//north</span>
<a name="l01155"></a>01155                             t=node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.x-cbox-&gt;<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a>.x;
<a name="l01156"></a>01156                             <span class="keywordflow">if</span> (t&lt;min) {min=t; normal=<a class="code" href="struct_vector3.html">Vector3</a>(-1,0,0);}; <span class="comment">//west</span>
<a name="l01157"></a>01157                             t=cbox-&gt;<a class="code" href="structcollision__box__t.html#a9ec6254c84de43834cc76f58418c7f43" title="absolute collision box">hi</a>.x-node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.x;
<a name="l01158"></a>01158                             <span class="keywordflow">if</span> (t&lt;min) {min=t; normal=<a class="code" href="struct_vector3.html">Vector3</a>(1,0,0);}; <span class="comment">//east</span>
<a name="l01159"></a>01159                             t=node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.y-cbox-&gt;<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a>.y;
<a name="l01160"></a>01160                             <span class="keywordflow">if</span> (t&lt;min) {min=t; normal=<a class="code" href="struct_vector3.html">Vector3</a>(0,-1,0);}; <span class="comment">//down</span>
<a name="l01161"></a>01161                             t=cbox-&gt;<a class="code" href="structcollision__box__t.html#a9ec6254c84de43834cc76f58418c7f43" title="absolute collision box">hi</a>.y-node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.y;
<a name="l01162"></a>01162                             <span class="keywordflow">if</span> (t&lt;min) {min=t; normal=<a class="code" href="struct_vector3.html">Vector3</a>(0,1,0);}; <span class="comment">//up</span>
<a name="l01163"></a>01163                             <span class="comment">// we need the normal</span>
<a name="l01164"></a>01164                             <span class="comment">// resume repere for the normal</span>
<a name="l01165"></a>01165                             <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#a0e1f524e7f0c98b5f379c7ac58e048e5">selfrotated</a>) normal=cbox-&gt;<a class="code" href="structcollision__box__t.html#ac4bee195d4369ec039daa878bba17da9">selfrot</a>*normal;
<a name="l01166"></a>01166                             <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#ad5a9be1b8a51c3ba2cac03d9082f1dbe">refined</a>) normal=cbox-&gt;<a class="code" href="structcollision__box__t.html#a9c56bbd867fa23d92410daa621d7f7ca" title="rotation">rot</a>*normal;
<a name="l01167"></a>01167                             <a class="code" href="class_collisions.html#a37fe3226d0a0ad6497c97555f1aa4b31">primitiveCollision</a>(node, node-&gt;<a class="code" href="structnode__t.html#a108f2d86dc1b3737b91614fe9c8708e0">Forces</a>, node-&gt;<a class="code" href="structnode__t.html#a4036e953a028713b07a8ccff0f7202ce">Velocity</a>, normal, dt, <a class="code" href="class_collisions.html#aa8d0184cb98d4141bccad32cc50fde1d">defaultgm</a>, nso);
<a name="l01168"></a>01168                             <span class="keywordflow">if</span> (ogm) *ogm=<a class="code" href="class_collisions.html#aa8d0184cb98d4141bccad32cc50fde1d">defaultgm</a>;
<a name="l01169"></a>01169                         }
<a name="l01170"></a>01170                     }
<a name="l01171"></a>01171                 }
<a name="l01172"></a>01172             } <span class="keywordflow">else</span>
<a name="l01173"></a>01173             {
<a name="l01174"></a>01174                 <span class="comment">// tri collision</span>
<a name="l01175"></a>01175                 <a class="code" href="struct_collisions_1_1collision__tri__t.html">collision_tri_t</a> *ctri=&amp;<a class="code" href="class_collisions.html#ab38918b8d04aa4ee3412f36befd40b62">collision_tris</a>[(*cell)[k]-<a class="code" href="class_collisions.html#afee2a1122b17c9daec024a08a86c5ebe">MAX_COLLISION_BOXES</a>];
<a name="l01176"></a>01176                 <span class="comment">// check if this tri is minimal</span>
<a name="l01177"></a>01177                 <span class="comment">// transform</span>
<a name="l01178"></a>01178                 <a class="code" href="struct_vector3.html">Vector3</a> point=ctri-&gt;<a class="code" href="struct_collisions_1_1collision__tri__t.html#abd01fe73556b208d69f17040246522b9">forward</a>*(node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>-ctri-&gt;<a class="code" href="struct_collisions_1_1collision__tri__t.html#a44309866094911fd5a0c0733a5fe6288">a</a>);
<a name="l01179"></a>01179                 <span class="comment">// test if within tri collision volume (potential cause of bug!)</span>
<a name="l01180"></a>01180                 <span class="keywordflow">if</span> (point.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>&gt;=0 &amp;&amp; point.<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a>&gt;=0 &amp;&amp; (point.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>+point.<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a>)&lt;=1.0 &amp;&amp; point.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>&lt;0 &amp;&amp; point.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>&gt;-0.1)
<a name="l01181"></a>01181                 {
<a name="l01182"></a>01182                     <span class="keywordflow">if</span> (-point.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>&lt;minctridist)
<a name="l01183"></a>01183                     {
<a name="l01184"></a>01184                         minctridist=-point.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>;
<a name="l01185"></a>01185                         minctri=ctri;
<a name="l01186"></a>01186                         minctripoint=point;
<a name="l01187"></a>01187                     }
<a name="l01188"></a>01188                 }
<a name="l01189"></a>01189             }
<a name="l01190"></a>01190         }
<a name="l01191"></a>01191     }
<a name="l01192"></a>01192     <span class="comment">// process minctri collision</span>
<a name="l01193"></a>01193     <span class="keywordflow">if</span> (minctri)
<a name="l01194"></a>01194     {
<a name="l01195"></a>01195         <span class="comment">// we have a contact</span>
<a name="l01196"></a>01196         contacted++;
<a name="l01197"></a>01197         <span class="comment">// setup smoke</span>
<a name="l01198"></a>01198         <span class="comment">//float ns=node-&gt;Velocity.length();</span>
<a name="l01199"></a>01199         smoky=<span class="keyword">true</span>;
<a name="l01200"></a>01200         <span class="comment">//*nso=ns;</span>
<a name="l01201"></a>01201 
<a name="l01202"></a>01202         <span class="comment">// we need the normal</span>
<a name="l01203"></a>01203         <span class="comment">// resume repere for the normal</span>
<a name="l01204"></a>01204         <a class="code" href="struct_vector3.html">Vector3</a> normal=minctri-&gt;<a class="code" href="struct_collisions_1_1collision__tri__t.html#af99309e21509f90173a873e871d40b73">reverse</a>*Vector3::UNIT_Z;
<a name="l01205"></a>01205         <a class="code" href="class_collisions.html#a37fe3226d0a0ad6497c97555f1aa4b31">primitiveCollision</a>(node, node-&gt;<a class="code" href="structnode__t.html#a108f2d86dc1b3737b91614fe9c8708e0">Forces</a>, node-&gt;<a class="code" href="structnode__t.html#a4036e953a028713b07a8ccff0f7202ce">Velocity</a>, normal, dt, minctri-&gt;<a class="code" href="struct_collisions_1_1collision__tri__t.html#ae05146f8b1acdd6b1c4e80dfb20b809c">gm</a>, nso);
<a name="l01206"></a>01206         <span class="keywordflow">if</span> (ogm) *ogm=minctri-&gt;<a class="code" href="struct_collisions_1_1collision__tri__t.html#ae05146f8b1acdd6b1c4e80dfb20b809c">gm</a>;
<a name="l01207"></a>01207 <span class="preprocessor">#if 0</span>
<a name="l01208"></a>01208 <span class="preprocessor"></span>        <span class="keywordtype">float</span> depth=-minctripoint.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>;
<a name="l01209"></a>01209         <span class="comment">// compute slip velocity vector</span>
<a name="l01210"></a>01210         <a class="code" href="struct_vector3.html">Vector3</a> slip=node-&gt;<a class="code" href="structnode__t.html#a4036e953a028713b07a8ccff0f7202ce">Velocity</a>-node-&gt;<a class="code" href="structnode__t.html#a4036e953a028713b07a8ccff0f7202ce">Velocity</a>.dotProduct(normal)*normal;
<a name="l01211"></a>01211         <span class="comment">// remove the normal speed component</span>
<a name="l01212"></a>01212         node-&gt;<a class="code" href="structnode__t.html#a4036e953a028713b07a8ccff0f7202ce">Velocity</a>=slip;
<a name="l01213"></a>01213         <span class="keywordtype">float</span> slipl=slip.<a class="code" href="struct_vector3.html#a30db3d517cb422cb78a4be0cf52bc89e">length</a>();
<a name="l01214"></a>01214         <span class="keywordflow">if</span> (slipl&lt;0.5) node-&gt;<a class="code" href="structnode__t.html#a4036e953a028713b07a8ccff0f7202ce">Velocity</a>=Vector3::ZERO;
<a name="l01215"></a>01215         <span class="keywordflow">else</span>
<a name="l01216"></a>01216         {
<a name="l01217"></a>01217             <span class="keywordtype">float</span> loadfactor=(1.0-fabs(depth/corrf)*120.0);
<a name="l01218"></a>01218             <span class="keywordflow">if</span> (loadfactor&lt;0) loadfactor=0;
<a name="l01219"></a>01219             <span class="keywordtype">float</span> slipfactor=(slipl-0.5)/10.0;
<a name="l01220"></a>01220             <span class="keywordflow">if</span> (slipfactor&gt;1) slipfactor=1;
<a name="l01221"></a>01221             node-&gt;<a class="code" href="structnode__t.html#a4036e953a028713b07a8ccff0f7202ce">Velocity</a>*=loadfactor*slipfactor;
<a name="l01222"></a>01222         }
<a name="l01223"></a>01223         <span class="comment">// correct point</span>
<a name="l01224"></a>01224         minctripoint.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>=0;
<a name="l01225"></a>01225         <span class="comment">// reverse transform</span>
<a name="l01226"></a>01226         node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>=(minctri-&gt;<a class="code" href="struct_collisions_1_1collision__tri__t.html#af99309e21509f90173a873e871d40b73">reverse</a>*minctripoint)+minctri-&gt;<a class="code" href="struct_collisions_1_1collision__tri__t.html#a44309866094911fd5a0c0733a5fe6288">a</a>;
<a name="l01227"></a>01227         <span class="comment">// grip</span>
<a name="l01228"></a>01228         <span class="comment">//node-&gt;Velocity=Vector3::ZERO;</span>
<a name="l01229"></a>01229 #endif
<a name="l01230"></a>01230     }
<a name="l01231"></a>01231     <span class="comment">// correct relative position too</span>
<a name="l01232"></a>01232     <span class="keywordflow">if</span> (contacted) node-&gt;<a class="code" href="structnode__t.html#a850e3027dab6b9c2d1056f74adbeee39" title="relative to the local physics origin (one origin per truck) (shaky)">RelPosition</a>=node-&gt;<a class="code" href="structnode__t.html#a850e3027dab6b9c2d1056f74adbeee39" title="relative to the local physics origin (one origin per truck) (shaky)">RelPosition</a>+(node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>-oripos);
<a name="l01233"></a>01233     node-&gt;<a class="code" href="structnode__t.html#a721839d1265e2421b949ece3ab7f798f" title="Boolean.">contacted</a>=contacted;
<a name="l01234"></a>01234     <span class="keywordflow">return</span> smoky;
<a name="l01235"></a>01235 }
<a name="l01236"></a>01236 
<a name="l01237"></a>01237 
<a name="l01238"></a><a class="code" href="class_collisions.html#a3a6b7172dd9d63a46d03ecd9ee61a1fe">01238</a> <a class="code" href="struct_vector3.html">Vector3</a> <a class="code" href="class_collisions.html#a3a6b7172dd9d63a46d03ecd9ee61a1fe">Collisions::getPosition</a>(<span class="keyword">const</span> Ogre::String &amp;inst, <span class="keyword">const</span> Ogre::String &amp;box)
<a name="l01239"></a>01239 {
<a name="l01240"></a>01240     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>; i++)
<a name="l01241"></a>01241     {
<a name="l01242"></a>01242         <span class="keywordflow">if</span> (!strcmp(inst.c_str(), <a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[i].<a class="code" href="structeventsource__t.html#a760f787567daffcc88ee92b983a7a7fc">instancename</a>) &amp;&amp; !strcmp(box.c_str(), <a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[i].<a class="code" href="structeventsource__t.html#a067956bc39b6edee1d0310444dcd51b7">boxname</a>))
<a name="l01243"></a>01243         {
<a name="l01244"></a>01244             <span class="keywordflow">return</span> <a class="code" href="class_collisions.html#a1792d7c6e15ade78504de1f7ae88f11a">collision_boxes</a>[<a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[i].<a class="code" href="structeventsource__t.html#a2973ade596dd7dca2ba99a95e95d2dfa">cbox</a>].<a class="code" href="structcollision__box__t.html#ad5543051f6fbf88976a77e9a91f0ef2b" title="center of rotation">center</a>+<a class="code" href="class_collisions.html#a1792d7c6e15ade78504de1f7ae88f11a">collision_boxes</a>[<a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[i].<a class="code" href="structeventsource__t.html#a2973ade596dd7dca2ba99a95e95d2dfa">cbox</a>].<a class="code" href="structcollision__box__t.html#a9c56bbd867fa23d92410daa621d7f7ca" title="rotation">rot</a>*<a class="code" href="class_collisions.html#a1792d7c6e15ade78504de1f7ae88f11a">collision_boxes</a>[<a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[i].<a class="code" href="structeventsource__t.html#a2973ade596dd7dca2ba99a95e95d2dfa">cbox</a>].<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a>;
<a name="l01245"></a>01245         }
<a name="l01246"></a>01246     }
<a name="l01247"></a>01247     <span class="keywordflow">return</span> Vector3::ZERO;
<a name="l01248"></a>01248 }
<a name="l01249"></a>01249 
<a name="l01250"></a><a class="code" href="class_collisions.html#a4241fcc92d9a9deccd5ff450059ad0f1">01250</a> Quaternion <a class="code" href="class_collisions.html#a4241fcc92d9a9deccd5ff450059ad0f1">Collisions::getDirection</a>(<span class="keyword">const</span> Ogre::String &amp;inst, <span class="keyword">const</span> Ogre::String &amp;box)
<a name="l01251"></a>01251 {
<a name="l01252"></a>01252     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>; i++)
<a name="l01253"></a>01253     {
<a name="l01254"></a>01254         <span class="keywordflow">if</span> (!strcmp(inst.c_str(), <a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[i].<a class="code" href="structeventsource__t.html#a760f787567daffcc88ee92b983a7a7fc">instancename</a>) &amp;&amp; !strcmp(box.c_str(), <a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[i].<a class="code" href="structeventsource__t.html#a067956bc39b6edee1d0310444dcd51b7">boxname</a>))
<a name="l01255"></a>01255         {
<a name="l01256"></a>01256             <span class="keywordflow">return</span> <a class="code" href="class_collisions.html#a1792d7c6e15ade78504de1f7ae88f11a">collision_boxes</a>[<a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[i].<a class="code" href="structeventsource__t.html#a2973ade596dd7dca2ba99a95e95d2dfa">cbox</a>].<a class="code" href="structcollision__box__t.html#a9c56bbd867fa23d92410daa621d7f7ca" title="rotation">rot</a>*<a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[i].<a class="code" href="structeventsource__t.html#aad222236043a12d98515f09f919695ba">direction</a>;
<a name="l01257"></a>01257         }
<a name="l01258"></a>01258     }
<a name="l01259"></a>01259     <span class="keywordflow">return</span> Quaternion::ZERO;
<a name="l01260"></a>01260 }
<a name="l01261"></a>01261 
<a name="l01262"></a><a class="code" href="class_collisions.html#a0994fca40d7b1d9d2bf81b2dc2dda8f3">01262</a> <a class="code" href="structcollision__box__t.html">collision_box_t</a> *<a class="code" href="class_collisions.html#a0994fca40d7b1d9d2bf81b2dc2dda8f3">Collisions::getBox</a>(<span class="keyword">const</span> Ogre::String &amp;inst, <span class="keyword">const</span> Ogre::String &amp;box)
<a name="l01263"></a>01263 {
<a name="l01264"></a>01264     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>; i++)
<a name="l01265"></a>01265     {
<a name="l01266"></a>01266         <span class="keywordflow">if</span> (!strcmp(inst.c_str(), <a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[i].<a class="code" href="structeventsource__t.html#a760f787567daffcc88ee92b983a7a7fc">instancename</a>) &amp;&amp; !strcmp(box.c_str(), <a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[i].<a class="code" href="structeventsource__t.html#a067956bc39b6edee1d0310444dcd51b7">boxname</a>))
<a name="l01267"></a>01267         {
<a name="l01268"></a>01268             <span class="keywordflow">return</span> &amp;<a class="code" href="class_collisions.html#a1792d7c6e15ade78504de1f7ae88f11a">collision_boxes</a>[<a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[i].<a class="code" href="structeventsource__t.html#a2973ade596dd7dca2ba99a95e95d2dfa">cbox</a>];
<a name="l01269"></a>01269         }
<a name="l01270"></a>01270     }
<a name="l01271"></a>01271     <span class="keywordflow">return</span> NULL;
<a name="l01272"></a>01272 }
<a name="l01273"></a>01273 
<a name="l01274"></a><a class="code" href="class_collisions.html#a1d36e847666bf0e04f58b0c0ec0453c5">01274</a> <a class="code" href="structeventsource__t.html">eventsource_t</a> *<a class="code" href="class_collisions.html#a1d36e847666bf0e04f58b0c0ec0453c5">Collisions::isTruckInEventBox</a>(<a class="code" href="class_beam.html">Beam</a> *truck)
<a name="l01275"></a>01275 {
<a name="l01276"></a>01276     <span class="keywordflow">if</span> (!truck) <span class="keywordflow">return</span> 0;
<a name="l01277"></a>01277     <span class="comment">// check all boxes</span>
<a name="l01278"></a>01278     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="class_collisions.html#a3c8ec793d5f6cdd49790a796b78cb1d0">free_eventsource</a>; i++)
<a name="l01279"></a>01279     {
<a name="l01280"></a>01280         <a class="code" href="structcollision__box__t.html">collision_box_t</a> *cb = &amp;<a class="code" href="class_collisions.html#a1792d7c6e15ade78504de1f7ae88f11a">collision_boxes</a>[<a class="code" href="class_collisions.html#a6b5fe98f12fa96a9161d6f853d9b6889">eventsources</a>[i].<a class="code" href="structeventsource__t.html#a2973ade596dd7dca2ba99a95e95d2dfa">cbox</a>];
<a name="l01281"></a>01281 
<a name="l01282"></a>01282         <span class="keywordflow">if</span> (!cb-&gt;<a class="code" href="structcollision__box__t.html#a6497936ab1181364758f995eb3ac91a2">enabled</a>)
<a name="l01283"></a>01283             <span class="keywordflow">continue</span>;
<a name="l01284"></a>01284 
<a name="l01285"></a>01285         <span class="comment">// check all nodes</span>
<a name="l01286"></a>01286 
<a name="l01287"></a>01287         <span class="keywordtype">bool</span> allInside = <span class="keyword">true</span>;
<a name="l01288"></a>01288         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n=0; n &lt; truck-&gt;<a class="code" href="structrig__t.html#ae68ae2f82d9f90766b7a79f91f4d3ac3">free_node</a>; n++)
<a name="l01289"></a>01289         {
<a name="l01290"></a>01290             <span class="keywordflow">if</span> (!<a class="code" href="class_collisions.html#af4afe6b0f900dcf87cb6bd70e98be890">isInside</a>(truck-&gt;<a class="code" href="structrig__t.html#a204ec1dc71c3743a43ebfa278413a582">nodes</a>[n].<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>, cb))
<a name="l01291"></a>01291             {
<a name="l01292"></a>01292                 <span class="comment">// node not in box, no need to check the rest</span>
<a name="l01293"></a>01293                 allInside=<span class="keyword">false</span>;
<a name="l01294"></a>01294                 <span class="keywordflow">break</span>;
<a name="l01295"></a>01295             }
<a name="l01296"></a>01296         }
<a name="l01297"></a>01297         <span class="keywordflow">if</span> (allInside &amp;&amp; cb-&gt;<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a> != -1)
<a name="l01298"></a>01298         {
<a name="l01299"></a>01299             <span class="keywordflow">return</span> &amp;eventsources[cb-&gt;<a class="code" href="structcollision__box__t.html#aadf9ec06d4af5dedcc19d90cc358a13e">eventsourcenum</a>];
<a name="l01300"></a>01300         }
<a name="l01301"></a>01301 
<a name="l01302"></a>01302     }
<a name="l01303"></a>01303     <span class="keywordflow">return</span> 0;
<a name="l01304"></a>01304 }
<a name="l01305"></a>01305 
<a name="l01306"></a>01306 <span class="keywordtype">bool</span> <a class="code" href="class_collisions.html#af4afe6b0f900dcf87cb6bd70e98be890">Collisions::isInside</a>(<a class="code" href="struct_vector3.html">Vector3</a> pos, <span class="keyword">const</span> Ogre::String &amp;inst, <span class="keyword">const</span> Ogre::String &amp;box, <span class="keywordtype">float</span> border)
<a name="l01307"></a>01307 {
<a name="l01308"></a>01308     <a class="code" href="structcollision__box__t.html">collision_box_t</a> *cbox = <a class="code" href="class_collisions.html#a0994fca40d7b1d9d2bf81b2dc2dda8f3">getBox</a>(inst, box);
<a name="l01309"></a>01309 
<a name="l01310"></a>01310     <span class="keywordflow">return</span> <a class="code" href="class_collisions.html#af4afe6b0f900dcf87cb6bd70e98be890">isInside</a>(pos, cbox, border);
<a name="l01311"></a>01311 }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313 <span class="keywordtype">bool</span> <a class="code" href="class_collisions.html#af4afe6b0f900dcf87cb6bd70e98be890">Collisions::isInside</a>(<a class="code" href="struct_vector3.html">Vector3</a> pos, <a class="code" href="structcollision__box__t.html">collision_box_t</a> *cbox, <span class="keywordtype">float</span> border)
<a name="l01314"></a>01314 {
<a name="l01315"></a>01315     <span class="keywordflow">if</span> (!cbox) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01316"></a>01316     
<a name="l01317"></a>01317     <span class="keywordflow">if</span> (pos + border &gt; cbox-&gt;<a class="code" href="structcollision__box__t.html#a3ce245f219bf5a419ab4fed29d9f7f04" title="absolute collision box">lo</a>
<a name="l01318"></a>01318      &amp;&amp; pos - border &lt; cbox-&gt;hi)
<a name="l01319"></a>01319     {
<a name="l01320"></a>01320         <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#ad5a9be1b8a51c3ba2cac03d9082f1dbe">refined</a> || cbox-&gt;<a class="code" href="structcollision__box__t.html#a0e1f524e7f0c98b5f379c7ac58e048e5">selfrotated</a>)
<a name="l01321"></a>01321         {
<a name="l01322"></a>01322             <span class="comment">// we may have a collision, do a change of repere</span>
<a name="l01323"></a>01323             <a class="code" href="struct_vector3.html">Vector3</a> rpos = pos - cbox-&gt;<a class="code" href="structcollision__box__t.html#ad5543051f6fbf88976a77e9a91f0ef2b" title="center of rotation">center</a>;
<a name="l01324"></a>01324             <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#ad5a9be1b8a51c3ba2cac03d9082f1dbe">refined</a>)
<a name="l01325"></a>01325             {
<a name="l01326"></a>01326                 rpos = cbox-&gt;<a class="code" href="structcollision__box__t.html#ae942a108071fe9c7192d049efca5c2a4" title="rotation">unrot</a> * rpos;
<a name="l01327"></a>01327             }
<a name="l01328"></a>01328             <span class="keywordflow">if</span> (cbox-&gt;<a class="code" href="structcollision__box__t.html#a0e1f524e7f0c98b5f379c7ac58e048e5">selfrotated</a>)
<a name="l01329"></a>01329             {
<a name="l01330"></a>01330                 rpos = rpos - cbox-&gt;<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a>;
<a name="l01331"></a>01331                 rpos = cbox-&gt;<a class="code" href="structcollision__box__t.html#a2303a5deb886472eba840b7504dad117">selfunrot</a> * rpos;
<a name="l01332"></a>01332                 rpos = rpos + cbox-&gt;<a class="code" href="structcollision__box__t.html#a1c5291af624e7d15aef2b41310d4ae04">selfcenter</a>;
<a name="l01333"></a>01333             }
<a name="l01334"></a>01334             
<a name="l01335"></a>01335             <span class="comment">// now test with the inner box</span>
<a name="l01336"></a>01336             <span class="keywordflow">if</span> (rpos &gt; cbox-&gt;<a class="code" href="structcollision__box__t.html#acb1cacd40ae633496a821cb45172a9f2" title="relative collision box">relo</a>
<a name="l01337"></a>01337              &amp;&amp; rpos &lt; cbox-&gt;rehi)
<a name="l01338"></a>01338             {
<a name="l01339"></a>01339                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01340"></a>01340             }
<a name="l01341"></a>01341         } <span class="keywordflow">else</span>
<a name="l01342"></a>01342         {
<a name="l01343"></a>01343             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01344"></a>01344         }
<a name="l01345"></a>01345     }
<a name="l01346"></a>01346     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01347"></a>01347 }
<a name="l01348"></a>01348 
<a name="l01349"></a><a class="code" href="class_collisions.html#af1028e2b9de09140265d02b66654f78f">01349</a> <span class="keywordtype">bool</span> <a class="code" href="class_collisions.html#af1028e2b9de09140265d02b66654f78f">Collisions::groundCollision</a>(<a class="code" href="structnode__t.html">node_t</a> *node, <span class="keywordtype">float</span> dt, <a class="code" href="structground__model__t.html">ground_model_t</a>** ogm, <span class="keywordtype">float</span> *nso)
<a name="l01350"></a>01350 {
<a name="l01351"></a>01351     <span class="keywordflow">if</span> (!<a class="code" href="class_collisions.html#a622cf0a2757c6b8d0cc72e582d365712">hFinder</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01352"></a>01352     <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#ad3329ede724eac28a8e260ed8f801590">landuse</a>) *ogm = <a class="code" href="class_collisions.html#ad3329ede724eac28a8e260ed8f801590">landuse</a>-&gt;<a class="code" href="class_landusemap.html#ae1674c54ecba0ba42db48a919eda4ba1">getGroundModelAt</a>(node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.x, node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.z);
<a name="l01353"></a>01353     <span class="comment">// when landuse fails or we don&#39;t have it, use the default value</span>
<a name="l01354"></a>01354     <span class="keywordflow">if</span> (!*ogm) *ogm = <a class="code" href="class_collisions.html#ace408979e984d8003d614048445b9d2a">defaultgroundgm</a>;
<a name="l01355"></a>01355     <a class="code" href="class_collisions.html#a70d17d2071b877728eac3f26f69743df">last_used_ground_model</a> = *ogm;
<a name="l01356"></a>01356 
<a name="l01357"></a>01357     <span class="comment">// new ground collision code</span>
<a name="l01358"></a>01358     Real v = <a class="code" href="class_collisions.html#a622cf0a2757c6b8d0cc72e582d365712">hFinder</a>-&gt;<a class="code" href="class_i_height_finder.html#a5757ec3d639bcffc834540067ec8db2e">getHeightAt</a>(node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.x, node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.z);
<a name="l01359"></a>01359     <span class="keywordflow">if</span> (v &gt; node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.y)
<a name="l01360"></a>01360     {
<a name="l01361"></a>01361         <span class="comment">// collision!</span>
<a name="l01362"></a>01362         Ogre::Vector3 normal = <a class="code" href="class_collisions.html#a622cf0a2757c6b8d0cc72e582d365712">hFinder</a>-&gt;<a class="code" href="class_i_height_finder.html#a1e72a8b431fcce239ab01e7d77235aab">getNormalAt</a>(node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.x, v, node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.z);
<a name="l01363"></a>01363         <a class="code" href="class_collisions.html#a37fe3226d0a0ad6497c97555f1aa4b31">primitiveCollision</a>(node, node-&gt;<a class="code" href="structnode__t.html#a108f2d86dc1b3737b91614fe9c8708e0">Forces</a>, node-&gt;<a class="code" href="structnode__t.html#a4036e953a028713b07a8ccff0f7202ce">Velocity</a>, normal, dt, *ogm, nso, v-node-&gt;<a class="code" href="structnode__t.html#a5228375ba31ad0e97584638f73744a55" title="absolute position in the world (shaky)">AbsPosition</a>.y);
<a name="l01364"></a>01364         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01365"></a>01365     }
<a name="l01366"></a>01366     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01367"></a>01367 }
<a name="l01368"></a>01368 
<a name="l01369"></a><a class="code" href="class_collisions.html#a37fe3226d0a0ad6497c97555f1aa4b31">01369</a> <span class="keywordtype">void</span> <a class="code" href="class_collisions.html#a37fe3226d0a0ad6497c97555f1aa4b31">Collisions::primitiveCollision</a>(<a class="code" href="structnode__t.html">node_t</a> *node, <a class="code" href="struct_vector3.html">Vector3</a> &amp;force, <a class="code" href="struct_vector3.html">Vector3</a> &amp;velocity, <a class="code" href="struct_vector3.html">Vector3</a> &amp;normal, <span class="keywordtype">float</span> dt, <a class="code" href="structground__model__t.html">ground_model_t</a>* gm, <span class="keywordtype">float</span>* nso, <span class="keywordtype">float</span> penetration, <span class="keywordtype">float</span> reaction)
<a name="l01370"></a>01370 {
<a name="l01371"></a>01371     <span class="comment">// normal velocity</span>
<a name="l01372"></a>01372 
<a name="l01373"></a>01373     <span class="keywordtype">float</span> Vnormal = velocity.dotProduct(normal);
<a name="l01374"></a>01374 
<a name="l01375"></a>01375     <span class="comment">// if we are inside the fluid (solid ground is below us)</span>
<a name="l01376"></a>01376     <span class="keywordflow">if</span> (gm-&gt;<a class="code" href="structground__model__t.html#a9401c016470fea08d34b1b4efba4b2f8" title="how deep the solid ground is">solid_ground_level</a> != 0.0f &amp;&amp; penetration &gt;= 0)
<a name="l01377"></a>01377     {
<a name="l01378"></a>01378         <span class="keywordflow">if</span> (nso) *nso = 0.0f;
<a name="l01379"></a>01379 
<a name="l01380"></a>01380         <span class="keywordtype">float</span> Vsquared = velocity.squaredLength();
<a name="l01381"></a>01381         <span class="comment">// First of all calculate power law fluid viscosity</span>
<a name="l01382"></a>01382         <span class="keywordtype">float</span> m = gm-&gt;<a class="code" href="structground__model__t.html#ad3516a30725dee82dad34f7f48a247e3" title="general drag coefficient">flow_consistency_index</a> * <a class="code" href="_approx_math_8h.html#aa827078e74a2a2b87a97a834d2359e88">approx_pow</a>(Vsquared, (gm-&gt;<a class="code" href="structground__model__t.html#ac417d263eab180800821649fee776a83">flow_behavior_index</a> - 1.0f)*0.5f);
<a name="l01383"></a>01383 
<a name="l01384"></a>01384         <span class="comment">// Then calculate drag based on above. We&#39;are using a simplified Stokes&#39; drag.</span>
<a name="l01385"></a>01385         <span class="comment">// Per node fluid drag surface coefficient set by node property applies here</span>
<a name="l01386"></a>01386         <a class="code" href="struct_vector3.html">Vector3</a> Fdrag = velocity * (-m * node-&gt;<a class="code" href="structnode__t.html#af1f7dc09cc03753872adca7816e572b5">surface_coef</a>);
<a name="l01387"></a>01387 
<a name="l01388"></a>01388         <span class="comment">// If we have anisotropic drag</span>
<a name="l01389"></a>01389         <span class="keywordflow">if</span> (gm-&gt;<a class="code" href="structground__model__t.html#acc605a53dbac4afeae44cf702781dc47" title="Upwards/Downwards drag anisotropy.">drag_anisotropy</a> &lt; 1.0f &amp;&amp; Vnormal &gt; 0)
<a name="l01390"></a>01390         {
<a name="l01391"></a>01391             <span class="keywordtype">float</span> da_factor;
<a name="l01392"></a>01392             <span class="keywordflow">if</span> (Vsquared &gt; gm-&gt;<a class="code" href="structground__model__t.html#a3c2efbc7931b510bbded868b27c171aa" title="adhesion velocity">va</a> * gm-&gt;<a class="code" href="structground__model__t.html#a3c2efbc7931b510bbded868b27c171aa" title="adhesion velocity">va</a>)
<a name="l01393"></a>01393                 da_factor = 1.0;
<a name="l01394"></a>01394             <span class="keywordflow">else</span>
<a name="l01395"></a>01395                 da_factor = Vsquared / (gm-&gt;<a class="code" href="structground__model__t.html#a3c2efbc7931b510bbded868b27c171aa" title="adhesion velocity">va</a> * gm-&gt;<a class="code" href="structground__model__t.html#a3c2efbc7931b510bbded868b27c171aa" title="adhesion velocity">va</a>);
<a name="l01396"></a>01396             Fdrag += (Vnormal * m * (1.0f - gm-&gt;<a class="code" href="structground__model__t.html#acc605a53dbac4afeae44cf702781dc47" title="Upwards/Downwards drag anisotropy.">drag_anisotropy</a>) * da_factor) * normal;
<a name="l01397"></a>01397         }
<a name="l01398"></a>01398         force += Fdrag;
<a name="l01399"></a>01399 
<a name="l01400"></a>01400         <span class="comment">// Now calculate upwards force based on a simplified boyancy equation;</span>
<a name="l01401"></a>01401         <span class="comment">// If the fluid is pseudoplastic then boyancy is constrained to only &quot;stopping&quot; a node from going downwards</span>
<a name="l01402"></a>01402         <span class="comment">// Buoyancy per node volume coefficient set by node property applies here</span>
<a name="l01403"></a>01403         <span class="keywordtype">float</span> Fboyancy = gm-&gt;<a class="code" href="structground__model__t.html#a102bc2b2fef6ec1297caaf7622606d1e" title="Density of liquid.">fluid_density</a> * penetration * (-<a class="code" href="_beam_data_8h.html#ad5b1c98de198f6556bb8b8feeb5e0c31" title="earth gravity">DEFAULT_GRAVITY</a>) * node-&gt;<a class="code" href="structnode__t.html#a0b5dc5e5d52e4ceb38098496e2ceb889">volume_coef</a>;
<a name="l01404"></a>01404         if (gm-&gt;<a class="code" href="structground__model__t.html#ac417d263eab180800821649fee776a83">flow_behavior_index</a> &lt; 1.0f &amp;&amp; Vnormal &gt;= 0.0f)
<a name="l01405"></a>01405         {
<a name="l01406"></a>01406             <span class="keywordtype">float</span> Fnormal = force.dotProduct(normal);
<a name="l01407"></a>01407             <span class="keywordflow">if</span> (Fnormal &lt; 0 &amp;&amp; Fboyancy&gt;-Fnormal)
<a name="l01408"></a>01408             {
<a name="l01409"></a>01409                 Fboyancy = -Fnormal;
<a name="l01410"></a>01410             }
<a name="l01411"></a>01411         }
<a name="l01412"></a>01412         force += Fboyancy*normal;
<a name="l01413"></a>01413     }
<a name="l01414"></a>01414 
<a name="l01415"></a>01415     <span class="comment">// if we are inside or touching the solid ground</span>
<a name="l01416"></a>01416     <span class="keywordflow">if</span> (penetration &gt;= gm-&gt;<a class="code" href="structground__model__t.html#a9401c016470fea08d34b1b4efba4b2f8" title="how deep the solid ground is">solid_ground_level</a>)
<a name="l01417"></a>01417     {
<a name="l01418"></a>01418         <a class="code" href="struct_vector3.html">Vector3</a> slip = velocity - Vnormal*normal;
<a name="l01419"></a>01419         <span class="keywordtype">float</span> slipv = slip.squaredLength();
<a name="l01420"></a>01420         <span class="keywordflow">if</span> (fabs(slipv) &gt; 1e-08f)
<a name="l01421"></a>01421         {
<a name="l01422"></a>01422             <span class="keywordtype">float</span> invslipv = <a class="code" href="_approx_math_8h.html#a08e9e14c091640464aae072f3823b855">fast_invSqrt</a>(slipv);
<a name="l01423"></a>01423             slip = slip*invslipv;
<a name="l01424"></a>01424             slipv = slipv*invslipv;
<a name="l01425"></a>01425         } <span class="keywordflow">else</span>
<a name="l01426"></a>01426         {
<a name="l01427"></a>01427             slipv = sqrt(slipv);
<a name="l01428"></a>01428         }
<a name="l01429"></a>01429 
<a name="l01430"></a>01430         <span class="keywordflow">if</span> (nso &amp;&amp; gm-&gt;<a class="code" href="structground__model__t.html#a9401c016470fea08d34b1b4efba4b2f8" title="how deep the solid ground is">solid_ground_level</a> == 0.0f) *nso = slipv;
<a name="l01431"></a>01431 
<a name="l01432"></a>01432         <span class="keywordtype">float</span> Fnormal = 0.0f;
<a name="l01433"></a>01433         <span class="keywordtype">float</span> Fdnormal = 0.0f;
<a name="l01434"></a>01434         <span class="keywordtype">float</span> Freaction;
<a name="l01435"></a>01435         <span class="keywordtype">float</span> Greaction;
<a name="l01436"></a>01436 
<a name="l01437"></a>01437         Fnormal = force.dotProduct(normal);
<a name="l01438"></a>01438         Fdnormal = Fnormal;
<a name="l01439"></a>01439 
<a name="l01440"></a>01440         <span class="comment">// steady force</span>
<a name="l01441"></a>01441         <span class="keywordflow">if</span> (reaction &lt; 0)
<a name="l01442"></a>01442         {
<a name="l01443"></a>01443             Freaction = -Fnormal;
<a name="l01444"></a>01444             <span class="comment">// impact force</span>
<a name="l01445"></a>01445             <span class="keywordflow">if</span> (Vnormal &lt; 0)
<a name="l01446"></a>01446             {
<a name="l01447"></a>01447                 Freaction += -Vnormal * node-&gt;<a class="code" href="structnode__t.html#a4c5024a6f4ca1cb81ae59505e429b017">mass</a> / dt; <span class="comment">// Newton&#39;s second law</span>
<a name="l01448"></a>01448             }
<a name="l01449"></a>01449             <span class="keywordflow">if</span> (Freaction &lt; 0) Freaction = 0.0f;
<a name="l01450"></a>01450         } <span class="keywordflow">else</span>
<a name="l01451"></a>01451         {
<a name="l01452"></a>01452             Freaction = reaction;
<a name="l01453"></a>01453             Fnormal = 0.0f;
<a name="l01454"></a>01454         }
<a name="l01455"></a>01455         <span class="keywordtype">float</span> ff;
<a name="l01456"></a>01456         <span class="comment">// If the velocity that we slip is lower than adhesion velocity and</span>
<a name="l01457"></a>01457         <span class="comment">// we have a downforce and the slip forces are lower than static friction</span>
<a name="l01458"></a>01458         <span class="comment">// forces then it&#39;s time to go into static friction physics mode.</span>
<a name="l01459"></a>01459         <span class="comment">// This code is a direct translation of textbook static friction physics</span>
<a name="l01460"></a>01460         Greaction = (Freaction * gm-&gt;<a class="code" href="structground__model__t.html#a64076e9e2522ba1b2da9c761a3258dcf" title="ground strength">strength</a> * node-&gt;<a class="code" href="structnode__t.html#a9fdd212bac0c687d81bd3e4fd2b099fb">friction_coef</a>); <span class="comment">//General moderated reaction, node property sets friction_coef as a pernodefriction setting</span>
<a name="l01461"></a>01461         <span class="keywordtype">float</span> msGreaction = (gm-&gt;<a class="code" href="structground__model__t.html#ae90da116c88cbb3294ac28c716904a28" title="static friction coefficient">ms</a>) * Greaction;
<a name="l01462"></a>01462         <span class="keywordflow">if</span> (slipv &lt; (gm-&gt;<a class="code" href="structground__model__t.html#a3c2efbc7931b510bbded868b27c171aa" title="adhesion velocity">va</a>) &amp;&amp; Greaction &gt; 0.0f &amp;&amp; (force - Fdnormal * normal).squaredLength() &lt;= msGreaction * msGreaction)
<a name="l01463"></a>01463         {
<a name="l01464"></a>01464             <span class="comment">// Static friction model (with a little smoothing to help the integrator deal with it)</span>
<a name="l01465"></a>01465             ff = -msGreaction * (1.0f - <a class="code" href="_approx_math_8h.html#a9f32a288dbece202a4eaa1808aad5506">approx_exp</a>(-slipv / gm-&gt;<a class="code" href="structground__model__t.html#a3c2efbc7931b510bbded868b27c171aa" title="adhesion velocity">va</a>));
<a name="l01466"></a>01466             force = (Fnormal + Freaction) * normal + ff*slip;
<a name="l01467"></a>01467         } <span class="keywordflow">else</span>
<a name="l01468"></a>01468         {
<a name="l01469"></a>01469             <span class="comment">// Stribek model. It also comes directly from textbooks.</span>
<a name="l01470"></a>01470             <span class="keywordtype">float</span> g = gm-&gt;<a class="code" href="structground__model__t.html#aadfe3a71edb757646b4c5e04d50ae53e" title="sliding friction coefficient">mc</a> + (gm-&gt;<a class="code" href="structground__model__t.html#ae90da116c88cbb3294ac28c716904a28" title="static friction coefficient">ms</a> - gm-&gt;<a class="code" href="structground__model__t.html#aadfe3a71edb757646b4c5e04d50ae53e" title="sliding friction coefficient">mc</a>) * std::min(1.0f, <a class="code" href="_approx_math_8h.html#a9f32a288dbece202a4eaa1808aad5506">approx_exp</a>(-<a class="code" href="_approx_math_8h.html#aa827078e74a2a2b87a97a834d2359e88">approx_pow</a>(slipv / gm-&gt;<a class="code" href="structground__model__t.html#aa84ff905dba3a065f3674a9c187b1cbb" title="stribeck velocity (m/s)">vs</a>, gm-&gt;<a class="code" href="structground__model__t.html#ac5b1e489b7a5bb9e6e296b0299e7eb4e" title="steady-steady">alpha</a>)));
<a name="l01471"></a>01471             ff = -(g + gm-&gt;<a class="code" href="structground__model__t.html#ade83e1a631b8a74e357b750444342158" title="hydrodynamic friction (s/m)">t2</a> * slipv) * Greaction;
<a name="l01472"></a>01472             force += Freaction * normal + ff*slip;
<a name="l01473"></a>01473         }
<a name="l01474"></a>01474     }
<a name="l01475"></a>01475 }
<a name="l01476"></a>01476 
<a name="l01477"></a><a class="code" href="class_collisions.html#a671f48109ee3e019d5eb10cc93ea3383">01477</a> <span class="keywordtype">int</span> <a class="code" href="class_collisions.html#a671f48109ee3e019d5eb10cc93ea3383">Collisions::createCollisionDebugVisualization</a>()
<a name="l01478"></a>01478 {
<a name="l01479"></a>01479     <a class="code" href="_ro_r_prerequisites_8h.html#af855c94dc540e943632089ce7496faac">LOG</a>(<span class="stringliteral">&quot;COLL: Creating collision debug visualization ...&quot;</span>);
<a name="l01480"></a>01480 
<a name="l01481"></a>01481     <span class="keyword">static</span> <span class="keywordtype">int</span> loaded = 0;
<a name="l01482"></a>01482     <span class="comment">// prevent double calling</span>
<a name="l01483"></a>01483     <span class="keywordflow">if</span> (loaded != 0) <span class="keywordflow">return</span> -1;
<a name="l01484"></a>01484 
<a name="l01485"></a>01485     <span class="comment">// create materials</span>
<a name="l01486"></a>01486     <span class="keywordtype">int</span> i = 0;
<a name="l01487"></a>01487     <span class="keywordtype">char</span> bname[256];
<a name="l01488"></a>01488     <span class="keywordflow">for</span> (i=0;i&lt;=100;i++)
<a name="l01489"></a>01489     {
<a name="l01490"></a>01490         <span class="comment">// register a material for skeleton view</span>
<a name="l01491"></a>01491         sprintf(bname, <span class="stringliteral">&quot;mat-coll-dbg-%d&quot;</span>, i);
<a name="l01492"></a>01492         MaterialPtr mat=(MaterialPtr)(MaterialManager::getSingleton().create(bname, ResourceGroupManager::DEFAULT_RESOURCE_GROUP_NAME));
<a name="l01493"></a>01493         <span class="keywordtype">float</span> f = fabs(((<span class="keywordtype">float</span>)i)/100);
<a name="l01494"></a>01494         Pass *p = mat-&gt;getTechnique(0)-&gt;getPass(0); <span class="comment">//</span>
<a name="l01495"></a>01495         p-&gt;createTextureUnitState()-&gt;setColourOperationEx(LBX_MODULATE, LBS_MANUAL, LBS_CURRENT, ColourValue(f*2.0, 2.0*(1.0-f), 0.2, 0.7));
<a name="l01496"></a>01496         p-&gt;setSceneBlending(Ogre::SBT_TRANSPARENT_ALPHA);
<a name="l01497"></a>01497         p-&gt;setLightingEnabled(<span class="keyword">false</span>);
<a name="l01498"></a>01498         p-&gt;setDepthWriteEnabled(<span class="keyword">false</span>);
<a name="l01499"></a>01499         p-&gt;setDepthBias(3, 3);
<a name="l01500"></a>01500         p-&gt;setCullingMode(Ogre::CULL_NONE);
<a name="l01501"></a>01501 
<a name="l01502"></a>01502         Pass *p2 = mat-&gt;getTechnique(0)-&gt;createPass();
<a name="l01503"></a>01503         p2-&gt;setSceneBlending(Ogre::SBT_TRANSPARENT_ALPHA);
<a name="l01504"></a>01504         p2-&gt;setLightingEnabled(<span class="keyword">false</span>);
<a name="l01505"></a>01505         p2-&gt;setDepthWriteEnabled(<span class="keyword">false</span>);
<a name="l01506"></a>01506         p2-&gt;setDepthBias(3, 3);
<a name="l01507"></a>01507         p2-&gt;setCullingMode(Ogre::CULL_NONE);
<a name="l01508"></a>01508         p2-&gt;setSceneBlending(Ogre::SBT_TRANSPARENT_ALPHA);
<a name="l01509"></a>01509         TextureUnitState *tus2 = p2-&gt;createTextureUnitState();
<a name="l01510"></a>01510         tus2-&gt;setTextureName(<span class="stringliteral">&quot;tile.png&quot;</span>);
<a name="l01511"></a>01511 
<a name="l01512"></a>01512 
<a name="l01513"></a>01513         mat-&gt;setLightingEnabled(<span class="keyword">false</span>);
<a name="l01514"></a>01514         mat-&gt;setReceiveShadows(<span class="keyword">false</span>);
<a name="l01515"></a>01515     }
<a name="l01516"></a>01516 
<a name="l01517"></a>01517     <a class="code" href="struct_vector3.html">Vector3</a> mapSize = <a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#a23825f69e60897a660d18659399e0de2">terrainManager</a>-&gt;<a class="code" href="class_terrain_manager.html#a41fdd66a57990a5fb33d253213fd04e3">getMaxTerrainSize</a>();
<a name="l01518"></a>01518     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x=0; x&lt;(int)(mapSize.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>); x+=(int)<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>)
<a name="l01519"></a>01519     {
<a name="l01520"></a>01520         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> z=0; z&lt;(int)(mapSize.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>); z+=(int)<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>)
<a name="l01521"></a>01521         {
<a name="l01522"></a>01522             <span class="keywordtype">int</span> cellx = (int)(x/(<span class="keywordtype">float</span>)<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>);
<a name="l01523"></a>01523             <span class="keywordtype">int</span> cellz = (int)(z/(<span class="keywordtype">float</span>)<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>);
<a name="l01524"></a>01524             <a class="code" href="_collisions_8h.html#aca38c9e35e209557ac5566b0f445696d">cell_t</a> *cell=<a class="code" href="class_collisions.html#a4d438eb211fe0953343dc39f478e14e0">hash_find</a>(cellx, cellz);
<a name="l01525"></a>01525             <span class="keywordflow">if</span> (cell)
<a name="l01526"></a>01526             {
<a name="l01527"></a>01527                 <span class="keywordtype">float</span> groundheight = -9999;
<a name="l01528"></a>01528                 <span class="keywordtype">float</span> x2 = x+<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>;
<a name="l01529"></a>01529                 <span class="keywordtype">float</span> z2 = z+<a class="code" href="class_collisions.html#a601e3f51cfb554e7a72bb31fef81fd32">CELL_SIZE</a>;
<a name="l01530"></a>01530 
<a name="l01531"></a>01531                 <span class="comment">// find a good ground height for all corners of the cell ...</span>
<a name="l01532"></a>01532                 Real h1=<a class="code" href="class_collisions.html#a622cf0a2757c6b8d0cc72e582d365712">hFinder</a>-&gt;<a class="code" href="class_i_height_finder.html#a5757ec3d639bcffc834540067ec8db2e">getHeightAt</a>(x, z);
<a name="l01533"></a>01533                 Real h2=<a class="code" href="class_collisions.html#a622cf0a2757c6b8d0cc72e582d365712">hFinder</a>-&gt;<a class="code" href="class_i_height_finder.html#a5757ec3d639bcffc834540067ec8db2e">getHeightAt</a>(x2, z);
<a name="l01534"></a>01534                 Real h3=<a class="code" href="class_collisions.html#a622cf0a2757c6b8d0cc72e582d365712">hFinder</a>-&gt;<a class="code" href="class_i_height_finder.html#a5757ec3d639bcffc834540067ec8db2e">getHeightAt</a>(x, z2);
<a name="l01535"></a>01535                 Real h4=<a class="code" href="class_collisions.html#a622cf0a2757c6b8d0cc72e582d365712">hFinder</a>-&gt;<a class="code" href="class_i_height_finder.html#a5757ec3d639bcffc834540067ec8db2e">getHeightAt</a>(x2, z2);
<a name="l01536"></a>01536                 <span class="keywordflow">if</span> (h1&gt;groundheight)
<a name="l01537"></a>01537                     groundheight = h1;
<a name="l01538"></a>01538                 <span class="keywordflow">if</span> (h2&gt;groundheight)
<a name="l01539"></a>01539                     groundheight = h2;
<a name="l01540"></a>01540                 <span class="keywordflow">if</span> (h3&gt;groundheight)
<a name="l01541"></a>01541                     groundheight = h3;
<a name="l01542"></a>01542                 <span class="keywordflow">if</span> (h4&gt;groundheight)
<a name="l01543"></a>01543                     groundheight = h4;
<a name="l01544"></a>01544                 groundheight+=0.1; <span class="comment">// 10 cm hover</span>
<a name="l01545"></a>01545                 <span class="comment">// ground height should fit</span>
<a name="l01546"></a>01546 
<a name="l01547"></a>01547                 <span class="comment">//int deep = 0;</span>
<a name="l01548"></a>01548                 <span class="keywordtype">int</span> cc = (int)cell-&gt;size();
<a name="l01549"></a>01549                 <span class="keywordtype">float</span> percent = cc / (float)<a class="code" href="class_collisions.html#a74d0b503aa98ea6b610246f4b95614e8">CELL_BLOCKSIZE</a>;
<a name="l01550"></a>01550 
<a name="l01551"></a>01551                 <span class="keywordtype">float</span> percentd = percent;
<a name="l01552"></a>01552                 <span class="keywordflow">if</span> (percentd &gt; 1) percentd = 1;
<a name="l01553"></a>01553                 String matName = <span class="stringliteral">&quot;mat-coll-dbg-&quot;</span>+<a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>((<span class="keywordtype">int</span>)(percentd*100));
<a name="l01554"></a>01554                 String cell_name=<span class="stringliteral">&quot;(&quot;</span>+<a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(cellx)+<span class="stringliteral">&quot;,&quot;</span>+ <a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(cellz)+<span class="stringliteral">&quot;)&quot;</span>;
<a name="l01555"></a>01555 
<a name="l01556"></a>01556                 ManualObject *mo =  <a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#af1dd98dd6dbe5353a6a0b7bd2a2e42ee">sceneManager</a>-&gt;createManualObject(<span class="stringliteral">&quot;collisionDebugVisualization&quot;</span>+cell_name);
<a name="l01557"></a>01557                 SceneNode *mo_node = <a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#af1dd98dd6dbe5353a6a0b7bd2a2e42ee">sceneManager</a>-&gt;getRootSceneNode()-&gt;createChildSceneNode(<span class="stringliteral">&quot;collisionDebugVisualization_node&quot;</span>+cell_name);
<a name="l01558"></a>01558 
<a name="l01559"></a>01559                 mo-&gt;begin(matName, Ogre::RenderOperation::OT_TRIANGLE_LIST);
<a name="l01560"></a>01560 
<a name="l01561"></a>01561                 <span class="comment">// 1st tri</span>
<a name="l01562"></a>01562                 mo-&gt;position(-CELL_SIZE/(<span class="keywordtype">float</span>)2.0, 0, -CELL_SIZE/(<span class="keywordtype">float</span>)2.0);
<a name="l01563"></a>01563                 mo-&gt;textureCoord(0,0);
<a name="l01564"></a>01564 
<a name="l01565"></a>01565                 mo-&gt;position(CELL_SIZE/(<span class="keywordtype">float</span>)2.0, 0, CELL_SIZE/(<span class="keywordtype">float</span>)2.0);
<a name="l01566"></a>01566                 mo-&gt;textureCoord(1,1);
<a name="l01567"></a>01567 
<a name="l01568"></a>01568                 mo-&gt;position(CELL_SIZE/(<span class="keywordtype">float</span>)2.0, 0, -CELL_SIZE/(<span class="keywordtype">float</span>)2.0);
<a name="l01569"></a>01569                 mo-&gt;textureCoord(1,0);
<a name="l01570"></a>01570 
<a name="l01571"></a>01571                 <span class="comment">// 2nd tri</span>
<a name="l01572"></a>01572                 mo-&gt;position(-CELL_SIZE/(<span class="keywordtype">float</span>)2.0, 0, CELL_SIZE/(<span class="keywordtype">float</span>)2.0);
<a name="l01573"></a>01573                 mo-&gt;textureCoord(0,1);
<a name="l01574"></a>01574 
<a name="l01575"></a>01575                 mo-&gt;position(CELL_SIZE/(<span class="keywordtype">float</span>)2.0, 0, CELL_SIZE/(<span class="keywordtype">float</span>)2.0);
<a name="l01576"></a>01576                 mo-&gt;textureCoord(1,1);
<a name="l01577"></a>01577 
<a name="l01578"></a>01578                 mo-&gt;position(-CELL_SIZE/(<span class="keywordtype">float</span>)2.0, 0, -CELL_SIZE/(<span class="keywordtype">float</span>)2.0);
<a name="l01579"></a>01579                 mo-&gt;textureCoord(0,0);
<a name="l01580"></a>01580 
<a name="l01581"></a>01581                 mo-&gt;end();
<a name="l01582"></a>01582                 mo-&gt;setBoundingBox(AxisAlignedBox(0, 0, 0, CELL_SIZE, 1, CELL_SIZE));
<a name="l01583"></a>01583                 mo_node-&gt;attachObject(mo);
<a name="l01584"></a>01584 
<a name="l01585"></a>01585 <span class="preprocessor">#if 0</span>
<a name="l01586"></a>01586 <span class="preprocessor"></span>                <span class="comment">// setup the label</span>
<a name="l01587"></a>01587                 String labelName = <span class="stringliteral">&quot;label_&quot;</span>+cell_name;
<a name="l01588"></a>01588                 String labelCaption = cell_name+<span class="stringliteral">&quot; &quot;</span>+<a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(percent*100,2) + <span class="stringliteral">&quot;% usage (&quot;</span>+<a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(cc)+<span class="stringliteral">&quot;/&quot;</span>+<a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(<a class="code" href="class_collisions.html#a74d0b503aa98ea6b610246f4b95614e8">CELL_BLOCKSIZE</a>)+<span class="stringliteral">&quot;) DEEP: &quot;</span> + <a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(deep);
<a name="l01589"></a>01589                 <a class="code" href="class_ogre_1_1_movable_text.html">MovableText</a> *mt = <span class="keyword">new</span> <a class="code" href="class_ogre_1_1_movable_text.html">MovableText</a>(labelName, labelCaption);
<a name="l01590"></a>01590                 mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#aed27a49ecadb3905afb7b5de4409d799">setFontName</a>(<span class="stringliteral">&quot;highcontrast_black&quot;</span>);
<a name="l01591"></a>01591                 mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a8fc0b2d13ba89695e53152ad1c435306">setTextAlignment</a>(MovableText::H_CENTER, MovableText::V_ABOVE);
<a name="l01592"></a>01592                 mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a0e4f2340efd854e591e07fb4bebcbeaa">setAdditionalHeight</a>(1);
<a name="l01593"></a>01593                 mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a88bb2321dd352795dfeff306928e48bc">showOnTop</a>(<span class="keyword">false</span>);
<a name="l01594"></a>01594                 mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a0562e7c4341e263ae6e9d55f91643ade">setCharacterHeight</a>(0.3);
<a name="l01595"></a>01595                 mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a7ed5e440d32fee6180e6eaa7094b3f5c">setColor</a>(ColourValue::Black);
<a name="l01596"></a>01596                 mo_node-&gt;attachObject(mt);
<a name="l01597"></a>01597 <span class="preprocessor">#endif</span>
<a name="l01598"></a>01598 <span class="preprocessor"></span>
<a name="l01599"></a>01599                 mo_node-&gt;setVisible(<span class="keyword">true</span>);
<a name="l01600"></a>01600                 mo_node-&gt;setPosition(<a class="code" href="struct_vector3.html">Vector3</a>(x+CELL_SIZE/(<span class="keywordtype">float</span>)2.0, groundheight, z+CELL_SIZE/(<span class="keywordtype">float</span>)2.0));
<a name="l01601"></a>01601             }
<a name="l01602"></a>01602         }
<a name="l01603"></a>01603     }
<a name="l01604"></a>01604 
<a name="l01605"></a>01605     loaded = 1;
<a name="l01606"></a>01606     <span class="keywordflow">return</span> 0;
<a name="l01607"></a>01607 }
<a name="l01608"></a>01608 
<a name="l01609"></a><a class="code" href="class_collisions.html#a285399f2b679c1d0b649b71aa805d5f3">01609</a> <span class="keywordtype">int</span> <a class="code" href="class_collisions.html#a285399f2b679c1d0b649b71aa805d5f3">Collisions::addCollisionMesh</a>(Ogre::String meshname, Ogre::Vector3 pos, Ogre::Quaternion q, Ogre::Vector3 scale, <a class="code" href="structground__model__t.html">ground_model_t</a> *gm, std::vector&lt;int&gt; *collTris)
<a name="l01610"></a>01610 {
<a name="l01611"></a>01611     <span class="comment">// normal, non virtual collision box</span>
<a name="l01612"></a>01612     Entity *ent = <a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#af1dd98dd6dbe5353a6a0b7bd2a2e42ee">sceneManager</a>-&gt;createEntity(meshname);
<a name="l01613"></a>01613     ent-&gt;setMaterialName(<span class="stringliteral">&quot;tracks/debug/collision/mesh&quot;</span>);
<a name="l01614"></a>01614 
<a name="l01615"></a>01615     <span class="keywordflow">if</span> (!gm)
<a name="l01616"></a>01616     {
<a name="l01617"></a>01617         gm = <a class="code" href="class_collisions.html#a7840c7d5b2b56b4cc8f41778c0edb7a7">getGroundModelByString</a>(<span class="stringliteral">&quot;concrete&quot;</span>);
<a name="l01618"></a>01618     }
<a name="l01619"></a>01619 
<a name="l01620"></a>01620     <span class="keywordtype">size_t</span> vertex_count,index_count;
<a name="l01621"></a>01621     <a class="code" href="struct_vector3.html">Vector3</a>* vertices;
<a name="l01622"></a>01622     <span class="keywordtype">unsigned</span>* indices;
<a name="l01623"></a>01623 
<a name="l01624"></a>01624     <a class="code" href="class_collisions.html#a2ef942fa770bd57c5638465d58bed210">getMeshInformation</a>(ent-&gt;getMesh().getPointer(),vertex_count,vertices,index_count,indices, pos, q, scale);
<a name="l01625"></a>01625 
<a name="l01626"></a>01626     <span class="comment">//LOG(LML_NORMAL,&quot;Vertices in mesh: %u&quot;,vertex_count);</span>
<a name="l01627"></a>01627     <span class="comment">//LOG(LML_NORMAL,&quot;Triangles in mesh: %u&quot;,index_count / 3);</span>
<a name="l01628"></a>01628     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;(int)index_count/3; i++)
<a name="l01629"></a>01629     {
<a name="l01630"></a>01630         <span class="keywordtype">int</span> triID = <a class="code" href="class_collisions.html#a44e7f403a680e597a54209b2873b6e28">addCollisionTri</a>(vertices[indices[i*3]], vertices[indices[i*3+1]], vertices[indices[i*3+2]], gm);
<a name="l01631"></a>01631         <span class="keywordflow">if</span> (collTris)
<a name="l01632"></a>01632             collTris-&gt;push_back(triID);
<a name="l01633"></a>01633     }
<a name="l01634"></a>01634 
<a name="l01635"></a>01635     <span class="keyword">delete</span>[] vertices;
<a name="l01636"></a>01636     <span class="keyword">delete</span>[] indices;
<a name="l01637"></a>01637     <span class="keywordflow">if</span> (!<a class="code" href="class_collisions.html#ac22cd0e0bf7bc504f7974244801cb175">debugMode</a>)
<a name="l01638"></a>01638     {
<a name="l01639"></a>01639         <a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#af1dd98dd6dbe5353a6a0b7bd2a2e42ee">sceneManager</a>-&gt;destroyEntity(ent);
<a name="l01640"></a>01640     } <span class="keywordflow">else</span>
<a name="l01641"></a>01641     {
<a name="l01642"></a>01642         SceneNode *n=<a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#af1dd98dd6dbe5353a6a0b7bd2a2e42ee">sceneManager</a>-&gt;getRootSceneNode()-&gt;createChildSceneNode();
<a name="l01643"></a>01643         n-&gt;attachObject(ent);
<a name="l01644"></a>01644         n-&gt;setPosition(pos);
<a name="l01645"></a>01645         n-&gt;setScale(scale);
<a name="l01646"></a>01646         n-&gt;setOrientation(q);
<a name="l01647"></a>01647     
<a name="l01648"></a>01648         String labelName = <span class="stringliteral">&quot;collision_mesh_label_&quot;</span>+<a class="code" href="_ro_r_prerequisites_8h.html#a9063e80f8777300c93afde6e6f4c9cea">TOSTRING</a>(<a class="code" href="class_collisions.html#a0f44e68aae35fdc8e8188a6e5e6392e5">free_collision_tri</a>);
<a name="l01649"></a>01649         String labelCaption = <span class="stringliteral">&quot;COLLMESH\nmeshname:&quot;</span>+meshname + <span class="stringliteral">&quot;\ngroundmodel:&quot;</span> + String(gm-&gt;<a class="code" href="structground__model__t.html#afea47c52a768b30dbd001cd0fd98f67e">name</a>);
<a name="l01650"></a>01650         <a class="code" href="class_ogre_1_1_movable_text.html">MovableText</a> *mt = <span class="keyword">new</span> <a class="code" href="class_ogre_1_1_movable_text.html">MovableText</a>(labelName, labelCaption);
<a name="l01651"></a>01651         mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#aed27a49ecadb3905afb7b5de4409d799">setFontName</a>(<span class="stringliteral">&quot;highcontrast_black&quot;</span>);
<a name="l01652"></a>01652         mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a8fc0b2d13ba89695e53152ad1c435306">setTextAlignment</a>(MovableText::H_CENTER, MovableText::V_ABOVE);
<a name="l01653"></a>01653         mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a0e4f2340efd854e591e07fb4bebcbeaa">setAdditionalHeight</a>(1);
<a name="l01654"></a>01654         mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a88bb2321dd352795dfeff306928e48bc">showOnTop</a>(<span class="keyword">false</span>);
<a name="l01655"></a>01655         mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a0562e7c4341e263ae6e9d55f91643ade">setCharacterHeight</a>(0.3);
<a name="l01656"></a>01656         mt-&gt;<a class="code" href="class_ogre_1_1_movable_text.html#a7ed5e440d32fee6180e6eaa7094b3f5c">setColor</a>(ColourValue::Black);
<a name="l01657"></a>01657         mt-&gt;setRenderingDistance(200);
<a name="l01658"></a>01658         
<a name="l01659"></a>01659         n-&gt;attachObject(mt);
<a name="l01660"></a>01660     }
<a name="l01661"></a>01661     <span class="keywordflow">return</span> 0;
<a name="l01662"></a>01662 }
<a name="l01663"></a>01663 
<a name="l01664"></a><a class="code" href="class_collisions.html#a2ef942fa770bd57c5638465d58bed210">01664</a> <span class="keywordtype">void</span> <a class="code" href="class_collisions.html#a2ef942fa770bd57c5638465d58bed210">Collisions::getMeshInformation</a>(Mesh* mesh,<span class="keywordtype">size_t</span> &amp;vertex_count,<a class="code" href="struct_vector3.html">Vector3</a>* &amp;vertices,
<a name="l01665"></a>01665                                               <span class="keywordtype">size_t</span> &amp;index_count, <span class="keywordtype">unsigned</span>* &amp;indices,
<a name="l01666"></a>01666                                               <span class="keyword">const</span> <a class="code" href="struct_vector3.html">Vector3</a> &amp;position,
<a name="l01667"></a>01667                                               <span class="keyword">const</span> Quaternion &amp;orient,<span class="keyword">const</span> <a class="code" href="struct_vector3.html">Vector3</a> &amp;scale)
<a name="l01668"></a>01668 {
<a name="l01669"></a>01669     vertex_count = index_count = 0;
<a name="l01670"></a>01670 
<a name="l01671"></a>01671     <span class="keywordtype">bool</span> added_shared = <span class="keyword">false</span>;
<a name="l01672"></a>01672     <span class="keywordtype">size_t</span> current_offset = vertex_count;
<a name="l01673"></a>01673     <span class="keywordtype">size_t</span> shared_offset = vertex_count;
<a name="l01674"></a>01674     <span class="keywordtype">size_t</span> next_offset = vertex_count;
<a name="l01675"></a>01675     <span class="keywordtype">size_t</span> index_offset = index_count;
<a name="l01676"></a>01676     <span class="comment">//size_t prev_vert = vertex_count;</span>
<a name="l01677"></a>01677     <span class="comment">//size_t prev_ind = index_count;</span>
<a name="l01678"></a>01678 
<a name="l01679"></a>01679     <span class="comment">// Calculate how many vertices and indices we&#39;re going to need</span>
<a name="l01680"></a>01680     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;i &lt; mesh-&gt;getNumSubMeshes();i++)
<a name="l01681"></a>01681     {
<a name="l01682"></a>01682         SubMesh* submesh = mesh-&gt;getSubMesh(i);
<a name="l01683"></a>01683 
<a name="l01684"></a>01684         <span class="comment">// We only need to add the shared vertices once</span>
<a name="l01685"></a>01685         <span class="keywordflow">if</span> (submesh-&gt;useSharedVertices)
<a name="l01686"></a>01686         {
<a name="l01687"></a>01687             <span class="keywordflow">if</span> (!added_shared)
<a name="l01688"></a>01688             {
<a name="l01689"></a>01689                 VertexData* vertex_data = mesh-&gt;sharedVertexData;
<a name="l01690"></a>01690                 vertex_count += vertex_data-&gt;vertexCount;
<a name="l01691"></a>01691                 added_shared = <span class="keyword">true</span>;
<a name="l01692"></a>01692             }
<a name="l01693"></a>01693         } <span class="keywordflow">else</span>
<a name="l01694"></a>01694         {
<a name="l01695"></a>01695             VertexData* vertex_data = submesh-&gt;vertexData;
<a name="l01696"></a>01696             vertex_count += vertex_data-&gt;vertexCount;
<a name="l01697"></a>01697         }
<a name="l01698"></a>01698 
<a name="l01699"></a>01699         <span class="comment">// Add the indices</span>
<a name="l01700"></a>01700         Ogre::IndexData* index_data = submesh-&gt;indexData;
<a name="l01701"></a>01701         index_count += index_data-&gt;indexCount;
<a name="l01702"></a>01702     }
<a name="l01703"></a>01703 
<a name="l01704"></a>01704     <span class="comment">// Allocate space for the vertices and indices</span>
<a name="l01705"></a>01705     vertices = <span class="keyword">new</span> <a class="code" href="struct_vector3.html">Vector3</a>[vertex_count];
<a name="l01706"></a>01706     indices = <span class="keyword">new</span> <span class="keywordtype">unsigned</span>[index_count];
<a name="l01707"></a>01707 
<a name="l01708"></a>01708     added_shared = <span class="keyword">false</span>;
<a name="l01709"></a>01709 
<a name="l01710"></a>01710     <span class="comment">// Run through the sub-meshes again, adding the data into the arrays</span>
<a name="l01711"></a>01711     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;i &lt; mesh-&gt;getNumSubMeshes();i++)
<a name="l01712"></a>01712     {
<a name="l01713"></a>01713         SubMesh* submesh = mesh-&gt;getSubMesh(i);
<a name="l01714"></a>01714 
<a name="l01715"></a>01715         Ogre::VertexData* vertex_data = submesh-&gt;useSharedVertices ? mesh-&gt;sharedVertexData : submesh-&gt;vertexData;
<a name="l01716"></a>01716         <span class="keywordflow">if</span> ((!submesh-&gt;useSharedVertices)||(submesh-&gt;useSharedVertices &amp;&amp; !added_shared))
<a name="l01717"></a>01717         {
<a name="l01718"></a>01718             <span class="keywordflow">if</span> (submesh-&gt;useSharedVertices)
<a name="l01719"></a>01719             {
<a name="l01720"></a>01720                 added_shared = <span class="keyword">true</span>;
<a name="l01721"></a>01721                 shared_offset = current_offset;
<a name="l01722"></a>01722             }
<a name="l01723"></a>01723 
<a name="l01724"></a>01724             <span class="keyword">const</span> Ogre::VertexElement* posElem = vertex_data-&gt;vertexDeclaration-&gt;findElementBySemantic(Ogre::VES_POSITION);
<a name="l01725"></a>01725             Ogre::HardwareVertexBufferSharedPtr vbuf = vertex_data-&gt;vertexBufferBinding-&gt;getBuffer(posElem-&gt;getSource());
<a name="l01726"></a>01726             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* vertex = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*<span class="keyword">&gt;</span>(vbuf-&gt;lock(Ogre::HardwareBuffer::HBL_READ_ONLY));
<a name="l01727"></a>01727             Ogre::Real* pReal;
<a name="l01728"></a>01728 
<a name="l01729"></a>01729             <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = 0; j &lt; vertex_data-&gt;vertexCount; ++j, vertex += vbuf-&gt;getVertexSize())
<a name="l01730"></a>01730             {
<a name="l01731"></a>01731                 posElem-&gt;baseVertexPointerToElement(vertex, &amp;pReal);
<a name="l01732"></a>01732 
<a name="l01733"></a>01733                 <a class="code" href="struct_vector3.html">Vector3</a> pt;
<a name="l01734"></a>01734 
<a name="l01735"></a>01735                 pt.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a> = (*pReal++);
<a name="l01736"></a>01736                 pt.<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a> = (*pReal++);
<a name="l01737"></a>01737                 pt.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a> = (*pReal++);
<a name="l01738"></a>01738 
<a name="l01739"></a>01739                 pt = (orient * (pt * scale)) + position;
<a name="l01740"></a>01740 
<a name="l01741"></a>01741                 vertices[current_offset + j].<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a> = pt.<a class="code" href="struct_vector3.html#a7e2d3237b29a2f29d7b3d8b2934e35f2">x</a>;
<a name="l01742"></a>01742                 vertices[current_offset + j].<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a> = pt.<a class="code" href="struct_vector3.html#a86eb35a9fa2d5a49e7fad66a35fa9c13">y</a>;
<a name="l01743"></a>01743                 vertices[current_offset + j].<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a> = pt.<a class="code" href="struct_vector3.html#aa8c9461eb24bd2c364258078811a3e9d">z</a>;
<a name="l01744"></a>01744             }
<a name="l01745"></a>01745             vbuf-&gt;unlock();
<a name="l01746"></a>01746             next_offset += vertex_data-&gt;vertexCount;
<a name="l01747"></a>01747         }
<a name="l01748"></a>01748 
<a name="l01749"></a>01749         Ogre::IndexData* index_data = submesh-&gt;indexData;
<a name="l01750"></a>01750 
<a name="l01751"></a>01751         <span class="keywordtype">size_t</span> numTris = index_data-&gt;indexCount / 3;
<a name="l01752"></a>01752         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>* pShort = 0;
<a name="l01753"></a>01753         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>* pInt = 0;
<a name="l01754"></a>01754         Ogre::HardwareIndexBufferSharedPtr ibuf = index_data-&gt;indexBuffer;
<a name="l01755"></a>01755         
<a name="l01756"></a>01756         <span class="keywordtype">bool</span> use32bitindexes = (ibuf-&gt;getType() == Ogre::HardwareIndexBuffer::IT_32BIT);
<a name="l01757"></a>01757 
<a name="l01758"></a>01758         <span class="keywordflow">if</span> (use32bitindexes)
<a name="l01759"></a>01759             pInt = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(ibuf-&gt;lock(Ogre::HardwareBuffer::HBL_READ_ONLY));
<a name="l01760"></a>01760         <span class="keywordflow">else</span>
<a name="l01761"></a>01761             pShort = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>*<span class="keyword">&gt;</span>(ibuf-&gt;lock(Ogre::HardwareBuffer::HBL_READ_ONLY));
<a name="l01762"></a>01762 
<a name="l01763"></a>01763         <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> k = 0; k &lt; numTris; ++k)
<a name="l01764"></a>01764         {
<a name="l01765"></a>01765             <span class="keywordtype">size_t</span> offset = (submesh-&gt;useSharedVertices)?shared_offset:current_offset;
<a name="l01766"></a>01766 
<a name="l01767"></a>01767             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vindex = use32bitindexes? *pInt++ : *pShort++;
<a name="l01768"></a>01768             indices[index_offset + 0] = vindex + (<span class="keywordtype">unsigned</span> int)offset;
<a name="l01769"></a>01769             vindex = use32bitindexes? *pInt++ : *pShort++;
<a name="l01770"></a>01770             indices[index_offset + 1] = vindex + (<span class="keywordtype">unsigned</span> int)offset;
<a name="l01771"></a>01771             vindex = use32bitindexes? *pInt++ : *pShort++;
<a name="l01772"></a>01772             indices[index_offset + 2] = vindex + (<span class="keywordtype">unsigned</span> int)offset;
<a name="l01773"></a>01773 
<a name="l01774"></a>01774             index_offset += 3;
<a name="l01775"></a>01775         }
<a name="l01776"></a>01776         ibuf-&gt;unlock();
<a name="l01777"></a>01777         current_offset = next_offset;
<a name="l01778"></a>01778     }
<a name="l01779"></a>01779 }
<a name="l01780"></a>01780 
<a name="l01781"></a><a class="code" href="class_collisions.html#ae63812137037d5a0e4da7cfb6d3b9ed0">01781</a> <span class="keywordtype">void</span> <a class="code" href="class_collisions.html#ae63812137037d5a0e4da7cfb6d3b9ed0">Collisions::finishLoadingTerrain</a>()
<a name="l01782"></a>01782 {
<a name="l01783"></a>01783     <span class="keywordflow">if</span> (<a class="code" href="class_collisions.html#ac22cd0e0bf7bc504f7974244801cb175">debugMode</a>)
<a name="l01784"></a>01784     {
<a name="l01785"></a>01785         SceneNode *debugsn = <a class="code" href="_main_thread_8cpp.html#aa88203d48340f609e6b6c7f1471f3b8e">gEnv</a>-&gt;<a class="code" href="class_global_environment.html#af1dd98dd6dbe5353a6a0b7bd2a2e42ee">sceneManager</a>-&gt;getRootSceneNode()-&gt;createChildSceneNode();
<a name="l01786"></a>01786         <a class="code" href="class_collisions.html#a071e5015fc25d34315f5a0caf73e9a09">debugmo</a>-&gt;end();
<a name="l01787"></a>01787         debugsn-&gt;setPosition(Vector3::ZERO);
<a name="l01788"></a>01788         debugsn-&gt;attachObject(<a class="code" href="class_collisions.html#a071e5015fc25d34315f5a0caf73e9a09">debugmo</a>);
<a name="l01789"></a>01789 
<a name="l01790"></a>01790         <a class="code" href="class_collisions.html#a671f48109ee3e019d5eb10cc93ea3383">createCollisionDebugVisualization</a>();
<a name="l01791"></a>01791     }
<a name="l01792"></a>01792 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Mon Oct 12 2015 11:55:31 for Rigs of Rods by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
